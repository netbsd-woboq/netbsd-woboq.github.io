<!doctype html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0"><title>uvm_pdaemon.c source code [netbsd/sys/uvm/uvm_pdaemon.c] - Woboq Code Browser</title>
<meta name="woboq:interestingDefinitions" content="swapcluster "/>
<link rel="stylesheet" href="https://code.woboq.org/data/qtcreator.css" title="QtCreator"/>
<link rel="alternate stylesheet" href="https://code.woboq.org/data/kdevelop.css" title="KDevelop"/>
<script type="text/javascript" src="https://code.woboq.org/data/jquery/jquery.min.js"></script>
<script type="text/javascript" src="https://code.woboq.org/data/jquery/jquery-ui.min.js"></script>
<script>var file = 'netbsd/sys/uvm/uvm_pdaemon.c'; var root_path = '../../..'; var data_path = 'https://code.woboq.org/data'; var ecma_script_api_version = 2;</script>
<script src='https://code.woboq.org/data/codebrowser.js'></script>
</head>
<body><div id='header'><h1 id='breadcrumb'><span>Browse the source code of </span><a href='../..'>netbsd</a>/<a href='..'>sys</a>/<a href='./'>uvm</a>/<a href='uvm_pdaemon.c.html'>uvm_pdaemon.c</a></h1></div>
<hr/><div id='content'><table class="code">
<tr><th id="1">1</th><td><i>/*	$NetBSD: uvm_pdaemon.c,v 1.110 2019/04/21 15:32:18 chs Exp $	*/</i></td></tr>
<tr><th id="2">2</th><td></td></tr>
<tr><th id="3">3</th><td><i>/*</i></td></tr>
<tr><th id="4">4</th><td><i> * Copyright (c) 1997 Charles D. Cranor and Washington University.</i></td></tr>
<tr><th id="5">5</th><td><i> * Copyright (c) 1991, 1993, The Regents of the University of California.</i></td></tr>
<tr><th id="6">6</th><td><i> *</i></td></tr>
<tr><th id="7">7</th><td><i> * All rights reserved.</i></td></tr>
<tr><th id="8">8</th><td><i> *</i></td></tr>
<tr><th id="9">9</th><td><i> * This code is derived from software contributed to Berkeley by</i></td></tr>
<tr><th id="10">10</th><td><i> * The Mach Operating System project at Carnegie-Mellon University.</i></td></tr>
<tr><th id="11">11</th><td><i> *</i></td></tr>
<tr><th id="12">12</th><td><i> * Redistribution and use in source and binary forms, with or without</i></td></tr>
<tr><th id="13">13</th><td><i> * modification, are permitted provided that the following conditions</i></td></tr>
<tr><th id="14">14</th><td><i> * are met:</i></td></tr>
<tr><th id="15">15</th><td><i> * 1. Redistributions of source code must retain the above copyright</i></td></tr>
<tr><th id="16">16</th><td><i> *    notice, this list of conditions and the following disclaimer.</i></td></tr>
<tr><th id="17">17</th><td><i> * 2. Redistributions in binary form must reproduce the above copyright</i></td></tr>
<tr><th id="18">18</th><td><i> *    notice, this list of conditions and the following disclaimer in the</i></td></tr>
<tr><th id="19">19</th><td><i> *    documentation and/or other materials provided with the distribution.</i></td></tr>
<tr><th id="20">20</th><td><i> * 3. Neither the name of the University nor the names of its contributors</i></td></tr>
<tr><th id="21">21</th><td><i> *    may be used to endorse or promote products derived from this software</i></td></tr>
<tr><th id="22">22</th><td><i> *    without specific prior written permission.</i></td></tr>
<tr><th id="23">23</th><td><i> *</i></td></tr>
<tr><th id="24">24</th><td><i> * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND</i></td></tr>
<tr><th id="25">25</th><td><i> * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</i></td></tr>
<tr><th id="26">26</th><td><i> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</i></td></tr>
<tr><th id="27">27</th><td><i> * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE</i></td></tr>
<tr><th id="28">28</th><td><i> * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</i></td></tr>
<tr><th id="29">29</th><td><i> * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS</i></td></tr>
<tr><th id="30">30</th><td><i> * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)</i></td></tr>
<tr><th id="31">31</th><td><i> * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</i></td></tr>
<tr><th id="32">32</th><td><i> * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</i></td></tr>
<tr><th id="33">33</th><td><i> * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</i></td></tr>
<tr><th id="34">34</th><td><i> * SUCH DAMAGE.</i></td></tr>
<tr><th id="35">35</th><td><i> *</i></td></tr>
<tr><th id="36">36</th><td><i> *	@(#)vm_pageout.c        8.5 (Berkeley) 2/14/94</i></td></tr>
<tr><th id="37">37</th><td><i> * from: Id: uvm_pdaemon.c,v 1.1.2.32 1998/02/06 05:26:30 chs Exp</i></td></tr>
<tr><th id="38">38</th><td><i> *</i></td></tr>
<tr><th id="39">39</th><td><i> *</i></td></tr>
<tr><th id="40">40</th><td><i> * Copyright (c) 1987, 1990 Carnegie-Mellon University.</i></td></tr>
<tr><th id="41">41</th><td><i> * All rights reserved.</i></td></tr>
<tr><th id="42">42</th><td><i> *</i></td></tr>
<tr><th id="43">43</th><td><i> * Permission to use, copy, modify and distribute this software and</i></td></tr>
<tr><th id="44">44</th><td><i> * its documentation is hereby granted, provided that both the copyright</i></td></tr>
<tr><th id="45">45</th><td><i> * notice and this permission notice appear in all copies of the</i></td></tr>
<tr><th id="46">46</th><td><i> * software, derivative works or modified versions, and any portions</i></td></tr>
<tr><th id="47">47</th><td><i> * thereof, and that both notices appear in supporting documentation.</i></td></tr>
<tr><th id="48">48</th><td><i> *</i></td></tr>
<tr><th id="49">49</th><td><i> * CARNEGIE MELLON ALLOWS FREE USE OF THIS SOFTWARE IN ITS "AS IS"</i></td></tr>
<tr><th id="50">50</th><td><i> * CONDITION.  CARNEGIE MELLON DISCLAIMS ANY LIABILITY OF ANY KIND</i></td></tr>
<tr><th id="51">51</th><td><i> * FOR ANY DAMAGES WHATSOEVER RESULTING FROM THE USE OF THIS SOFTWARE.</i></td></tr>
<tr><th id="52">52</th><td><i> *</i></td></tr>
<tr><th id="53">53</th><td><i> * Carnegie Mellon requests users of this software to return to</i></td></tr>
<tr><th id="54">54</th><td><i> *</i></td></tr>
<tr><th id="55">55</th><td><i> *  Software Distribution Coordinator  or  Software.Distribution@CS.CMU.EDU</i></td></tr>
<tr><th id="56">56</th><td><i> *  School of Computer Science</i></td></tr>
<tr><th id="57">57</th><td><i> *  Carnegie Mellon University</i></td></tr>
<tr><th id="58">58</th><td><i> *  Pittsburgh PA 15213-3890</i></td></tr>
<tr><th id="59">59</th><td><i> *</i></td></tr>
<tr><th id="60">60</th><td><i> * any improvements or extensions that they make and grant Carnegie the</i></td></tr>
<tr><th id="61">61</th><td><i> * rights to redistribute these changes.</i></td></tr>
<tr><th id="62">62</th><td><i> */</i></td></tr>
<tr><th id="63">63</th><td></td></tr>
<tr><th id="64">64</th><td><i>/*</i></td></tr>
<tr><th id="65">65</th><td><i> * uvm_pdaemon.c: the page daemon</i></td></tr>
<tr><th id="66">66</th><td><i> */</i></td></tr>
<tr><th id="67">67</th><td></td></tr>
<tr><th id="68">68</th><td><u>#include <a href="../sys/cdefs.h.html">&lt;sys/cdefs.h&gt;</a></u></td></tr>
<tr><th id="69">69</th><td><a class="macro" href="../sys/cdefs_elf.h.html#156" title="__asm(&quot;.pushsection &quot; &quot;.ident&quot; &quot;\n&quot; &quot;.asciz \&quot;&quot; &quot;$NetBSD: uvm_pdaemon.c,v 1.110 2019/04/21 15:32:18 chs Exp $&quot; &quot;\&quot;\n&quot; &quot;.popsection&quot;)" data-ref="_M/__KERNEL_RCSID">__KERNEL_RCSID</a>(<var>0</var>, <q>"$NetBSD: uvm_pdaemon.c,v 1.110 2019/04/21 15:32:18 chs Exp $"</q>);</td></tr>
<tr><th id="70">70</th><td></td></tr>
<tr><th id="71">71</th><td><u>#include <a href="../../objdir.amd64/sys/arch/amd64/compile/GENERIC/opt_uvmhist.h.html">"opt_uvmhist.h"</a></u></td></tr>
<tr><th id="72">72</th><td><u>#include <a href="../../objdir.amd64/sys/arch/amd64/compile/GENERIC/opt_readahead.h.html">"opt_readahead.h"</a></u></td></tr>
<tr><th id="73">73</th><td></td></tr>
<tr><th id="74">74</th><td><u>#include <a href="../sys/param.h.html">&lt;sys/param.h&gt;</a></u></td></tr>
<tr><th id="75">75</th><td><u>#include <a href="../sys/proc.h.html">&lt;sys/proc.h&gt;</a></u></td></tr>
<tr><th id="76">76</th><td><u>#include <a href="../sys/systm.h.html">&lt;sys/systm.h&gt;</a></u></td></tr>
<tr><th id="77">77</th><td><u>#include <a href="../sys/kernel.h.html">&lt;sys/kernel.h&gt;</a></u></td></tr>
<tr><th id="78">78</th><td><u>#include <a href="../sys/pool.h.html">&lt;sys/pool.h&gt;</a></u></td></tr>
<tr><th id="79">79</th><td><u>#include <a href="../sys/buf.h.html">&lt;sys/buf.h&gt;</a></u></td></tr>
<tr><th id="80">80</th><td><u>#include <a href="../sys/module.h.html">&lt;sys/module.h&gt;</a></u></td></tr>
<tr><th id="81">81</th><td><u>#include <a href="../sys/atomic.h.html">&lt;sys/atomic.h&gt;</a></u></td></tr>
<tr><th id="82">82</th><td><u>#include <a href="../sys/kthread.h.html">&lt;sys/kthread.h&gt;</a></u></td></tr>
<tr><th id="83">83</th><td></td></tr>
<tr><th id="84">84</th><td><u>#include <a href="uvm.h.html">&lt;uvm/uvm.h&gt;</a></u></td></tr>
<tr><th id="85">85</th><td><u>#include <a href="uvm_pdpolicy.h.html">&lt;uvm/uvm_pdpolicy.h&gt;</a></u></td></tr>
<tr><th id="86">86</th><td></td></tr>
<tr><th id="87">87</th><td><u>#<span data-ppcond="87">ifdef</span> <span class="macro" data-ref="_M/UVMHIST">UVMHIST</span></u></td></tr>
<tr><th id="88">88</th><td>UVMHIST_DEFINE(pdhist);</td></tr>
<tr><th id="89">89</th><td><u>#<span data-ppcond="87">endif</span></u></td></tr>
<tr><th id="90">90</th><td></td></tr>
<tr><th id="91">91</th><td><i>/*</i></td></tr>
<tr><th id="92">92</th><td><i> * UVMPD_NUMDIRTYREACTS is how many dirty pages the pagedaemon will reactivate</i></td></tr>
<tr><th id="93">93</th><td><i> * in a pass thru the inactive list when swap is full.  the value should be</i></td></tr>
<tr><th id="94">94</th><td><i> * "small"... if it's too large we'll cycle the active pages thru the inactive</i></td></tr>
<tr><th id="95">95</th><td><i> * queue too quickly to for them to be referenced and avoid being freed.</i></td></tr>
<tr><th id="96">96</th><td><i> */</i></td></tr>
<tr><th id="97">97</th><td></td></tr>
<tr><th id="98">98</th><td><u>#define	<dfn class="macro" id="_M/UVMPD_NUMDIRTYREACTS" data-ref="_M/UVMPD_NUMDIRTYREACTS">UVMPD_NUMDIRTYREACTS</dfn>	16</u></td></tr>
<tr><th id="99">99</th><td></td></tr>
<tr><th id="100">100</th><td><u>#define	<dfn class="macro" id="_M/UVMPD_NUMTRYLOCKOWNER" data-ref="_M/UVMPD_NUMTRYLOCKOWNER">UVMPD_NUMTRYLOCKOWNER</dfn>	16</u></td></tr>
<tr><th id="101">101</th><td></td></tr>
<tr><th id="102">102</th><td><i  data-doc="uvmpd_scan">/*</i></td></tr>
<tr><th id="103">103</th><td><i  data-doc="uvmpd_scan"> * local prototypes</i></td></tr>
<tr><th id="104">104</th><td><i  data-doc="uvmpd_scan"> */</i></td></tr>
<tr><th id="105">105</th><td></td></tr>
<tr><th id="106">106</th><td><em>static</em> <em>void</em>	<a class="tu decl fn" href="#uvmpd_scan" title='uvmpd_scan' data-type='void uvmpd_scan()' data-ref="uvmpd_scan" data-ref-filename="uvmpd_scan">uvmpd_scan</a>(<em>void</em>);</td></tr>
<tr><th id="107">107</th><td><em>static</em> <em>void</em>	<a class="tu decl fn" href="#uvmpd_scan_queue" title='uvmpd_scan_queue' data-type='void uvmpd_scan_queue()' data-ref="uvmpd_scan_queue" data-ref-filename="uvmpd_scan_queue">uvmpd_scan_queue</a>(<em>void</em>);</td></tr>
<tr><th id="108">108</th><td><em>static</em> <em>void</em>	<a class="tu decl fn" href="#uvmpd_tune" title='uvmpd_tune' data-type='void uvmpd_tune()' data-ref="uvmpd_tune" data-ref-filename="uvmpd_tune">uvmpd_tune</a>(<em>void</em>);</td></tr>
<tr><th id="109">109</th><td><em>static</em> <em>void</em>	<a class="tu decl fn" href="#uvmpd_pool_drain_thread" title='uvmpd_pool_drain_thread' data-type='void uvmpd_pool_drain_thread(void * )' data-ref="uvmpd_pool_drain_thread" data-ref-filename="uvmpd_pool_drain_thread">uvmpd_pool_drain_thread</a>(<em>void</em> *);</td></tr>
<tr><th id="110">110</th><td><em>static</em> <em>void</em>	<a class="tu decl fn" href="#uvmpd_pool_drain_wakeup" title='uvmpd_pool_drain_wakeup' data-type='void uvmpd_pool_drain_wakeup()' data-ref="uvmpd_pool_drain_wakeup" data-ref-filename="uvmpd_pool_drain_wakeup">uvmpd_pool_drain_wakeup</a>(<em>void</em>);</td></tr>
<tr><th id="111">111</th><td></td></tr>
<tr><th id="112">112</th><td><em>static</em> <em>unsigned</em> <em>int</em> <dfn class="tu decl def" id="uvm_pagedaemon_waiters" title='uvm_pagedaemon_waiters' data-type='unsigned int' data-ref="uvm_pagedaemon_waiters" data-ref-filename="uvm_pagedaemon_waiters">uvm_pagedaemon_waiters</dfn>;</td></tr>
<tr><th id="113">113</th><td></td></tr>
<tr><th id="114">114</th><td><i  data-doc="uvmpd_pool_drain_lock">/* State for the pool drainer thread */</i></td></tr>
<tr><th id="115">115</th><td><em>static</em> <a class="typedef" href="../sys/mutex.h.html#kmutex_t" title='kmutex_t' data-type='struct kmutex' data-ref="kmutex_t" data-ref-filename="kmutex_t">kmutex_t</a> <dfn class="tu decl def" id="uvmpd_pool_drain_lock" title='uvmpd_pool_drain_lock' data-type='kmutex_t' data-ref="uvmpd_pool_drain_lock" data-ref-filename="uvmpd_pool_drain_lock">uvmpd_pool_drain_lock</dfn>;</td></tr>
<tr><th id="116">116</th><td><em>static</em> <a class="typedef" href="../sys/condvar.h.html#kcondvar_t" title='kcondvar_t' data-type='struct kcondvar' data-ref="kcondvar_t" data-ref-filename="kcondvar_t">kcondvar_t</a> <dfn class="tu decl def" id="uvmpd_pool_drain_cv" title='uvmpd_pool_drain_cv' data-type='kcondvar_t' data-ref="uvmpd_pool_drain_cv" data-ref-filename="uvmpd_pool_drain_cv">uvmpd_pool_drain_cv</dfn>;</td></tr>
<tr><th id="117">117</th><td><em>static</em> <a class="macro" href="../sys/stdbool.h.html#37" title="_Bool" data-ref="_M/bool">bool</a> <dfn class="tu decl def" id="uvmpd_pool_drain_run" title='uvmpd_pool_drain_run' data-type='_Bool' data-ref="uvmpd_pool_drain_run" data-ref-filename="uvmpd_pool_drain_run">uvmpd_pool_drain_run</dfn> = <a class="macro" href="../sys/stdbool.h.html#40" title="0" data-ref="_M/false">false</a>;</td></tr>
<tr><th id="118">118</th><td></td></tr>
<tr><th id="119">119</th><td><i>/*</i></td></tr>
<tr><th id="120">120</th><td><i> * XXX hack to avoid hangs when large processes fork.</i></td></tr>
<tr><th id="121">121</th><td><i> */</i></td></tr>
<tr><th id="122">122</th><td><a class="typedef" href="../sys/types.h.html#u_int" title='u_int' data-type='unsigned int' data-ref="u_int" data-ref-filename="u_int">u_int</a> <dfn class="decl def" id="uvm_extrapages" title='uvm_extrapages' data-ref="uvm_extrapages" data-ref-filename="uvm_extrapages">uvm_extrapages</dfn>;</td></tr>
<tr><th id="123">123</th><td></td></tr>
<tr><th id="124">124</th><td><i>/*</i></td></tr>
<tr><th id="125">125</th><td><i> * uvm_wait: wait (sleep) for the page daemon to free some pages</i></td></tr>
<tr><th id="126">126</th><td><i> *</i></td></tr>
<tr><th id="127">127</th><td><i> * =&gt; should be called with all locks released</i></td></tr>
<tr><th id="128">128</th><td><i> * =&gt; should _not_ be called by the page daemon (to avoid deadlock)</i></td></tr>
<tr><th id="129">129</th><td><i> */</i></td></tr>
<tr><th id="130">130</th><td></td></tr>
<tr><th id="131">131</th><td><em>void</em></td></tr>
<tr><th id="132">132</th><td><dfn class="decl def fn" id="uvm_wait" title='uvm_wait' data-ref="uvm_wait" data-ref-filename="uvm_wait">uvm_wait</dfn>(<em>const</em> <em>char</em> *<dfn class="local col1 decl" id="1wmsg" title='wmsg' data-type='const char *' data-ref="1wmsg" data-ref-filename="1wmsg">wmsg</dfn>)</td></tr>
<tr><th id="133">133</th><td>{</td></tr>
<tr><th id="134">134</th><td>	<em>int</em> <dfn class="local col2 decl" id="2timo" title='timo' data-type='int' data-ref="2timo" data-ref-filename="2timo">timo</dfn> = <var>0</var>;</td></tr>
<tr><th id="135">135</th><td></td></tr>
<tr><th id="136">136</th><td>	<a class="ref fn" href="../sys/mutex.h.html#mutex_spin_enter" title='mutex_spin_enter' data-ref="mutex_spin_enter" data-ref-filename="mutex_spin_enter">mutex_spin_enter</a>(&amp;<a class="ref" href="uvm.h.html#uvm_fpageqlock" title='uvm_fpageqlock' data-ref="uvm_fpageqlock" data-ref-filename="uvm_fpageqlock">uvm_fpageqlock</a>);</td></tr>
<tr><th id="137">137</th><td></td></tr>
<tr><th id="138">138</th><td>	<i>/*</i></td></tr>
<tr><th id="139">139</th><td><i>	 * check for page daemon going to sleep (waiting for itself)</i></td></tr>
<tr><th id="140">140</th><td><i>	 */</i></td></tr>
<tr><th id="141">141</th><td></td></tr>
<tr><th id="142">142</th><td>	<b>if</b> (<a class="macro" href="../arch/x86/include/cpu.h.html#405" title="x86_curlwp()" data-ref="_M/curlwp">curlwp</a> == <a class="ref" href="uvm.h.html#uvm" title='uvm' data-ref="uvm" data-ref-filename="uvm">uvm</a>.<a class="ref field" href="uvm.h.html#uvm::pagedaemon_lwp" title='uvm::pagedaemon_lwp' data-ref="uvm::pagedaemon_lwp" data-ref-filename="uvm..pagedaemon_lwp">pagedaemon_lwp</a> &amp;&amp; <a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::paging" title='uvmexp::paging' data-ref="uvmexp::paging" data-ref-filename="uvmexp..paging">paging</a> == <var>0</var>) {</td></tr>
<tr><th id="143">143</th><td>		<i>/*</i></td></tr>
<tr><th id="144">144</th><td><i>		 * now we have a problem: the pagedaemon wants to go to</i></td></tr>
<tr><th id="145">145</th><td><i>		 * sleep until it frees more memory.   but how can it</i></td></tr>
<tr><th id="146">146</th><td><i>		 * free more memory if it is asleep?  that is a deadlock.</i></td></tr>
<tr><th id="147">147</th><td><i>		 * we have two options:</i></td></tr>
<tr><th id="148">148</th><td><i>		 *  [1] panic now</i></td></tr>
<tr><th id="149">149</th><td><i>		 *  [2] put a timeout on the sleep, thus causing the</i></td></tr>
<tr><th id="150">150</th><td><i>		 *      pagedaemon to only pause (rather than sleep forever)</i></td></tr>
<tr><th id="151">151</th><td><i>		 *</i></td></tr>
<tr><th id="152">152</th><td><i>		 * note that option [2] will only help us if we get lucky</i></td></tr>
<tr><th id="153">153</th><td><i>		 * and some other process on the system breaks the deadlock</i></td></tr>
<tr><th id="154">154</th><td><i>		 * by exiting or freeing memory (thus allowing the pagedaemon</i></td></tr>
<tr><th id="155">155</th><td><i>		 * to continue).  for now we panic if DEBUG is defined,</i></td></tr>
<tr><th id="156">156</th><td><i>		 * otherwise we hope for the best with option [2] (better</i></td></tr>
<tr><th id="157">157</th><td><i>		 * yet, this should never happen in the first place!).</i></td></tr>
<tr><th id="158">158</th><td><i>		 */</i></td></tr>
<tr><th id="159">159</th><td></td></tr>
<tr><th id="160">160</th><td>		<a class="ref fn" href="../sys/systm.h.html#printf" title='printf' data-ref="printf" data-ref-filename="printf">printf</a>(<q>"pagedaemon: deadlock detected!\n"</q>);</td></tr>
<tr><th id="161">161</th><td>		<a class="local col2 ref" href="#2timo" title='timo' data-ref="2timo" data-ref-filename="2timo">timo</a> = <a class="ref" href="../sys/kernel.h.html#hz" title='hz' data-ref="hz" data-ref-filename="hz">hz</a> &gt;&gt; <var>3</var>;		<i>/* set timeout */</i></td></tr>
<tr><th id="162">162</th><td><u>#<span data-ppcond="162">if</span> defined(<span class="macro" data-ref="_M/DEBUG">DEBUG</span>)</u></td></tr>
<tr><th id="163">163</th><td>		<i>/* DEBUG: panic so we can debug it */</i></td></tr>
<tr><th id="164">164</th><td>		panic(<q>"pagedaemon deadlock"</q>);</td></tr>
<tr><th id="165">165</th><td><u>#<span data-ppcond="162">endif</span></u></td></tr>
<tr><th id="166">166</th><td>	}</td></tr>
<tr><th id="167">167</th><td></td></tr>
<tr><th id="168">168</th><td>	<a class="tu ref" href="#uvm_pagedaemon_waiters" title='uvm_pagedaemon_waiters' data-use='w' data-ref="uvm_pagedaemon_waiters" data-ref-filename="uvm_pagedaemon_waiters">uvm_pagedaemon_waiters</a>++;</td></tr>
<tr><th id="169">169</th><td>	<a class="ref fn" href="../sys/proc.h.html#wakeup" title='wakeup' data-ref="wakeup" data-ref-filename="wakeup">wakeup</a>(&amp;<a class="ref" href="uvm.h.html#uvm" title='uvm' data-ref="uvm" data-ref-filename="uvm">uvm</a>.<a class="ref field" href="uvm.h.html#uvm::pagedaemon" title='uvm::pagedaemon' data-ref="uvm::pagedaemon" data-ref-filename="uvm..pagedaemon">pagedaemon</a>);		<i>/* wake the daemon! */</i></td></tr>
<tr><th id="170">170</th><td>	<a class="macro" href="uvm.h.html#174" title="do { (void) mtsleep(&amp;uvmexp.free, 4 | 0x200 | (0 ? 0x100 : 0), wmsg, timo, &amp;uvm_fpageqlock); } while ( 0)" data-ref="_M/UVM_UNLOCK_AND_WAIT">UVM_UNLOCK_AND_WAIT</a>(&amp;<a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::free" title='uvmexp::free' data-ref="uvmexp::free" data-ref-filename="uvmexp..free">free</a>, &amp;<a class="ref" href="uvm.h.html#uvm_fpageqlock" title='uvm_fpageqlock' data-ref="uvm_fpageqlock" data-ref-filename="uvm_fpageqlock">uvm_fpageqlock</a>, <a class="macro" href="../sys/stdbool.h.html#40" title="0" data-ref="_M/false">false</a>, <a class="local col1 ref" href="#1wmsg" title='wmsg' data-ref="1wmsg" data-ref-filename="1wmsg">wmsg</a>, <a class="local col2 ref" href="#2timo" title='timo' data-ref="2timo" data-ref-filename="2timo">timo</a>);</td></tr>
<tr><th id="171">171</th><td>}</td></tr>
<tr><th id="172">172</th><td></td></tr>
<tr><th id="173">173</th><td><i>/*</i></td></tr>
<tr><th id="174">174</th><td><i> * uvm_kick_pdaemon: perform checks to determine if we need to</i></td></tr>
<tr><th id="175">175</th><td><i> * give the pagedaemon a nudge, and do so if necessary.</i></td></tr>
<tr><th id="176">176</th><td><i> *</i></td></tr>
<tr><th id="177">177</th><td><i> * =&gt; called with uvm_fpageqlock held.</i></td></tr>
<tr><th id="178">178</th><td><i> */</i></td></tr>
<tr><th id="179">179</th><td></td></tr>
<tr><th id="180">180</th><td><em>void</em></td></tr>
<tr><th id="181">181</th><td><dfn class="decl def fn" id="uvm_kick_pdaemon" title='uvm_kick_pdaemon' data-ref="uvm_kick_pdaemon" data-ref-filename="uvm_kick_pdaemon">uvm_kick_pdaemon</dfn>(<em>void</em>)</td></tr>
<tr><th id="182">182</th><td>{</td></tr>
<tr><th id="183">183</th><td></td></tr>
<tr><th id="184">184</th><td>	<a class="macro" href="../lib/libkern/libkern.h.html#279" title="(__builtin_expect(((mutex_owned(&amp;uvm_fpageqlock))) != 0, 1) ? (void)0 : kern_assert(&quot;kernel %sassertion \&quot;%s\&quot; failed: file \&quot;%s\&quot;, line %d &quot;, &quot;diagnostic &quot;, &quot;mutex_owned(&amp;uvm_fpageqlock)&quot;, &quot;/___NETBSD_SRC___/objdir.amd64/sys/arch/amd64/compile/GENERIC/../../../../../../sys/uvm/uvm_pdaemon.c&quot;, 184))" data-ref="_M/KASSERT">KASSERT</a>(<a class="ref fn" href="../sys/mutex.h.html#mutex_owned" title='mutex_owned' data-ref="mutex_owned" data-ref-filename="mutex_owned">mutex_owned</a>(&amp;<a class="ref" href="uvm.h.html#uvm_fpageqlock" title='uvm_fpageqlock' data-ref="uvm_fpageqlock" data-ref-filename="uvm_fpageqlock">uvm_fpageqlock</a>));</td></tr>
<tr><th id="185">185</th><td></td></tr>
<tr><th id="186">186</th><td>	<b>if</b> (<a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::free" title='uvmexp::free' data-ref="uvmexp::free" data-ref-filename="uvmexp..free">free</a> + <a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::paging" title='uvmexp::paging' data-ref="uvmexp::paging" data-ref-filename="uvmexp..paging">paging</a> &lt; <a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::freemin" title='uvmexp::freemin' data-ref="uvmexp::freemin" data-ref-filename="uvmexp..freemin">freemin</a> ||</td></tr>
<tr><th id="187">187</th><td>	    (<a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::free" title='uvmexp::free' data-ref="uvmexp::free" data-ref-filename="uvmexp..free">free</a> + <a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::paging" title='uvmexp::paging' data-ref="uvmexp::paging" data-ref-filename="uvmexp..paging">paging</a> &lt; <a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::freetarg" title='uvmexp::freetarg' data-ref="uvmexp::freetarg" data-ref-filename="uvmexp..freetarg">freetarg</a> &amp;&amp;</td></tr>
<tr><th id="188">188</th><td>	     <a class="ref fn" href="uvm_pdpolicy.h.html#uvmpdpol_needsscan_p" title='uvmpdpol_needsscan_p' data-ref="uvmpdpol_needsscan_p" data-ref-filename="uvmpdpol_needsscan_p">uvmpdpol_needsscan_p</a>()) ||</td></tr>
<tr><th id="189">189</th><td>	     <a class="ref fn" href="uvm_extern.h.html#uvm_km_va_starved_p" title='uvm_km_va_starved_p' data-ref="uvm_km_va_starved_p" data-ref-filename="uvm_km_va_starved_p">uvm_km_va_starved_p</a>()) {</td></tr>
<tr><th id="190">190</th><td>		<a class="ref fn" href="../sys/proc.h.html#wakeup" title='wakeup' data-ref="wakeup" data-ref-filename="wakeup">wakeup</a>(&amp;<a class="ref" href="uvm.h.html#uvm" title='uvm' data-ref="uvm" data-ref-filename="uvm">uvm</a>.<a class="ref field" href="uvm.h.html#uvm::pagedaemon" title='uvm::pagedaemon' data-ref="uvm::pagedaemon" data-ref-filename="uvm..pagedaemon">pagedaemon</a>);</td></tr>
<tr><th id="191">191</th><td>	}</td></tr>
<tr><th id="192">192</th><td>}</td></tr>
<tr><th id="193">193</th><td></td></tr>
<tr><th id="194">194</th><td><i  data-doc="uvmpd_tune">/*</i></td></tr>
<tr><th id="195">195</th><td><i  data-doc="uvmpd_tune"> * uvmpd_tune: tune paging parameters</i></td></tr>
<tr><th id="196">196</th><td><i  data-doc="uvmpd_tune"> *</i></td></tr>
<tr><th id="197">197</th><td><i  data-doc="uvmpd_tune"> * =&gt; called when ever memory is added (or removed?) to the system</i></td></tr>
<tr><th id="198">198</th><td><i  data-doc="uvmpd_tune"> * =&gt; caller must call with page queues locked</i></td></tr>
<tr><th id="199">199</th><td><i  data-doc="uvmpd_tune"> */</i></td></tr>
<tr><th id="200">200</th><td></td></tr>
<tr><th id="201">201</th><td><em>static</em> <em>void</em></td></tr>
<tr><th id="202">202</th><td><dfn class="tu decl def fn" id="uvmpd_tune" title='uvmpd_tune' data-type='void uvmpd_tune()' data-ref="uvmpd_tune" data-ref-filename="uvmpd_tune">uvmpd_tune</dfn>(<em>void</em>)</td></tr>
<tr><th id="203">203</th><td>{</td></tr>
<tr><th id="204">204</th><td>	<em>int</em> <dfn class="local col3 decl" id="3val" title='val' data-type='int' data-ref="3val" data-ref-filename="3val">val</dfn>;</td></tr>
<tr><th id="205">205</th><td></td></tr>
<tr><th id="206">206</th><td>	<a class="macro" href="uvm_stat.h.html#74" title="" data-ref="_M/UVMHIST_FUNC">UVMHIST_FUNC</a>(<q>"uvmpd_tune"</q>); <a class="macro" href="uvm_stat.h.html#73" title="" data-ref="_M/UVMHIST_CALLED">UVMHIST_CALLED</a>(pdhist);</td></tr>
<tr><th id="207">207</th><td></td></tr>
<tr><th id="208">208</th><td>	<i>/*</i></td></tr>
<tr><th id="209">209</th><td><i>	 * try to keep 0.5% of available RAM free, but limit to between</i></td></tr>
<tr><th id="210">210</th><td><i>	 * 128k and 1024k per-CPU.  XXX: what are these values good for?</i></td></tr>
<tr><th id="211">211</th><td><i>	 */</i></td></tr>
<tr><th id="212">212</th><td>	<a class="local col3 ref" href="#3val" title='val' data-ref="3val" data-ref-filename="3val">val</a> = <a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::npages" title='uvmexp::npages' data-ref="uvmexp::npages" data-ref-filename="uvmexp..npages">npages</a> / <var>200</var>;</td></tr>
<tr><th id="213">213</th><td>	<a class="local col3 ref" href="#3val" title='val' data-ref="3val" data-ref-filename="3val">val</a> = <a class="macro" href="../sys/param.h.html#139" title="(( (val)&gt;((128*1024) &gt;&gt; 12))?(val):((128*1024) &gt;&gt; 12))" data-ref="_M/MAX">MAX</a>(<a class="local col3 ref" href="#3val" title='val' data-ref="3val" data-ref-filename="3val">val</a>, (<var>128</var>*<var>1024</var>) &gt;&gt; <a class="macro" href="../arch/amd64/include/vmparam.h.html#55" title="12" data-ref="_M/PAGE_SHIFT">PAGE_SHIFT</a>);</td></tr>
<tr><th id="214">214</th><td>	<a class="local col3 ref" href="#3val" title='val' data-ref="3val" data-ref-filename="3val">val</a> = <a class="macro" href="../sys/param.h.html#138" title="(( (val)&lt;((1024*1024) &gt;&gt; 12))?(val):((1024*1024) &gt;&gt; 12))" data-ref="_M/MIN">MIN</a>(<a class="local col3 ref" href="#3val" title='val' data-ref="3val" data-ref-filename="3val">val</a>, (<var>1024</var>*<var>1024</var>) &gt;&gt; <a class="macro" href="../arch/amd64/include/vmparam.h.html#55" title="12" data-ref="_M/PAGE_SHIFT">PAGE_SHIFT</a>);</td></tr>
<tr><th id="215">215</th><td>	<a class="local col3 ref" href="#3val" title='val' data-ref="3val" data-ref-filename="3val">val</a> *= <a class="ref" href="../sys/systm.h.html#ncpu" title='ncpu' data-ref="ncpu" data-ref-filename="ncpu">ncpu</a>;</td></tr>
<tr><th id="216">216</th><td></td></tr>
<tr><th id="217">217</th><td>	<i>/* Make sure there's always a user page free. */</i></td></tr>
<tr><th id="218">218</th><td>	<b>if</b> (<a class="local col3 ref" href="#3val" title='val' data-ref="3val" data-ref-filename="3val">val</a> &lt; <a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::reserve_kernel" title='uvmexp::reserve_kernel' data-ref="uvmexp::reserve_kernel" data-ref-filename="uvmexp..reserve_kernel">reserve_kernel</a> + <var>1</var>)</td></tr>
<tr><th id="219">219</th><td>		<a class="local col3 ref" href="#3val" title='val' data-ref="3val" data-ref-filename="3val">val</a> = <a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::reserve_kernel" title='uvmexp::reserve_kernel' data-ref="uvmexp::reserve_kernel" data-ref-filename="uvmexp..reserve_kernel">reserve_kernel</a> + <var>1</var>;</td></tr>
<tr><th id="220">220</th><td>	<a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::freemin" title='uvmexp::freemin' data-ref="uvmexp::freemin" data-ref-filename="uvmexp..freemin">freemin</a> = <a class="local col3 ref" href="#3val" title='val' data-ref="3val" data-ref-filename="3val">val</a>;</td></tr>
<tr><th id="221">221</th><td></td></tr>
<tr><th id="222">222</th><td>	<i>/* Calculate free target. */</i></td></tr>
<tr><th id="223">223</th><td>	<a class="local col3 ref" href="#3val" title='val' data-ref="3val" data-ref-filename="3val">val</a> = (<a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::freemin" title='uvmexp::freemin' data-ref="uvmexp::freemin" data-ref-filename="uvmexp..freemin">freemin</a> * <var>4</var>) / <var>3</var>;</td></tr>
<tr><th id="224">224</th><td>	<b>if</b> (<a class="local col3 ref" href="#3val" title='val' data-ref="3val" data-ref-filename="3val">val</a> &lt;= <a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::freemin" title='uvmexp::freemin' data-ref="uvmexp::freemin" data-ref-filename="uvmexp..freemin">freemin</a>)</td></tr>
<tr><th id="225">225</th><td>		<a class="local col3 ref" href="#3val" title='val' data-ref="3val" data-ref-filename="3val">val</a> = <a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::freemin" title='uvmexp::freemin' data-ref="uvmexp::freemin" data-ref-filename="uvmexp..freemin">freemin</a> + <var>1</var>;</td></tr>
<tr><th id="226">226</th><td>	<a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::freetarg" title='uvmexp::freetarg' data-ref="uvmexp::freetarg" data-ref-filename="uvmexp..freetarg">freetarg</a> = <a class="local col3 ref" href="#3val" title='val' data-ref="3val" data-ref-filename="3val">val</a> + <a class="ref fn" href="../sys/atomic.h.html#atomic_swap_uint" title='atomic_swap_uint' data-ref="atomic_swap_uint" data-ref-filename="atomic_swap_uint">atomic_swap_uint</a>(&amp;<a class="ref" href="#uvm_extrapages" title='uvm_extrapages' data-ref="uvm_extrapages" data-ref-filename="uvm_extrapages">uvm_extrapages</a>, <var>0</var>);</td></tr>
<tr><th id="227">227</th><td></td></tr>
<tr><th id="228">228</th><td>	<a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::wiredmax" title='uvmexp::wiredmax' data-ref="uvmexp::wiredmax" data-ref-filename="uvmexp..wiredmax">wiredmax</a> = <a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::npages" title='uvmexp::npages' data-ref="uvmexp::npages" data-ref-filename="uvmexp..npages">npages</a> / <var>3</var>;</td></tr>
<tr><th id="229">229</th><td>	<a class="macro" href="uvm_stat.h.html#72" title="" data-ref="_M/UVMHIST_LOG">UVMHIST_LOG</a>(pdhist, <q>"&lt;- done, freemin=%jd, freetarg=%jd, wiredmax=%jd"</q>,</td></tr>
<tr><th id="230">230</th><td>	      uvmexp.freemin, uvmexp.freetarg, uvmexp.wiredmax, <var>0</var>);</td></tr>
<tr><th id="231">231</th><td>}</td></tr>
<tr><th id="232">232</th><td></td></tr>
<tr><th id="233">233</th><td><i>/*</i></td></tr>
<tr><th id="234">234</th><td><i> * uvm_pageout: the main loop for the pagedaemon</i></td></tr>
<tr><th id="235">235</th><td><i> */</i></td></tr>
<tr><th id="236">236</th><td></td></tr>
<tr><th id="237">237</th><td><em>void</em></td></tr>
<tr><th id="238">238</th><td><dfn class="decl def fn" id="uvm_pageout" title='uvm_pageout' data-ref="uvm_pageout" data-ref-filename="uvm_pageout">uvm_pageout</dfn>(<em>void</em> *<dfn class="local col4 decl" id="4arg" title='arg' data-type='void *' data-ref="4arg" data-ref-filename="4arg">arg</dfn>)</td></tr>
<tr><th id="239">239</th><td>{</td></tr>
<tr><th id="240">240</th><td>	<em>int</em> <dfn class="local col5 decl" id="5npages" title='npages' data-type='int' data-ref="5npages" data-ref-filename="5npages">npages</dfn> = <var>0</var>;</td></tr>
<tr><th id="241">241</th><td>	<em>int</em> <dfn class="local col6 decl" id="6extrapages" title='extrapages' data-type='int' data-ref="6extrapages" data-ref-filename="6extrapages">extrapages</dfn> = <var>0</var>;</td></tr>
<tr><th id="242">242</th><td>	</td></tr>
<tr><th id="243">243</th><td>	<a class="macro" href="uvm_stat.h.html#74" title="" data-ref="_M/UVMHIST_FUNC">UVMHIST_FUNC</a>(<q>"uvm_pageout"</q>); <a class="macro" href="uvm_stat.h.html#73" title="" data-ref="_M/UVMHIST_CALLED">UVMHIST_CALLED</a>(pdhist);</td></tr>
<tr><th id="244">244</th><td></td></tr>
<tr><th id="245">245</th><td>	<a class="macro" href="uvm_stat.h.html#72" title="" data-ref="_M/UVMHIST_LOG">UVMHIST_LOG</a>(pdhist,<q>"&lt;starting uvm pagedaemon&gt;"</q>, <var>0</var>, <var>0</var>, <var>0</var>, <var>0</var>);</td></tr>
<tr><th id="246">246</th><td></td></tr>
<tr><th id="247">247</th><td>	<a class="ref fn" href="../sys/mutex.h.html#mutex_init" title='mutex_init' data-ref="mutex_init" data-ref-filename="mutex_init">mutex_init</a>(&amp;<a class="tu ref" href="#uvmpd_pool_drain_lock" title='uvmpd_pool_drain_lock' data-use='a' data-ref="uvmpd_pool_drain_lock" data-ref-filename="uvmpd_pool_drain_lock">uvmpd_pool_drain_lock</a>, <a class="enum" href="../sys/mutex.h.html#MUTEX_DEFAULT" title='MUTEX_DEFAULT' data-ref="MUTEX_DEFAULT" data-ref-filename="MUTEX_DEFAULT">MUTEX_DEFAULT</a>, <a class="macro" href="../arch/x86/include/intrdefs.h.html#13" title="0x6" data-ref="_M/IPL_VM">IPL_VM</a>);</td></tr>
<tr><th id="248">248</th><td>	<a class="ref fn" href="../sys/condvar.h.html#cv_init" title='cv_init' data-ref="cv_init" data-ref-filename="cv_init">cv_init</a>(&amp;<a class="tu ref" href="#uvmpd_pool_drain_cv" title='uvmpd_pool_drain_cv' data-use='a' data-ref="uvmpd_pool_drain_cv" data-ref-filename="uvmpd_pool_drain_cv">uvmpd_pool_drain_cv</a>, <q>"pooldrain"</q>);</td></tr>
<tr><th id="249">249</th><td></td></tr>
<tr><th id="250">250</th><td>	<i>/* Create the pool drainer kernel thread. */</i></td></tr>
<tr><th id="251">251</th><td>	<b>if</b> (<a class="ref fn" href="../sys/kthread.h.html#kthread_create" title='kthread_create' data-ref="kthread_create" data-ref-filename="kthread_create">kthread_create</a>(<a class="macro" href="../sys/param.h.html#329" title="((96 + 32 - 1) - schedppq * 2)" data-ref="_M/PRI_VM">PRI_VM</a>, <a class="macro" href="../sys/kthread.h.html#47" title="0x02" data-ref="_M/KTHREAD_MPSAFE">KTHREAD_MPSAFE</a>, <a class="macro" href="../sys/null.h.html#13" title="((void *)0)" data-ref="_M/NULL">NULL</a>,</td></tr>
<tr><th id="252">252</th><td>	    <a class="tu ref fn" href="#uvmpd_pool_drain_thread" title='uvmpd_pool_drain_thread' data-use='r' data-ref="uvmpd_pool_drain_thread" data-ref-filename="uvmpd_pool_drain_thread">uvmpd_pool_drain_thread</a>, <a class="macro" href="../sys/null.h.html#13" title="((void *)0)" data-ref="_M/NULL">NULL</a>, <a class="macro" href="../sys/null.h.html#13" title="((void *)0)" data-ref="_M/NULL">NULL</a>, <q>"pooldrain"</q>))</td></tr>
<tr><th id="253">253</th><td>		<a class="ref fn" href="../sys/systm.h.html#panic" title='panic' data-ref="panic" data-ref-filename="panic">panic</a>(<q>"fork pooldrain"</q>);</td></tr>
<tr><th id="254">254</th><td></td></tr>
<tr><th id="255">255</th><td>	<i>/*</i></td></tr>
<tr><th id="256">256</th><td><i>	 * ensure correct priority and set paging parameters...</i></td></tr>
<tr><th id="257">257</th><td><i>	 */</i></td></tr>
<tr><th id="258">258</th><td></td></tr>
<tr><th id="259">259</th><td>	<a class="ref" href="uvm.h.html#uvm" title='uvm' data-ref="uvm" data-ref-filename="uvm">uvm</a>.<a class="ref field" href="uvm.h.html#uvm::pagedaemon_lwp" title='uvm::pagedaemon_lwp' data-ref="uvm::pagedaemon_lwp" data-ref-filename="uvm..pagedaemon_lwp">pagedaemon_lwp</a> = <a class="macro" href="../arch/x86/include/cpu.h.html#405" title="x86_curlwp()" data-ref="_M/curlwp">curlwp</a>;</td></tr>
<tr><th id="260">260</th><td>	<a class="ref fn" href="../sys/mutex.h.html#mutex_enter" title='mutex_enter' data-ref="mutex_enter" data-ref-filename="mutex_enter">mutex_enter</a>(&amp;<a class="ref" href="uvm.h.html#uvm_pageqlock" title='uvm_pageqlock' data-ref="uvm_pageqlock" data-ref-filename="uvm_pageqlock">uvm_pageqlock</a>);</td></tr>
<tr><th id="261">261</th><td>	<a class="local col5 ref" href="#5npages" title='npages' data-ref="5npages" data-ref-filename="5npages">npages</a> = <a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::npages" title='uvmexp::npages' data-ref="uvmexp::npages" data-ref-filename="uvmexp..npages">npages</a>;</td></tr>
<tr><th id="262">262</th><td>	<a class="tu ref fn" href="#uvmpd_tune" title='uvmpd_tune' data-use='c' data-ref="uvmpd_tune" data-ref-filename="uvmpd_tune">uvmpd_tune</a>();</td></tr>
<tr><th id="263">263</th><td>	<a class="ref fn" href="../sys/mutex.h.html#mutex_exit" title='mutex_exit' data-ref="mutex_exit" data-ref-filename="mutex_exit">mutex_exit</a>(&amp;<a class="ref" href="uvm.h.html#uvm_pageqlock" title='uvm_pageqlock' data-ref="uvm_pageqlock" data-ref-filename="uvm_pageqlock">uvm_pageqlock</a>);</td></tr>
<tr><th id="264">264</th><td></td></tr>
<tr><th id="265">265</th><td>	<i>/*</i></td></tr>
<tr><th id="266">266</th><td><i>	 * main loop</i></td></tr>
<tr><th id="267">267</th><td><i>	 */</i></td></tr>
<tr><th id="268">268</th><td></td></tr>
<tr><th id="269">269</th><td>	<b>for</b> (;;) {</td></tr>
<tr><th id="270">270</th><td>		<a class="macro" href="../sys/stdbool.h.html#37" title="_Bool" data-ref="_M/bool">bool</a> <dfn class="local col7 decl" id="7needsscan" title='needsscan' data-type='_Bool' data-ref="7needsscan" data-ref-filename="7needsscan">needsscan</dfn>, <dfn class="local col8 decl" id="8needsfree" title='needsfree' data-type='_Bool' data-ref="8needsfree" data-ref-filename="8needsfree">needsfree</dfn>, <dfn class="local col9 decl" id="9kmem_va_starved" title='kmem_va_starved' data-type='_Bool' data-ref="9kmem_va_starved" data-ref-filename="9kmem_va_starved">kmem_va_starved</dfn>;</td></tr>
<tr><th id="271">271</th><td></td></tr>
<tr><th id="272">272</th><td>		<a class="local col9 ref" href="#9kmem_va_starved" title='kmem_va_starved' data-ref="9kmem_va_starved" data-ref-filename="9kmem_va_starved">kmem_va_starved</a> = <a class="ref fn" href="uvm_extern.h.html#uvm_km_va_starved_p" title='uvm_km_va_starved_p' data-ref="uvm_km_va_starved_p" data-ref-filename="uvm_km_va_starved_p">uvm_km_va_starved_p</a>();</td></tr>
<tr><th id="273">273</th><td></td></tr>
<tr><th id="274">274</th><td>		<a class="ref fn" href="../sys/mutex.h.html#mutex_spin_enter" title='mutex_spin_enter' data-ref="mutex_spin_enter" data-ref-filename="mutex_spin_enter">mutex_spin_enter</a>(&amp;<a class="ref" href="uvm.h.html#uvm_fpageqlock" title='uvm_fpageqlock' data-ref="uvm_fpageqlock" data-ref-filename="uvm_fpageqlock">uvm_fpageqlock</a>);</td></tr>
<tr><th id="275">275</th><td>		<b>if</b> ((<a class="tu ref" href="#uvm_pagedaemon_waiters" title='uvm_pagedaemon_waiters' data-use='r' data-ref="uvm_pagedaemon_waiters" data-ref-filename="uvm_pagedaemon_waiters">uvm_pagedaemon_waiters</a> == <var>0</var> || <a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::paging" title='uvmexp::paging' data-ref="uvmexp::paging" data-ref-filename="uvmexp..paging">paging</a> &gt; <var>0</var>) &amp;&amp;</td></tr>
<tr><th id="276">276</th><td>		    !<a class="local col9 ref" href="#9kmem_va_starved" title='kmem_va_starved' data-ref="9kmem_va_starved" data-ref-filename="9kmem_va_starved">kmem_va_starved</a>) {</td></tr>
<tr><th id="277">277</th><td>			<a class="macro" href="uvm_stat.h.html#72" title="" data-ref="_M/UVMHIST_LOG">UVMHIST_LOG</a>(pdhist,<q>"  &lt;&lt;SLEEPING&gt;&gt;"</q>,<var>0</var>,<var>0</var>,<var>0</var>,<var>0</var>);</td></tr>
<tr><th id="278">278</th><td>			<a class="macro" href="uvm.h.html#174" title="do { (void) mtsleep(&amp;uvm.pagedaemon, 4 | 0x200 | (0 ? 0x100 : 0), &quot;pgdaemon&quot;, 0, &amp;uvm_fpageqlock); } while ( 0)" data-ref="_M/UVM_UNLOCK_AND_WAIT">UVM_UNLOCK_AND_WAIT</a>(&amp;<a class="ref" href="uvm.h.html#uvm" title='uvm' data-ref="uvm" data-ref-filename="uvm">uvm</a>.<a class="ref field" href="uvm.h.html#uvm::pagedaemon" title='uvm::pagedaemon' data-ref="uvm::pagedaemon" data-ref-filename="uvm..pagedaemon">pagedaemon</a>,</td></tr>
<tr><th id="279">279</th><td>			    &amp;<a class="ref" href="uvm.h.html#uvm_fpageqlock" title='uvm_fpageqlock' data-ref="uvm_fpageqlock" data-ref-filename="uvm_fpageqlock">uvm_fpageqlock</a>, <a class="macro" href="../sys/stdbool.h.html#40" title="0" data-ref="_M/false">false</a>, <q>"pgdaemon"</q>, <var>0</var>);</td></tr>
<tr><th id="280">280</th><td>			<a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::pdwoke" title='uvmexp::pdwoke' data-ref="uvmexp::pdwoke" data-ref-filename="uvmexp..pdwoke">pdwoke</a>++;</td></tr>
<tr><th id="281">281</th><td>			<a class="macro" href="uvm_stat.h.html#72" title="" data-ref="_M/UVMHIST_LOG">UVMHIST_LOG</a>(pdhist,<q>"  &lt;&lt;WOKE UP&gt;&gt;"</q>,<var>0</var>,<var>0</var>,<var>0</var>,<var>0</var>);</td></tr>
<tr><th id="282">282</th><td>		} <b>else</b> {</td></tr>
<tr><th id="283">283</th><td>			<a class="ref fn" href="../sys/mutex.h.html#mutex_spin_exit" title='mutex_spin_exit' data-ref="mutex_spin_exit" data-ref-filename="mutex_spin_exit">mutex_spin_exit</a>(&amp;<a class="ref" href="uvm.h.html#uvm_fpageqlock" title='uvm_fpageqlock' data-ref="uvm_fpageqlock" data-ref-filename="uvm_fpageqlock">uvm_fpageqlock</a>);</td></tr>
<tr><th id="284">284</th><td>		}</td></tr>
<tr><th id="285">285</th><td></td></tr>
<tr><th id="286">286</th><td>		<i>/*</i></td></tr>
<tr><th id="287">287</th><td><i>		 * now lock page queues and recompute inactive count</i></td></tr>
<tr><th id="288">288</th><td><i>		 */</i></td></tr>
<tr><th id="289">289</th><td></td></tr>
<tr><th id="290">290</th><td>		<a class="ref fn" href="../sys/mutex.h.html#mutex_enter" title='mutex_enter' data-ref="mutex_enter" data-ref-filename="mutex_enter">mutex_enter</a>(&amp;<a class="ref" href="uvm.h.html#uvm_pageqlock" title='uvm_pageqlock' data-ref="uvm_pageqlock" data-ref-filename="uvm_pageqlock">uvm_pageqlock</a>);</td></tr>
<tr><th id="291">291</th><td>		<b>if</b> (<a class="local col5 ref" href="#5npages" title='npages' data-ref="5npages" data-ref-filename="5npages">npages</a> != <a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::npages" title='uvmexp::npages' data-ref="uvmexp::npages" data-ref-filename="uvmexp..npages">npages</a> || <a class="local col6 ref" href="#6extrapages" title='extrapages' data-ref="6extrapages" data-ref-filename="6extrapages">extrapages</a> != <a class="ref" href="#uvm_extrapages" title='uvm_extrapages' data-ref="uvm_extrapages" data-ref-filename="uvm_extrapages">uvm_extrapages</a>) {</td></tr>
<tr><th id="292">292</th><td>			<a class="local col5 ref" href="#5npages" title='npages' data-ref="5npages" data-ref-filename="5npages">npages</a> = <a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::npages" title='uvmexp::npages' data-ref="uvmexp::npages" data-ref-filename="uvmexp..npages">npages</a>;</td></tr>
<tr><th id="293">293</th><td>			<a class="local col6 ref" href="#6extrapages" title='extrapages' data-ref="6extrapages" data-ref-filename="6extrapages">extrapages</a> = <a class="ref" href="#uvm_extrapages" title='uvm_extrapages' data-ref="uvm_extrapages" data-ref-filename="uvm_extrapages">uvm_extrapages</a>;</td></tr>
<tr><th id="294">294</th><td>			<a class="ref fn" href="../sys/mutex.h.html#mutex_spin_enter" title='mutex_spin_enter' data-ref="mutex_spin_enter" data-ref-filename="mutex_spin_enter">mutex_spin_enter</a>(&amp;<a class="ref" href="uvm.h.html#uvm_fpageqlock" title='uvm_fpageqlock' data-ref="uvm_fpageqlock" data-ref-filename="uvm_fpageqlock">uvm_fpageqlock</a>);</td></tr>
<tr><th id="295">295</th><td>			<a class="tu ref fn" href="#uvmpd_tune" title='uvmpd_tune' data-use='c' data-ref="uvmpd_tune" data-ref-filename="uvmpd_tune">uvmpd_tune</a>();</td></tr>
<tr><th id="296">296</th><td>			<a class="ref fn" href="../sys/mutex.h.html#mutex_spin_exit" title='mutex_spin_exit' data-ref="mutex_spin_exit" data-ref-filename="mutex_spin_exit">mutex_spin_exit</a>(&amp;<a class="ref" href="uvm.h.html#uvm_fpageqlock" title='uvm_fpageqlock' data-ref="uvm_fpageqlock" data-ref-filename="uvm_fpageqlock">uvm_fpageqlock</a>);</td></tr>
<tr><th id="297">297</th><td>		}</td></tr>
<tr><th id="298">298</th><td></td></tr>
<tr><th id="299">299</th><td>		<a class="ref fn" href="uvm_pdpolicy.h.html#uvmpdpol_tune" title='uvmpdpol_tune' data-ref="uvmpdpol_tune" data-ref-filename="uvmpdpol_tune">uvmpdpol_tune</a>();</td></tr>
<tr><th id="300">300</th><td></td></tr>
<tr><th id="301">301</th><td>		<i>/*</i></td></tr>
<tr><th id="302">302</th><td><i>		 * Estimate a hint.  Note that bufmem are returned to</i></td></tr>
<tr><th id="303">303</th><td><i>		 * system only when entire pool page is empty.</i></td></tr>
<tr><th id="304">304</th><td><i>		 */</i></td></tr>
<tr><th id="305">305</th><td>		<a class="ref fn" href="../sys/mutex.h.html#mutex_spin_enter" title='mutex_spin_enter' data-ref="mutex_spin_enter" data-ref-filename="mutex_spin_enter">mutex_spin_enter</a>(&amp;<a class="ref" href="uvm.h.html#uvm_fpageqlock" title='uvm_fpageqlock' data-ref="uvm_fpageqlock" data-ref-filename="uvm_fpageqlock">uvm_fpageqlock</a>);</td></tr>
<tr><th id="306">306</th><td></td></tr>
<tr><th id="307">307</th><td>		<a class="macro" href="uvm_stat.h.html#72" title="" data-ref="_M/UVMHIST_LOG">UVMHIST_LOG</a>(pdhist,<q>"  free/ftarg=%jd/%jd"</q>,</td></tr>
<tr><th id="308">308</th><td>		    uvmexp.free, uvmexp.freetarg, <var>0</var>,<var>0</var>);</td></tr>
<tr><th id="309">309</th><td></td></tr>
<tr><th id="310">310</th><td>		<a class="local col8 ref" href="#8needsfree" title='needsfree' data-ref="8needsfree" data-ref-filename="8needsfree">needsfree</a> = <a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::free" title='uvmexp::free' data-ref="uvmexp::free" data-ref-filename="uvmexp..free">free</a> + <a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::paging" title='uvmexp::paging' data-ref="uvmexp::paging" data-ref-filename="uvmexp..paging">paging</a> &lt; <a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::freetarg" title='uvmexp::freetarg' data-ref="uvmexp::freetarg" data-ref-filename="uvmexp..freetarg">freetarg</a>;</td></tr>
<tr><th id="311">311</th><td>		<a class="local col7 ref" href="#7needsscan" title='needsscan' data-ref="7needsscan" data-ref-filename="7needsscan">needsscan</a> = <a class="local col8 ref" href="#8needsfree" title='needsfree' data-ref="8needsfree" data-ref-filename="8needsfree">needsfree</a> || <a class="ref fn" href="uvm_pdpolicy.h.html#uvmpdpol_needsscan_p" title='uvmpdpol_needsscan_p' data-ref="uvmpdpol_needsscan_p" data-ref-filename="uvmpdpol_needsscan_p">uvmpdpol_needsscan_p</a>();</td></tr>
<tr><th id="312">312</th><td></td></tr>
<tr><th id="313">313</th><td>		<i>/*</i></td></tr>
<tr><th id="314">314</th><td><i>		 * scan if needed</i></td></tr>
<tr><th id="315">315</th><td><i>		 */</i></td></tr>
<tr><th id="316">316</th><td>		<b>if</b> (<a class="local col7 ref" href="#7needsscan" title='needsscan' data-ref="7needsscan" data-ref-filename="7needsscan">needsscan</a>) {</td></tr>
<tr><th id="317">317</th><td>			<a class="ref fn" href="../sys/mutex.h.html#mutex_spin_exit" title='mutex_spin_exit' data-ref="mutex_spin_exit" data-ref-filename="mutex_spin_exit">mutex_spin_exit</a>(&amp;<a class="ref" href="uvm.h.html#uvm_fpageqlock" title='uvm_fpageqlock' data-ref="uvm_fpageqlock" data-ref-filename="uvm_fpageqlock">uvm_fpageqlock</a>);</td></tr>
<tr><th id="318">318</th><td>			<a class="tu ref fn" href="#uvmpd_scan" title='uvmpd_scan' data-use='c' data-ref="uvmpd_scan" data-ref-filename="uvmpd_scan">uvmpd_scan</a>();</td></tr>
<tr><th id="319">319</th><td>			<a class="ref fn" href="../sys/mutex.h.html#mutex_spin_enter" title='mutex_spin_enter' data-ref="mutex_spin_enter" data-ref-filename="mutex_spin_enter">mutex_spin_enter</a>(&amp;<a class="ref" href="uvm.h.html#uvm_fpageqlock" title='uvm_fpageqlock' data-ref="uvm_fpageqlock" data-ref-filename="uvm_fpageqlock">uvm_fpageqlock</a>);</td></tr>
<tr><th id="320">320</th><td>		}</td></tr>
<tr><th id="321">321</th><td></td></tr>
<tr><th id="322">322</th><td>		<i>/*</i></td></tr>
<tr><th id="323">323</th><td><i>		 * if there's any free memory to be had,</i></td></tr>
<tr><th id="324">324</th><td><i>		 * wake up any waiters.</i></td></tr>
<tr><th id="325">325</th><td><i>		 */</i></td></tr>
<tr><th id="326">326</th><td>		<b>if</b> (<a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::free" title='uvmexp::free' data-ref="uvmexp::free" data-ref-filename="uvmexp..free">free</a> &gt; <a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::reserve_kernel" title='uvmexp::reserve_kernel' data-ref="uvmexp::reserve_kernel" data-ref-filename="uvmexp..reserve_kernel">reserve_kernel</a> ||</td></tr>
<tr><th id="327">327</th><td>		    <a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::paging" title='uvmexp::paging' data-ref="uvmexp::paging" data-ref-filename="uvmexp..paging">paging</a> == <var>0</var>) {</td></tr>
<tr><th id="328">328</th><td>			<a class="ref fn" href="../sys/proc.h.html#wakeup" title='wakeup' data-ref="wakeup" data-ref-filename="wakeup">wakeup</a>(&amp;<a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::free" title='uvmexp::free' data-ref="uvmexp::free" data-ref-filename="uvmexp..free">free</a>);</td></tr>
<tr><th id="329">329</th><td>			<a class="tu ref" href="#uvm_pagedaemon_waiters" title='uvm_pagedaemon_waiters' data-use='w' data-ref="uvm_pagedaemon_waiters" data-ref-filename="uvm_pagedaemon_waiters">uvm_pagedaemon_waiters</a> = <var>0</var>;</td></tr>
<tr><th id="330">330</th><td>		}</td></tr>
<tr><th id="331">331</th><td>		<a class="ref fn" href="../sys/mutex.h.html#mutex_spin_exit" title='mutex_spin_exit' data-ref="mutex_spin_exit" data-ref-filename="mutex_spin_exit">mutex_spin_exit</a>(&amp;<a class="ref" href="uvm.h.html#uvm_fpageqlock" title='uvm_fpageqlock' data-ref="uvm_fpageqlock" data-ref-filename="uvm_fpageqlock">uvm_fpageqlock</a>);</td></tr>
<tr><th id="332">332</th><td></td></tr>
<tr><th id="333">333</th><td>		<i>/*</i></td></tr>
<tr><th id="334">334</th><td><i>		 * scan done.  unlock page queues (the only lock we are holding)</i></td></tr>
<tr><th id="335">335</th><td><i>		 */</i></td></tr>
<tr><th id="336">336</th><td>		<a class="ref fn" href="../sys/mutex.h.html#mutex_exit" title='mutex_exit' data-ref="mutex_exit" data-ref-filename="mutex_exit">mutex_exit</a>(&amp;<a class="ref" href="uvm.h.html#uvm_pageqlock" title='uvm_pageqlock' data-ref="uvm_pageqlock" data-ref-filename="uvm_pageqlock">uvm_pageqlock</a>);</td></tr>
<tr><th id="337">337</th><td></td></tr>
<tr><th id="338">338</th><td>		<i>/*</i></td></tr>
<tr><th id="339">339</th><td><i>		 * if we don't need free memory, we're done.</i></td></tr>
<tr><th id="340">340</th><td><i>		 */</i></td></tr>
<tr><th id="341">341</th><td></td></tr>
<tr><th id="342">342</th><td>		<b>if</b> (!<a class="local col8 ref" href="#8needsfree" title='needsfree' data-ref="8needsfree" data-ref-filename="8needsfree">needsfree</a> &amp;&amp; !<a class="local col9 ref" href="#9kmem_va_starved" title='kmem_va_starved' data-ref="9kmem_va_starved" data-ref-filename="9kmem_va_starved">kmem_va_starved</a>)</td></tr>
<tr><th id="343">343</th><td>			<b>continue</b>;</td></tr>
<tr><th id="344">344</th><td></td></tr>
<tr><th id="345">345</th><td>		<i>/*</i></td></tr>
<tr><th id="346">346</th><td><i>		 * kick the pool drainer thread.</i></td></tr>
<tr><th id="347">347</th><td><i>		 */</i></td></tr>
<tr><th id="348">348</th><td></td></tr>
<tr><th id="349">349</th><td>		<a class="tu ref fn" href="#uvmpd_pool_drain_wakeup" title='uvmpd_pool_drain_wakeup' data-use='c' data-ref="uvmpd_pool_drain_wakeup" data-ref-filename="uvmpd_pool_drain_wakeup">uvmpd_pool_drain_wakeup</a>();</td></tr>
<tr><th id="350">350</th><td>	}</td></tr>
<tr><th id="351">351</th><td>	<i>/*NOTREACHED*/</i></td></tr>
<tr><th id="352">352</th><td>}</td></tr>
<tr><th id="353">353</th><td></td></tr>
<tr><th id="354">354</th><td></td></tr>
<tr><th id="355">355</th><td><i>/*</i></td></tr>
<tr><th id="356">356</th><td><i> * uvm_aiodone_worker: a workqueue callback for the aiodone daemon.</i></td></tr>
<tr><th id="357">357</th><td><i> */</i></td></tr>
<tr><th id="358">358</th><td></td></tr>
<tr><th id="359">359</th><td><em>void</em></td></tr>
<tr><th id="360">360</th><td><dfn class="decl def fn" id="uvm_aiodone_worker" title='uvm_aiodone_worker' data-ref="uvm_aiodone_worker" data-ref-filename="uvm_aiodone_worker">uvm_aiodone_worker</dfn>(<b>struct</b> <a class="type" href="../sys/workqueue.h.html#work" title='work' data-ref="work" data-ref-filename="work">work</a> *<dfn class="local col0 decl" id="10wk" title='wk' data-type='struct work *' data-ref="10wk" data-ref-filename="10wk">wk</dfn>, <em>void</em> *<dfn class="local col1 decl" id="11dummy" title='dummy' data-type='void *' data-ref="11dummy" data-ref-filename="11dummy">dummy</dfn>)</td></tr>
<tr><th id="361">361</th><td>{</td></tr>
<tr><th id="362">362</th><td>	<b>struct</b> <a class="type" href="../sys/buf.h.html#buf" title='buf' data-ref="buf" data-ref-filename="buf">buf</a> *<dfn class="local col2 decl" id="12bp" title='bp' data-type='struct buf *' data-ref="12bp" data-ref-filename="12bp">bp</dfn> = (<em>void</em> *)<a class="local col0 ref" href="#10wk" title='wk' data-ref="10wk" data-ref-filename="10wk">wk</a>;</td></tr>
<tr><th id="363">363</th><td></td></tr>
<tr><th id="364">364</th><td>	<a class="macro" href="../lib/libkern/libkern.h.html#279" title="(__builtin_expect(((&amp;bp-&gt;b_u.u_work == wk)) != 0, 1) ? (void)0 : kern_assert(&quot;kernel %sassertion \&quot;%s\&quot; failed: file \&quot;%s\&quot;, line %d &quot;, &quot;diagnostic &quot;, &quot;&amp;bp-&gt;b_work == wk&quot;, &quot;/___NETBSD_SRC___/objdir.amd64/sys/arch/amd64/compile/GENERIC/../../../../../../sys/uvm/uvm_pdaemon.c&quot;, 364))" data-ref="_M/KASSERT">KASSERT</a>(&amp;<a class="local col2 ref" href="#12bp" title='bp' data-ref="12bp" data-ref-filename="12bp">bp</a>-&gt;<a class="macro" href="../sys/buf.h.html#124" title="b_u.u_work" data-ref="_M/b_work">b_work</a> == <a class="local col0 ref" href="#10wk" title='wk' data-ref="10wk" data-ref-filename="10wk">wk</a>);</td></tr>
<tr><th id="365">365</th><td></td></tr>
<tr><th id="366">366</th><td>	<i>/*</i></td></tr>
<tr><th id="367">367</th><td><i>	 * process an i/o that's done.</i></td></tr>
<tr><th id="368">368</th><td><i>	 */</i></td></tr>
<tr><th id="369">369</th><td></td></tr>
<tr><th id="370">370</th><td>	(*<a class="local col2 ref" href="#12bp" title='bp' data-ref="12bp" data-ref-filename="12bp">bp</a>-&gt;<a class="ref field" href="../sys/buf.h.html#buf::b_iodone" title='buf::b_iodone' data-ref="buf::b_iodone" data-ref-filename="buf..b_iodone">b_iodone</a>)(<a class="local col2 ref" href="#12bp" title='bp' data-ref="12bp" data-ref-filename="12bp">bp</a>);</td></tr>
<tr><th id="371">371</th><td>}</td></tr>
<tr><th id="372">372</th><td></td></tr>
<tr><th id="373">373</th><td><em>void</em></td></tr>
<tr><th id="374">374</th><td><dfn class="decl def fn" id="uvm_pageout_start" title='uvm_pageout_start' data-ref="uvm_pageout_start" data-ref-filename="uvm_pageout_start">uvm_pageout_start</dfn>(<em>int</em> <dfn class="local col3 decl" id="13npages" title='npages' data-type='int' data-ref="13npages" data-ref-filename="13npages">npages</dfn>)</td></tr>
<tr><th id="375">375</th><td>{</td></tr>
<tr><th id="376">376</th><td></td></tr>
<tr><th id="377">377</th><td>	<a class="ref fn" href="../sys/mutex.h.html#mutex_spin_enter" title='mutex_spin_enter' data-ref="mutex_spin_enter" data-ref-filename="mutex_spin_enter">mutex_spin_enter</a>(&amp;<a class="ref" href="uvm.h.html#uvm_fpageqlock" title='uvm_fpageqlock' data-ref="uvm_fpageqlock" data-ref-filename="uvm_fpageqlock">uvm_fpageqlock</a>);</td></tr>
<tr><th id="378">378</th><td>	<a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::paging" title='uvmexp::paging' data-ref="uvmexp::paging" data-ref-filename="uvmexp..paging">paging</a> += <a class="local col3 ref" href="#13npages" title='npages' data-ref="13npages" data-ref-filename="13npages">npages</a>;</td></tr>
<tr><th id="379">379</th><td>	<a class="ref fn" href="../sys/mutex.h.html#mutex_spin_exit" title='mutex_spin_exit' data-ref="mutex_spin_exit" data-ref-filename="mutex_spin_exit">mutex_spin_exit</a>(&amp;<a class="ref" href="uvm.h.html#uvm_fpageqlock" title='uvm_fpageqlock' data-ref="uvm_fpageqlock" data-ref-filename="uvm_fpageqlock">uvm_fpageqlock</a>);</td></tr>
<tr><th id="380">380</th><td>}</td></tr>
<tr><th id="381">381</th><td></td></tr>
<tr><th id="382">382</th><td><em>void</em></td></tr>
<tr><th id="383">383</th><td><dfn class="decl def fn" id="uvm_pageout_done" title='uvm_pageout_done' data-ref="uvm_pageout_done" data-ref-filename="uvm_pageout_done">uvm_pageout_done</dfn>(<em>int</em> <dfn class="local col4 decl" id="14npages" title='npages' data-type='int' data-ref="14npages" data-ref-filename="14npages">npages</dfn>)</td></tr>
<tr><th id="384">384</th><td>{</td></tr>
<tr><th id="385">385</th><td></td></tr>
<tr><th id="386">386</th><td>	<a class="ref fn" href="../sys/mutex.h.html#mutex_spin_enter" title='mutex_spin_enter' data-ref="mutex_spin_enter" data-ref-filename="mutex_spin_enter">mutex_spin_enter</a>(&amp;<a class="ref" href="uvm.h.html#uvm_fpageqlock" title='uvm_fpageqlock' data-ref="uvm_fpageqlock" data-ref-filename="uvm_fpageqlock">uvm_fpageqlock</a>);</td></tr>
<tr><th id="387">387</th><td>	<a class="macro" href="../lib/libkern/libkern.h.html#279" title="(__builtin_expect(((uvmexp.paging &gt;= npages)) != 0, 1) ? (void)0 : kern_assert(&quot;kernel %sassertion \&quot;%s\&quot; failed: file \&quot;%s\&quot;, line %d &quot;, &quot;diagnostic &quot;, &quot;uvmexp.paging &gt;= npages&quot;, &quot;/___NETBSD_SRC___/objdir.amd64/sys/arch/amd64/compile/GENERIC/../../../../../../sys/uvm/uvm_pdaemon.c&quot;, 387))" data-ref="_M/KASSERT">KASSERT</a>(<a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::paging" title='uvmexp::paging' data-ref="uvmexp::paging" data-ref-filename="uvmexp..paging">paging</a> &gt;= <a class="local col4 ref" href="#14npages" title='npages' data-ref="14npages" data-ref-filename="14npages">npages</a>);</td></tr>
<tr><th id="388">388</th><td>	<a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::paging" title='uvmexp::paging' data-ref="uvmexp::paging" data-ref-filename="uvmexp..paging">paging</a> -= <a class="local col4 ref" href="#14npages" title='npages' data-ref="14npages" data-ref-filename="14npages">npages</a>;</td></tr>
<tr><th id="389">389</th><td></td></tr>
<tr><th id="390">390</th><td>	<i>/*</i></td></tr>
<tr><th id="391">391</th><td><i>	 * wake up either of pagedaemon or LWPs waiting for it.</i></td></tr>
<tr><th id="392">392</th><td><i>	 */</i></td></tr>
<tr><th id="393">393</th><td></td></tr>
<tr><th id="394">394</th><td>	<b>if</b> (<a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::free" title='uvmexp::free' data-ref="uvmexp::free" data-ref-filename="uvmexp..free">free</a> &lt;= <a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::reserve_kernel" title='uvmexp::reserve_kernel' data-ref="uvmexp::reserve_kernel" data-ref-filename="uvmexp..reserve_kernel">reserve_kernel</a>) {</td></tr>
<tr><th id="395">395</th><td>		<a class="ref fn" href="../sys/proc.h.html#wakeup" title='wakeup' data-ref="wakeup" data-ref-filename="wakeup">wakeup</a>(&amp;<a class="ref" href="uvm.h.html#uvm" title='uvm' data-ref="uvm" data-ref-filename="uvm">uvm</a>.<a class="ref field" href="uvm.h.html#uvm::pagedaemon" title='uvm::pagedaemon' data-ref="uvm::pagedaemon" data-ref-filename="uvm..pagedaemon">pagedaemon</a>);</td></tr>
<tr><th id="396">396</th><td>	} <b>else</b> {</td></tr>
<tr><th id="397">397</th><td>		<a class="ref fn" href="../sys/proc.h.html#wakeup" title='wakeup' data-ref="wakeup" data-ref-filename="wakeup">wakeup</a>(&amp;<a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::free" title='uvmexp::free' data-ref="uvmexp::free" data-ref-filename="uvmexp..free">free</a>);</td></tr>
<tr><th id="398">398</th><td>		<a class="tu ref" href="#uvm_pagedaemon_waiters" title='uvm_pagedaemon_waiters' data-use='w' data-ref="uvm_pagedaemon_waiters" data-ref-filename="uvm_pagedaemon_waiters">uvm_pagedaemon_waiters</a> = <var>0</var>;</td></tr>
<tr><th id="399">399</th><td>	}</td></tr>
<tr><th id="400">400</th><td>	<a class="ref fn" href="../sys/mutex.h.html#mutex_spin_exit" title='mutex_spin_exit' data-ref="mutex_spin_exit" data-ref-filename="mutex_spin_exit">mutex_spin_exit</a>(&amp;<a class="ref" href="uvm.h.html#uvm_fpageqlock" title='uvm_fpageqlock' data-ref="uvm_fpageqlock" data-ref-filename="uvm_fpageqlock">uvm_fpageqlock</a>);</td></tr>
<tr><th id="401">401</th><td>}</td></tr>
<tr><th id="402">402</th><td></td></tr>
<tr><th id="403">403</th><td><i>/*</i></td></tr>
<tr><th id="404">404</th><td><i> * uvmpd_trylockowner: trylock the page's owner.</i></td></tr>
<tr><th id="405">405</th><td><i> *</i></td></tr>
<tr><th id="406">406</th><td><i> * =&gt; called with pageq locked.</i></td></tr>
<tr><th id="407">407</th><td><i> * =&gt; resolve orphaned O-&gt;A loaned page.</i></td></tr>
<tr><th id="408">408</th><td><i> * =&gt; return the locked mutex on success.  otherwise, return NULL.</i></td></tr>
<tr><th id="409">409</th><td><i> */</i></td></tr>
<tr><th id="410">410</th><td></td></tr>
<tr><th id="411">411</th><td><a class="typedef" href="../sys/mutex.h.html#kmutex_t" title='kmutex_t' data-type='struct kmutex' data-ref="kmutex_t" data-ref-filename="kmutex_t">kmutex_t</a> *</td></tr>
<tr><th id="412">412</th><td><dfn class="decl def fn" id="uvmpd_trylockowner" title='uvmpd_trylockowner' data-ref="uvmpd_trylockowner" data-ref-filename="uvmpd_trylockowner">uvmpd_trylockowner</dfn>(<b>struct</b> <a class="type" href="uvm_page.h.html#vm_page" title='vm_page' data-ref="vm_page" data-ref-filename="vm_page">vm_page</a> *<dfn class="local col5 decl" id="15pg" title='pg' data-type='struct vm_page *' data-ref="15pg" data-ref-filename="15pg">pg</dfn>)</td></tr>
<tr><th id="413">413</th><td>{</td></tr>
<tr><th id="414">414</th><td>	<b>struct</b> <a class="type" href="uvm_object.h.html#uvm_object" title='uvm_object' data-ref="uvm_object" data-ref-filename="uvm_object">uvm_object</a> *<dfn class="local col6 decl" id="16uobj" title='uobj' data-type='struct uvm_object *' data-ref="16uobj" data-ref-filename="16uobj">uobj</dfn> = <a class="local col5 ref" href="#15pg" title='pg' data-ref="15pg" data-ref-filename="15pg">pg</a>-&gt;<a class="ref field" href="uvm_page.h.html#vm_page::uobject" title='vm_page::uobject' data-ref="vm_page::uobject" data-ref-filename="vm_page..uobject">uobject</a>;</td></tr>
<tr><th id="415">415</th><td>	<a class="typedef" href="../sys/mutex.h.html#kmutex_t" title='kmutex_t' data-type='struct kmutex' data-ref="kmutex_t" data-ref-filename="kmutex_t">kmutex_t</a> *<dfn class="local col7 decl" id="17slock" title='slock' data-type='kmutex_t *' data-ref="17slock" data-ref-filename="17slock">slock</dfn>;</td></tr>
<tr><th id="416">416</th><td></td></tr>
<tr><th id="417">417</th><td>	<a class="macro" href="../lib/libkern/libkern.h.html#279" title="(__builtin_expect(((mutex_owned(&amp;uvm_pageqlock))) != 0, 1) ? (void)0 : kern_assert(&quot;kernel %sassertion \&quot;%s\&quot; failed: file \&quot;%s\&quot;, line %d &quot;, &quot;diagnostic &quot;, &quot;mutex_owned(&amp;uvm_pageqlock)&quot;, &quot;/___NETBSD_SRC___/objdir.amd64/sys/arch/amd64/compile/GENERIC/../../../../../../sys/uvm/uvm_pdaemon.c&quot;, 417))" data-ref="_M/KASSERT">KASSERT</a>(<a class="ref fn" href="../sys/mutex.h.html#mutex_owned" title='mutex_owned' data-ref="mutex_owned" data-ref-filename="mutex_owned">mutex_owned</a>(&amp;<a class="ref" href="uvm.h.html#uvm_pageqlock" title='uvm_pageqlock' data-ref="uvm_pageqlock" data-ref-filename="uvm_pageqlock">uvm_pageqlock</a>));</td></tr>
<tr><th id="418">418</th><td></td></tr>
<tr><th id="419">419</th><td>	<b>if</b> (<a class="local col6 ref" href="#16uobj" title='uobj' data-ref="16uobj" data-ref-filename="16uobj">uobj</a> != <a class="macro" href="../sys/null.h.html#13" title="((void *)0)" data-ref="_M/NULL">NULL</a>) {</td></tr>
<tr><th id="420">420</th><td>		<a class="local col7 ref" href="#17slock" title='slock' data-ref="17slock" data-ref-filename="17slock">slock</a> = <a class="local col6 ref" href="#16uobj" title='uobj' data-ref="16uobj" data-ref-filename="16uobj">uobj</a>-&gt;<a class="ref field" href="uvm_object.h.html#uvm_object::vmobjlock" title='uvm_object::vmobjlock' data-ref="uvm_object::vmobjlock" data-ref-filename="uvm_object..vmobjlock">vmobjlock</a>;</td></tr>
<tr><th id="421">421</th><td>	} <b>else</b> {</td></tr>
<tr><th id="422">422</th><td>		<b>struct</b> <a class="type" href="uvm_anon.h.html#vm_anon" title='vm_anon' data-ref="vm_anon" data-ref-filename="vm_anon">vm_anon</a> *<dfn class="local col8 decl" id="18anon" title='anon' data-type='struct vm_anon *' data-ref="18anon" data-ref-filename="18anon">anon</dfn> = <a class="local col5 ref" href="#15pg" title='pg' data-ref="15pg" data-ref-filename="15pg">pg</a>-&gt;<a class="ref field" href="uvm_page.h.html#vm_page::uanon" title='vm_page::uanon' data-ref="vm_page::uanon" data-ref-filename="vm_page..uanon">uanon</a>;</td></tr>
<tr><th id="423">423</th><td></td></tr>
<tr><th id="424">424</th><td>		<a class="macro" href="../lib/libkern/libkern.h.html#279" title="(__builtin_expect(((anon != ((void *)0))) != 0, 1) ? (void)0 : kern_assert(&quot;kernel %sassertion \&quot;%s\&quot; failed: file \&quot;%s\&quot;, line %d &quot;, &quot;diagnostic &quot;, &quot;anon != NULL&quot;, &quot;/___NETBSD_SRC___/objdir.amd64/sys/arch/amd64/compile/GENERIC/../../../../../../sys/uvm/uvm_pdaemon.c&quot;, 424))" data-ref="_M/KASSERT">KASSERT</a>(<a class="local col8 ref" href="#18anon" title='anon' data-ref="18anon" data-ref-filename="18anon">anon</a> != <a class="macro" href="../sys/null.h.html#13" title="((void *)0)" data-ref="_M/NULL">NULL</a>);</td></tr>
<tr><th id="425">425</th><td>		<a class="local col7 ref" href="#17slock" title='slock' data-ref="17slock" data-ref-filename="17slock">slock</a> = <a class="local col8 ref" href="#18anon" title='anon' data-ref="18anon" data-ref-filename="18anon">anon</a>-&gt;<a class="ref field" href="uvm_anon.h.html#vm_anon::an_lock" title='vm_anon::an_lock' data-ref="vm_anon::an_lock" data-ref-filename="vm_anon..an_lock">an_lock</a>;</td></tr>
<tr><th id="426">426</th><td>	}</td></tr>
<tr><th id="427">427</th><td></td></tr>
<tr><th id="428">428</th><td>	<b>if</b> (!<a class="ref fn" href="../sys/mutex.h.html#mutex_tryenter" title='mutex_tryenter' data-ref="mutex_tryenter" data-ref-filename="mutex_tryenter">mutex_tryenter</a>(<a class="local col7 ref" href="#17slock" title='slock' data-ref="17slock" data-ref-filename="17slock">slock</a>)) {</td></tr>
<tr><th id="429">429</th><td>		<b>return</b> <a class="macro" href="../sys/null.h.html#13" title="((void *)0)" data-ref="_M/NULL">NULL</a>;</td></tr>
<tr><th id="430">430</th><td>	}</td></tr>
<tr><th id="431">431</th><td></td></tr>
<tr><th id="432">432</th><td>	<b>if</b> (<a class="local col6 ref" href="#16uobj" title='uobj' data-ref="16uobj" data-ref-filename="16uobj">uobj</a> == <a class="macro" href="../sys/null.h.html#13" title="((void *)0)" data-ref="_M/NULL">NULL</a>) {</td></tr>
<tr><th id="433">433</th><td></td></tr>
<tr><th id="434">434</th><td>		<i>/*</i></td></tr>
<tr><th id="435">435</th><td><i>		 * set PQ_ANON if it isn't set already.</i></td></tr>
<tr><th id="436">436</th><td><i>		 */</i></td></tr>
<tr><th id="437">437</th><td></td></tr>
<tr><th id="438">438</th><td>		<b>if</b> ((<a class="local col5 ref" href="#15pg" title='pg' data-ref="15pg" data-ref-filename="15pg">pg</a>-&gt;<a class="ref field" href="uvm_page.h.html#vm_page::pqflags" title='vm_page::pqflags' data-ref="vm_page::pqflags" data-ref-filename="vm_page..pqflags">pqflags</a> &amp; <a class="macro" href="uvm_page.h.html#259" title="0x0002" data-ref="_M/PQ_ANON">PQ_ANON</a>) == <var>0</var>) {</td></tr>
<tr><th id="439">439</th><td>			<a class="macro" href="../lib/libkern/libkern.h.html#279" title="(__builtin_expect(((pg-&gt;loan_count &gt; 0)) != 0, 1) ? (void)0 : kern_assert(&quot;kernel %sassertion \&quot;%s\&quot; failed: file \&quot;%s\&quot;, line %d &quot;, &quot;diagnostic &quot;, &quot;pg-&gt;loan_count &gt; 0&quot;, &quot;/___NETBSD_SRC___/objdir.amd64/sys/arch/amd64/compile/GENERIC/../../../../../../sys/uvm/uvm_pdaemon.c&quot;, 439))" data-ref="_M/KASSERT">KASSERT</a>(<a class="local col5 ref" href="#15pg" title='pg' data-ref="15pg" data-ref-filename="15pg">pg</a>-&gt;<a class="ref field" href="uvm_page.h.html#vm_page::loan_count" title='vm_page::loan_count' data-ref="vm_page::loan_count" data-ref-filename="vm_page..loan_count">loan_count</a> &gt; <var>0</var>);</td></tr>
<tr><th id="440">440</th><td>			<a class="local col5 ref" href="#15pg" title='pg' data-ref="15pg" data-ref-filename="15pg">pg</a>-&gt;<a class="ref field" href="uvm_page.h.html#vm_page::loan_count" title='vm_page::loan_count' data-ref="vm_page::loan_count" data-ref-filename="vm_page..loan_count">loan_count</a>--;</td></tr>
<tr><th id="441">441</th><td>			<a class="local col5 ref" href="#15pg" title='pg' data-ref="15pg" data-ref-filename="15pg">pg</a>-&gt;<a class="ref field" href="uvm_page.h.html#vm_page::pqflags" title='vm_page::pqflags' data-ref="vm_page::pqflags" data-ref-filename="vm_page..pqflags">pqflags</a> |= <a class="macro" href="uvm_page.h.html#259" title="0x0002" data-ref="_M/PQ_ANON">PQ_ANON</a>;</td></tr>
<tr><th id="442">442</th><td>			<i>/* anon now owns it */</i></td></tr>
<tr><th id="443">443</th><td>		}</td></tr>
<tr><th id="444">444</th><td>	}</td></tr>
<tr><th id="445">445</th><td></td></tr>
<tr><th id="446">446</th><td>	<b>return</b> <a class="local col7 ref" href="#17slock" title='slock' data-ref="17slock" data-ref-filename="17slock">slock</a>;</td></tr>
<tr><th id="447">447</th><td>}</td></tr>
<tr><th id="448">448</th><td></td></tr>
<tr><th id="449">449</th><td><u>#<span data-ppcond="449">if</span> defined(<a class="macro" href="../../objdir.amd64/sys/arch/amd64/compile/GENERIC/opt_vmswap.h.html#1" data-ref="_M/VMSWAP">VMSWAP</a>)</u></td></tr>
<tr><th id="450">450</th><td><b>struct</b> <dfn class="type def" id="swapcluster" title='swapcluster' data-ref="swapcluster" data-ref-filename="swapcluster">swapcluster</dfn> {</td></tr>
<tr><th id="451">451</th><td>	<em>int</em> <dfn class="tu decl field" id="swapcluster::swc_slot" title='swapcluster::swc_slot' data-type='int' data-ref="swapcluster::swc_slot" data-ref-filename="swapcluster..swc_slot">swc_slot</dfn>;</td></tr>
<tr><th id="452">452</th><td>	<em>int</em> <dfn class="tu decl field" id="swapcluster::swc_nallocated" title='swapcluster::swc_nallocated' data-type='int' data-ref="swapcluster::swc_nallocated" data-ref-filename="swapcluster..swc_nallocated">swc_nallocated</dfn>;</td></tr>
<tr><th id="453">453</th><td>	<em>int</em> <dfn class="tu decl field" id="swapcluster::swc_nused" title='swapcluster::swc_nused' data-type='int' data-ref="swapcluster::swc_nused" data-ref-filename="swapcluster..swc_nused">swc_nused</dfn>;</td></tr>
<tr><th id="454">454</th><td>	<b>struct</b> <a class="type" href="uvm_page.h.html#vm_page" title='vm_page' data-ref="vm_page" data-ref-filename="vm_page">vm_page</a> *<dfn class="tu decl field" id="swapcluster::swc_pages" title='swapcluster::swc_pages' data-type='struct vm_page *[16]' data-ref="swapcluster::swc_pages" data-ref-filename="swapcluster..swc_pages">swc_pages</dfn>[<a class="macro" href="../sys/param.h.html#388" title="((((64 * 1024))+(((1 &lt;&lt; 12))-1))/((1 &lt;&lt; 12)))" data-ref="_M/howmany">howmany</a>(<a class="macro" href="../sys/param.h.html#184" title="(64 * 1024)" data-ref="_M/MAXPHYS">MAXPHYS</a>, <a class="macro" href="uvm_param.h.html#98" title="(1 &lt;&lt; 12)" data-ref="_M/MIN_PAGE_SIZE">MIN_PAGE_SIZE</a>)];</td></tr>
<tr><th id="455">455</th><td>};</td></tr>
<tr><th id="456">456</th><td></td></tr>
<tr><th id="457">457</th><td><em>static</em> <em>void</em></td></tr>
<tr><th id="458">458</th><td><dfn class="tu decl def fn" id="swapcluster_init" title='swapcluster_init' data-type='void swapcluster_init(struct swapcluster * swc)' data-ref="swapcluster_init" data-ref-filename="swapcluster_init">swapcluster_init</dfn>(<b>struct</b> <a class="type" href="#swapcluster" title='swapcluster' data-ref="swapcluster" data-ref-filename="swapcluster">swapcluster</a> *<dfn class="local col9 decl" id="19swc" title='swc' data-type='struct swapcluster *' data-ref="19swc" data-ref-filename="19swc">swc</dfn>)</td></tr>
<tr><th id="459">459</th><td>{</td></tr>
<tr><th id="460">460</th><td></td></tr>
<tr><th id="461">461</th><td>	<a class="local col9 ref" href="#19swc" title='swc' data-ref="19swc" data-ref-filename="19swc">swc</a>-&gt;<a class="tu ref field" href="#swapcluster::swc_slot" title='swapcluster::swc_slot' data-use='w' data-ref="swapcluster::swc_slot" data-ref-filename="swapcluster..swc_slot">swc_slot</a> = <var>0</var>;</td></tr>
<tr><th id="462">462</th><td>	<a class="local col9 ref" href="#19swc" title='swc' data-ref="19swc" data-ref-filename="19swc">swc</a>-&gt;<a class="tu ref field" href="#swapcluster::swc_nused" title='swapcluster::swc_nused' data-use='w' data-ref="swapcluster::swc_nused" data-ref-filename="swapcluster..swc_nused">swc_nused</a> = <var>0</var>;</td></tr>
<tr><th id="463">463</th><td>}</td></tr>
<tr><th id="464">464</th><td></td></tr>
<tr><th id="465">465</th><td><em>static</em> <em>int</em></td></tr>
<tr><th id="466">466</th><td><dfn class="tu decl def fn" id="swapcluster_allocslots" title='swapcluster_allocslots' data-type='int swapcluster_allocslots(struct swapcluster * swc)' data-ref="swapcluster_allocslots" data-ref-filename="swapcluster_allocslots">swapcluster_allocslots</dfn>(<b>struct</b> <a class="type" href="#swapcluster" title='swapcluster' data-ref="swapcluster" data-ref-filename="swapcluster">swapcluster</a> *<dfn class="local col0 decl" id="20swc" title='swc' data-type='struct swapcluster *' data-ref="20swc" data-ref-filename="20swc">swc</dfn>)</td></tr>
<tr><th id="467">467</th><td>{</td></tr>
<tr><th id="468">468</th><td>	<em>int</em> <dfn class="local col1 decl" id="21slot" title='slot' data-type='int' data-ref="21slot" data-ref-filename="21slot">slot</dfn>;</td></tr>
<tr><th id="469">469</th><td>	<em>int</em> <dfn class="local col2 decl" id="22npages" title='npages' data-type='int' data-ref="22npages" data-ref-filename="22npages">npages</dfn>;</td></tr>
<tr><th id="470">470</th><td></td></tr>
<tr><th id="471">471</th><td>	<b>if</b> (<a class="local col0 ref" href="#20swc" title='swc' data-ref="20swc" data-ref-filename="20swc">swc</a>-&gt;<a class="tu ref field" href="#swapcluster::swc_slot" title='swapcluster::swc_slot' data-use='r' data-ref="swapcluster::swc_slot" data-ref-filename="swapcluster..swc_slot">swc_slot</a> != <var>0</var>) {</td></tr>
<tr><th id="472">472</th><td>		<b>return</b> <var>0</var>;</td></tr>
<tr><th id="473">473</th><td>	}</td></tr>
<tr><th id="474">474</th><td></td></tr>
<tr><th id="475">475</th><td>	<i>/* Even with strange MAXPHYS, the shift</i></td></tr>
<tr><th id="476">476</th><td><i>	   implicitly rounds down to a page. */</i></td></tr>
<tr><th id="477">477</th><td>	<a class="local col2 ref" href="#22npages" title='npages' data-ref="22npages" data-ref-filename="22npages">npages</a> = <a class="macro" href="../sys/param.h.html#184" title="(64 * 1024)" data-ref="_M/MAXPHYS">MAXPHYS</a> &gt;&gt; <a class="macro" href="../arch/amd64/include/vmparam.h.html#55" title="12" data-ref="_M/PAGE_SHIFT">PAGE_SHIFT</a>;</td></tr>
<tr><th id="478">478</th><td>	<a class="local col1 ref" href="#21slot" title='slot' data-ref="21slot" data-ref-filename="21slot">slot</a> = <a class="ref fn" href="uvm_swap.h.html#uvm_swap_alloc" title='uvm_swap_alloc' data-ref="uvm_swap_alloc" data-ref-filename="uvm_swap_alloc">uvm_swap_alloc</a>(&amp;<a class="local col2 ref" href="#22npages" title='npages' data-ref="22npages" data-ref-filename="22npages">npages</a>, <a class="macro" href="../sys/stdbool.h.html#39" title="1" data-ref="_M/true">true</a>);</td></tr>
<tr><th id="479">479</th><td>	<b>if</b> (<a class="local col1 ref" href="#21slot" title='slot' data-ref="21slot" data-ref-filename="21slot">slot</a> == <var>0</var>) {</td></tr>
<tr><th id="480">480</th><td>		<b>return</b> <a class="macro" href="../sys/errno.h.html#54" title="12" data-ref="_M/ENOMEM">ENOMEM</a>;</td></tr>
<tr><th id="481">481</th><td>	}</td></tr>
<tr><th id="482">482</th><td>	<a class="local col0 ref" href="#20swc" title='swc' data-ref="20swc" data-ref-filename="20swc">swc</a>-&gt;<a class="tu ref field" href="#swapcluster::swc_slot" title='swapcluster::swc_slot' data-use='w' data-ref="swapcluster::swc_slot" data-ref-filename="swapcluster..swc_slot">swc_slot</a> = <a class="local col1 ref" href="#21slot" title='slot' data-ref="21slot" data-ref-filename="21slot">slot</a>;</td></tr>
<tr><th id="483">483</th><td>	<a class="local col0 ref" href="#20swc" title='swc' data-ref="20swc" data-ref-filename="20swc">swc</a>-&gt;<a class="tu ref field" href="#swapcluster::swc_nallocated" title='swapcluster::swc_nallocated' data-use='w' data-ref="swapcluster::swc_nallocated" data-ref-filename="swapcluster..swc_nallocated">swc_nallocated</a> = <a class="local col2 ref" href="#22npages" title='npages' data-ref="22npages" data-ref-filename="22npages">npages</a>;</td></tr>
<tr><th id="484">484</th><td>	<a class="local col0 ref" href="#20swc" title='swc' data-ref="20swc" data-ref-filename="20swc">swc</a>-&gt;<a class="tu ref field" href="#swapcluster::swc_nused" title='swapcluster::swc_nused' data-use='w' data-ref="swapcluster::swc_nused" data-ref-filename="swapcluster..swc_nused">swc_nused</a> = <var>0</var>;</td></tr>
<tr><th id="485">485</th><td></td></tr>
<tr><th id="486">486</th><td>	<b>return</b> <var>0</var>;</td></tr>
<tr><th id="487">487</th><td>}</td></tr>
<tr><th id="488">488</th><td></td></tr>
<tr><th id="489">489</th><td><em>static</em> <em>int</em></td></tr>
<tr><th id="490">490</th><td><dfn class="tu decl def fn" id="swapcluster_add" title='swapcluster_add' data-type='int swapcluster_add(struct swapcluster * swc, struct vm_page * pg)' data-ref="swapcluster_add" data-ref-filename="swapcluster_add">swapcluster_add</dfn>(<b>struct</b> <a class="type" href="#swapcluster" title='swapcluster' data-ref="swapcluster" data-ref-filename="swapcluster">swapcluster</a> *<dfn class="local col3 decl" id="23swc" title='swc' data-type='struct swapcluster *' data-ref="23swc" data-ref-filename="23swc">swc</dfn>, <b>struct</b> <a class="type" href="uvm_page.h.html#vm_page" title='vm_page' data-ref="vm_page" data-ref-filename="vm_page">vm_page</a> *<dfn class="local col4 decl" id="24pg" title='pg' data-type='struct vm_page *' data-ref="24pg" data-ref-filename="24pg">pg</dfn>)</td></tr>
<tr><th id="491">491</th><td>{</td></tr>
<tr><th id="492">492</th><td>	<em>int</em> <dfn class="local col5 decl" id="25slot" title='slot' data-type='int' data-ref="25slot" data-ref-filename="25slot">slot</dfn>;</td></tr>
<tr><th id="493">493</th><td>	<b>struct</b> <a class="type" href="uvm_object.h.html#uvm_object" title='uvm_object' data-ref="uvm_object" data-ref-filename="uvm_object">uvm_object</a> *<dfn class="local col6 decl" id="26uobj" title='uobj' data-type='struct uvm_object *' data-ref="26uobj" data-ref-filename="26uobj">uobj</dfn>;</td></tr>
<tr><th id="494">494</th><td></td></tr>
<tr><th id="495">495</th><td>	<a class="macro" href="../lib/libkern/libkern.h.html#279" title="(__builtin_expect(((swc-&gt;swc_slot != 0)) != 0, 1) ? (void)0 : kern_assert(&quot;kernel %sassertion \&quot;%s\&quot; failed: file \&quot;%s\&quot;, line %d &quot;, &quot;diagnostic &quot;, &quot;swc-&gt;swc_slot != 0&quot;, &quot;/___NETBSD_SRC___/objdir.amd64/sys/arch/amd64/compile/GENERIC/../../../../../../sys/uvm/uvm_pdaemon.c&quot;, 495))" data-ref="_M/KASSERT">KASSERT</a>(<a class="local col3 ref" href="#23swc" title='swc' data-ref="23swc" data-ref-filename="23swc">swc</a>-&gt;<a class="tu ref field" href="#swapcluster::swc_slot" title='swapcluster::swc_slot' data-use='r' data-ref="swapcluster::swc_slot" data-ref-filename="swapcluster..swc_slot">swc_slot</a> != <var>0</var>);</td></tr>
<tr><th id="496">496</th><td>	<a class="macro" href="../lib/libkern/libkern.h.html#279" title="(__builtin_expect(((swc-&gt;swc_nused &lt; swc-&gt;swc_nallocated)) != 0, 1) ? (void)0 : kern_assert(&quot;kernel %sassertion \&quot;%s\&quot; failed: file \&quot;%s\&quot;, line %d &quot;, &quot;diagnostic &quot;, &quot;swc-&gt;swc_nused &lt; swc-&gt;swc_nallocated&quot;, &quot;/___NETBSD_SRC___/objdir.amd64/sys/arch/amd64/compile/GENERIC/../../../../../../sys/uvm/uvm_pdaemon.c&quot;, 496))" data-ref="_M/KASSERT">KASSERT</a>(<a class="local col3 ref" href="#23swc" title='swc' data-ref="23swc" data-ref-filename="23swc">swc</a>-&gt;<a class="tu ref field" href="#swapcluster::swc_nused" title='swapcluster::swc_nused' data-use='r' data-ref="swapcluster::swc_nused" data-ref-filename="swapcluster..swc_nused">swc_nused</a> &lt; <a class="local col3 ref" href="#23swc" title='swc' data-ref="23swc" data-ref-filename="23swc">swc</a>-&gt;<a class="tu ref field" href="#swapcluster::swc_nallocated" title='swapcluster::swc_nallocated' data-use='r' data-ref="swapcluster::swc_nallocated" data-ref-filename="swapcluster..swc_nallocated">swc_nallocated</a>);</td></tr>
<tr><th id="497">497</th><td>	<a class="macro" href="../lib/libkern/libkern.h.html#279" title="(__builtin_expect((((pg-&gt;pqflags &amp; (0x0002|0x0004)) != 0)) != 0, 1) ? (void)0 : kern_assert(&quot;kernel %sassertion \&quot;%s\&quot; failed: file \&quot;%s\&quot;, line %d &quot;, &quot;diagnostic &quot;, &quot;(pg-&gt;pqflags &amp; PQ_SWAPBACKED) != 0&quot;, &quot;/___NETBSD_SRC___/objdir.amd64/sys/arch/amd64/compile/GENERIC/../../../../../../sys/uvm/uvm_pdaemon.c&quot;, 497))" data-ref="_M/KASSERT">KASSERT</a>((<a class="local col4 ref" href="#24pg" title='pg' data-ref="24pg" data-ref-filename="24pg">pg</a>-&gt;<a class="ref field" href="uvm_page.h.html#vm_page::pqflags" title='vm_page::pqflags' data-ref="vm_page::pqflags" data-ref-filename="vm_page..pqflags">pqflags</a> &amp; <a class="macro" href="uvm_page.h.html#263" title="(0x0002|0x0004)" data-ref="_M/PQ_SWAPBACKED">PQ_SWAPBACKED</a>) != <var>0</var>);</td></tr>
<tr><th id="498">498</th><td></td></tr>
<tr><th id="499">499</th><td>	<a class="local col5 ref" href="#25slot" title='slot' data-ref="25slot" data-ref-filename="25slot">slot</a> = <a class="local col3 ref" href="#23swc" title='swc' data-ref="23swc" data-ref-filename="23swc">swc</a>-&gt;<a class="tu ref field" href="#swapcluster::swc_slot" title='swapcluster::swc_slot' data-use='r' data-ref="swapcluster::swc_slot" data-ref-filename="swapcluster..swc_slot">swc_slot</a> + <a class="local col3 ref" href="#23swc" title='swc' data-ref="23swc" data-ref-filename="23swc">swc</a>-&gt;<a class="tu ref field" href="#swapcluster::swc_nused" title='swapcluster::swc_nused' data-use='r' data-ref="swapcluster::swc_nused" data-ref-filename="swapcluster..swc_nused">swc_nused</a>;</td></tr>
<tr><th id="500">500</th><td>	<a class="local col6 ref" href="#26uobj" title='uobj' data-ref="26uobj" data-ref-filename="26uobj">uobj</a> = <a class="local col4 ref" href="#24pg" title='pg' data-ref="24pg" data-ref-filename="24pg">pg</a>-&gt;<a class="ref field" href="uvm_page.h.html#vm_page::uobject" title='vm_page::uobject' data-ref="vm_page::uobject" data-ref-filename="vm_page..uobject">uobject</a>;</td></tr>
<tr><th id="501">501</th><td>	<b>if</b> (<a class="local col6 ref" href="#26uobj" title='uobj' data-ref="26uobj" data-ref-filename="26uobj">uobj</a> == <a class="macro" href="../sys/null.h.html#13" title="((void *)0)" data-ref="_M/NULL">NULL</a>) {</td></tr>
<tr><th id="502">502</th><td>		<a class="macro" href="../lib/libkern/libkern.h.html#279" title="(__builtin_expect(((mutex_owned(pg-&gt;uanon-&gt;an_lock))) != 0, 1) ? (void)0 : kern_assert(&quot;kernel %sassertion \&quot;%s\&quot; failed: file \&quot;%s\&quot;, line %d &quot;, &quot;diagnostic &quot;, &quot;mutex_owned(pg-&gt;uanon-&gt;an_lock)&quot;, &quot;/___NETBSD_SRC___/objdir.amd64/sys/arch/amd64/compile/GENERIC/../../../../../../sys/uvm/uvm_pdaemon.c&quot;, 502))" data-ref="_M/KASSERT">KASSERT</a>(<a class="ref fn" href="../sys/mutex.h.html#mutex_owned" title='mutex_owned' data-ref="mutex_owned" data-ref-filename="mutex_owned">mutex_owned</a>(<a class="local col4 ref" href="#24pg" title='pg' data-ref="24pg" data-ref-filename="24pg">pg</a>-&gt;<a class="ref field" href="uvm_page.h.html#vm_page::uanon" title='vm_page::uanon' data-ref="vm_page::uanon" data-ref-filename="vm_page..uanon">uanon</a>-&gt;<a class="ref field" href="uvm_anon.h.html#vm_anon::an_lock" title='vm_anon::an_lock' data-ref="vm_anon::an_lock" data-ref-filename="vm_anon..an_lock">an_lock</a>));</td></tr>
<tr><th id="503">503</th><td>		<a class="local col4 ref" href="#24pg" title='pg' data-ref="24pg" data-ref-filename="24pg">pg</a>-&gt;<a class="ref field" href="uvm_page.h.html#vm_page::uanon" title='vm_page::uanon' data-ref="vm_page::uanon" data-ref-filename="vm_page..uanon">uanon</a>-&gt;<a class="ref field" href="uvm_anon.h.html#vm_anon::an_swslot" title='vm_anon::an_swslot' data-ref="vm_anon::an_swslot" data-ref-filename="vm_anon..an_swslot">an_swslot</a> = <a class="local col5 ref" href="#25slot" title='slot' data-ref="25slot" data-ref-filename="25slot">slot</a>;</td></tr>
<tr><th id="504">504</th><td>	} <b>else</b> {</td></tr>
<tr><th id="505">505</th><td>		<em>int</em> <dfn class="local col7 decl" id="27result" title='result' data-type='int' data-ref="27result" data-ref-filename="27result">result</dfn>;</td></tr>
<tr><th id="506">506</th><td></td></tr>
<tr><th id="507">507</th><td>		<a class="macro" href="../lib/libkern/libkern.h.html#279" title="(__builtin_expect(((mutex_owned(uobj-&gt;vmobjlock))) != 0, 1) ? (void)0 : kern_assert(&quot;kernel %sassertion \&quot;%s\&quot; failed: file \&quot;%s\&quot;, line %d &quot;, &quot;diagnostic &quot;, &quot;mutex_owned(uobj-&gt;vmobjlock)&quot;, &quot;/___NETBSD_SRC___/objdir.amd64/sys/arch/amd64/compile/GENERIC/../../../../../../sys/uvm/uvm_pdaemon.c&quot;, 507))" data-ref="_M/KASSERT">KASSERT</a>(<a class="ref fn" href="../sys/mutex.h.html#mutex_owned" title='mutex_owned' data-ref="mutex_owned" data-ref-filename="mutex_owned">mutex_owned</a>(<a class="local col6 ref" href="#26uobj" title='uobj' data-ref="26uobj" data-ref-filename="26uobj">uobj</a>-&gt;<a class="ref field" href="uvm_object.h.html#uvm_object::vmobjlock" title='uvm_object::vmobjlock' data-ref="uvm_object::vmobjlock" data-ref-filename="uvm_object..vmobjlock">vmobjlock</a>));</td></tr>
<tr><th id="508">508</th><td>		<a class="local col7 ref" href="#27result" title='result' data-ref="27result" data-ref-filename="27result">result</a> = <a class="ref fn" href="uvm_aobj.h.html#uao_set_swslot" title='uao_set_swslot' data-ref="uao_set_swslot" data-ref-filename="uao_set_swslot">uao_set_swslot</a>(<a class="local col6 ref" href="#26uobj" title='uobj' data-ref="26uobj" data-ref-filename="26uobj">uobj</a>, <a class="local col4 ref" href="#24pg" title='pg' data-ref="24pg" data-ref-filename="24pg">pg</a>-&gt;<a class="ref field" href="uvm_page.h.html#vm_page::offset" title='vm_page::offset' data-ref="vm_page::offset" data-ref-filename="vm_page..offset">offset</a> &gt;&gt; <a class="macro" href="../arch/amd64/include/vmparam.h.html#55" title="12" data-ref="_M/PAGE_SHIFT">PAGE_SHIFT</a>, <a class="local col5 ref" href="#25slot" title='slot' data-ref="25slot" data-ref-filename="25slot">slot</a>);</td></tr>
<tr><th id="509">509</th><td>		<b>if</b> (<a class="local col7 ref" href="#27result" title='result' data-ref="27result" data-ref-filename="27result">result</a> == -<var>1</var>) {</td></tr>
<tr><th id="510">510</th><td>			<b>return</b> <a class="macro" href="../sys/errno.h.html#54" title="12" data-ref="_M/ENOMEM">ENOMEM</a>;</td></tr>
<tr><th id="511">511</th><td>		}</td></tr>
<tr><th id="512">512</th><td>	}</td></tr>
<tr><th id="513">513</th><td>	<a class="local col3 ref" href="#23swc" title='swc' data-ref="23swc" data-ref-filename="23swc">swc</a>-&gt;<a class="tu ref field" href="#swapcluster::swc_pages" title='swapcluster::swc_pages' data-use='w' data-ref="swapcluster::swc_pages" data-ref-filename="swapcluster..swc_pages">swc_pages</a>[<a class="local col3 ref" href="#23swc" title='swc' data-ref="23swc" data-ref-filename="23swc">swc</a>-&gt;<a class="tu ref field" href="#swapcluster::swc_nused" title='swapcluster::swc_nused' data-use='r' data-ref="swapcluster::swc_nused" data-ref-filename="swapcluster..swc_nused">swc_nused</a>] = <a class="local col4 ref" href="#24pg" title='pg' data-ref="24pg" data-ref-filename="24pg">pg</a>;</td></tr>
<tr><th id="514">514</th><td>	<a class="local col3 ref" href="#23swc" title='swc' data-ref="23swc" data-ref-filename="23swc">swc</a>-&gt;<a class="tu ref field" href="#swapcluster::swc_nused" title='swapcluster::swc_nused' data-use='w' data-ref="swapcluster::swc_nused" data-ref-filename="swapcluster..swc_nused">swc_nused</a>++;</td></tr>
<tr><th id="515">515</th><td></td></tr>
<tr><th id="516">516</th><td>	<b>return</b> <var>0</var>;</td></tr>
<tr><th id="517">517</th><td>}</td></tr>
<tr><th id="518">518</th><td></td></tr>
<tr><th id="519">519</th><td><em>static</em> <em>void</em></td></tr>
<tr><th id="520">520</th><td><dfn class="tu decl def fn" id="swapcluster_flush" title='swapcluster_flush' data-type='void swapcluster_flush(struct swapcluster * swc, _Bool now)' data-ref="swapcluster_flush" data-ref-filename="swapcluster_flush">swapcluster_flush</dfn>(<b>struct</b> <a class="type" href="#swapcluster" title='swapcluster' data-ref="swapcluster" data-ref-filename="swapcluster">swapcluster</a> *<dfn class="local col8 decl" id="28swc" title='swc' data-type='struct swapcluster *' data-ref="28swc" data-ref-filename="28swc">swc</dfn>, <a class="macro" href="../sys/stdbool.h.html#37" title="_Bool" data-ref="_M/bool">bool</a> <dfn class="local col9 decl" id="29now" title='now' data-type='_Bool' data-ref="29now" data-ref-filename="29now">now</dfn>)</td></tr>
<tr><th id="521">521</th><td>{</td></tr>
<tr><th id="522">522</th><td>	<em>int</em> <dfn class="local col0 decl" id="30slot" title='slot' data-type='int' data-ref="30slot" data-ref-filename="30slot">slot</dfn>;</td></tr>
<tr><th id="523">523</th><td>	<em>int</em> <dfn class="local col1 decl" id="31nused" title='nused' data-type='int' data-ref="31nused" data-ref-filename="31nused">nused</dfn>;</td></tr>
<tr><th id="524">524</th><td>	<em>int</em> <dfn class="local col2 decl" id="32nallocated" title='nallocated' data-type='int' data-ref="32nallocated" data-ref-filename="32nallocated">nallocated</dfn>;</td></tr>
<tr><th id="525">525</th><td>	<em>int</em> <dfn class="local col3 decl" id="33error" title='error' data-type='int' data-ref="33error" data-ref-filename="33error">error</dfn> <a class="macro" href="../sys/cdefs.h.html#283" title="" data-ref="_M/__diagused">__diagused</a>;</td></tr>
<tr><th id="526">526</th><td></td></tr>
<tr><th id="527">527</th><td>	<b>if</b> (<a class="local col8 ref" href="#28swc" title='swc' data-ref="28swc" data-ref-filename="28swc">swc</a>-&gt;<a class="tu ref field" href="#swapcluster::swc_slot" title='swapcluster::swc_slot' data-use='r' data-ref="swapcluster::swc_slot" data-ref-filename="swapcluster..swc_slot">swc_slot</a> == <var>0</var>) {</td></tr>
<tr><th id="528">528</th><td>		<b>return</b>;</td></tr>
<tr><th id="529">529</th><td>	}</td></tr>
<tr><th id="530">530</th><td>	<a class="macro" href="../lib/libkern/libkern.h.html#279" title="(__builtin_expect(((swc-&gt;swc_nused &lt;= swc-&gt;swc_nallocated)) != 0, 1) ? (void)0 : kern_assert(&quot;kernel %sassertion \&quot;%s\&quot; failed: file \&quot;%s\&quot;, line %d &quot;, &quot;diagnostic &quot;, &quot;swc-&gt;swc_nused &lt;= swc-&gt;swc_nallocated&quot;, &quot;/___NETBSD_SRC___/objdir.amd64/sys/arch/amd64/compile/GENERIC/../../../../../../sys/uvm/uvm_pdaemon.c&quot;, 530))" data-ref="_M/KASSERT">KASSERT</a>(<a class="local col8 ref" href="#28swc" title='swc' data-ref="28swc" data-ref-filename="28swc">swc</a>-&gt;<a class="tu ref field" href="#swapcluster::swc_nused" title='swapcluster::swc_nused' data-use='r' data-ref="swapcluster::swc_nused" data-ref-filename="swapcluster..swc_nused">swc_nused</a> &lt;= <a class="local col8 ref" href="#28swc" title='swc' data-ref="28swc" data-ref-filename="28swc">swc</a>-&gt;<a class="tu ref field" href="#swapcluster::swc_nallocated" title='swapcluster::swc_nallocated' data-use='r' data-ref="swapcluster::swc_nallocated" data-ref-filename="swapcluster..swc_nallocated">swc_nallocated</a>);</td></tr>
<tr><th id="531">531</th><td></td></tr>
<tr><th id="532">532</th><td>	<a class="local col0 ref" href="#30slot" title='slot' data-ref="30slot" data-ref-filename="30slot">slot</a> = <a class="local col8 ref" href="#28swc" title='swc' data-ref="28swc" data-ref-filename="28swc">swc</a>-&gt;<a class="tu ref field" href="#swapcluster::swc_slot" title='swapcluster::swc_slot' data-use='r' data-ref="swapcluster::swc_slot" data-ref-filename="swapcluster..swc_slot">swc_slot</a>;</td></tr>
<tr><th id="533">533</th><td>	<a class="local col1 ref" href="#31nused" title='nused' data-ref="31nused" data-ref-filename="31nused">nused</a> = <a class="local col8 ref" href="#28swc" title='swc' data-ref="28swc" data-ref-filename="28swc">swc</a>-&gt;<a class="tu ref field" href="#swapcluster::swc_nused" title='swapcluster::swc_nused' data-use='r' data-ref="swapcluster::swc_nused" data-ref-filename="swapcluster..swc_nused">swc_nused</a>;</td></tr>
<tr><th id="534">534</th><td>	<a class="local col2 ref" href="#32nallocated" title='nallocated' data-ref="32nallocated" data-ref-filename="32nallocated">nallocated</a> = <a class="local col8 ref" href="#28swc" title='swc' data-ref="28swc" data-ref-filename="28swc">swc</a>-&gt;<a class="tu ref field" href="#swapcluster::swc_nallocated" title='swapcluster::swc_nallocated' data-use='r' data-ref="swapcluster::swc_nallocated" data-ref-filename="swapcluster..swc_nallocated">swc_nallocated</a>;</td></tr>
<tr><th id="535">535</th><td></td></tr>
<tr><th id="536">536</th><td>	<i>/*</i></td></tr>
<tr><th id="537">537</th><td><i>	 * if this is the final pageout we could have a few</i></td></tr>
<tr><th id="538">538</th><td><i>	 * unused swap blocks.  if so, free them now.</i></td></tr>
<tr><th id="539">539</th><td><i>	 */</i></td></tr>
<tr><th id="540">540</th><td></td></tr>
<tr><th id="541">541</th><td>	<b>if</b> (<a class="local col1 ref" href="#31nused" title='nused' data-ref="31nused" data-ref-filename="31nused">nused</a> &lt; <a class="local col2 ref" href="#32nallocated" title='nallocated' data-ref="32nallocated" data-ref-filename="32nallocated">nallocated</a>) {</td></tr>
<tr><th id="542">542</th><td>		<b>if</b> (!<a class="local col9 ref" href="#29now" title='now' data-ref="29now" data-ref-filename="29now">now</a>) {</td></tr>
<tr><th id="543">543</th><td>			<b>return</b>;</td></tr>
<tr><th id="544">544</th><td>		}</td></tr>
<tr><th id="545">545</th><td>		<a class="ref fn" href="uvm_swap.h.html#uvm_swap_free" title='uvm_swap_free' data-ref="uvm_swap_free" data-ref-filename="uvm_swap_free">uvm_swap_free</a>(<a class="local col0 ref" href="#30slot" title='slot' data-ref="30slot" data-ref-filename="30slot">slot</a> + <a class="local col1 ref" href="#31nused" title='nused' data-ref="31nused" data-ref-filename="31nused">nused</a>, <a class="local col2 ref" href="#32nallocated" title='nallocated' data-ref="32nallocated" data-ref-filename="32nallocated">nallocated</a> - <a class="local col1 ref" href="#31nused" title='nused' data-ref="31nused" data-ref-filename="31nused">nused</a>);</td></tr>
<tr><th id="546">546</th><td>	}</td></tr>
<tr><th id="547">547</th><td></td></tr>
<tr><th id="548">548</th><td>	<i>/*</i></td></tr>
<tr><th id="549">549</th><td><i>	 * now start the pageout.</i></td></tr>
<tr><th id="550">550</th><td><i>	 */</i></td></tr>
<tr><th id="551">551</th><td></td></tr>
<tr><th id="552">552</th><td>	<b>if</b> (<a class="local col1 ref" href="#31nused" title='nused' data-ref="31nused" data-ref-filename="31nused">nused</a> &gt; <var>0</var>) {</td></tr>
<tr><th id="553">553</th><td>		<a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::pdpageouts" title='uvmexp::pdpageouts' data-ref="uvmexp::pdpageouts" data-ref-filename="uvmexp..pdpageouts">pdpageouts</a>++;</td></tr>
<tr><th id="554">554</th><td>		<a class="ref fn" href="#uvm_pageout_start" title='uvm_pageout_start' data-ref="uvm_pageout_start" data-ref-filename="uvm_pageout_start">uvm_pageout_start</a>(<a class="local col1 ref" href="#31nused" title='nused' data-ref="31nused" data-ref-filename="31nused">nused</a>);</td></tr>
<tr><th id="555">555</th><td>		<a class="local col3 ref" href="#33error" title='error' data-ref="33error" data-ref-filename="33error">error</a> = <a class="ref fn" href="uvm_swap.h.html#uvm_swap_put" title='uvm_swap_put' data-ref="uvm_swap_put" data-ref-filename="uvm_swap_put">uvm_swap_put</a>(<a class="local col0 ref" href="#30slot" title='slot' data-ref="30slot" data-ref-filename="30slot">slot</a>, <a class="local col8 ref" href="#28swc" title='swc' data-ref="28swc" data-ref-filename="28swc">swc</a>-&gt;<a class="tu ref field" href="#swapcluster::swc_pages" title='swapcluster::swc_pages' data-use='r' data-ref="swapcluster::swc_pages" data-ref-filename="swapcluster..swc_pages">swc_pages</a>, <a class="local col1 ref" href="#31nused" title='nused' data-ref="31nused" data-ref-filename="31nused">nused</a>, <var>0</var>);</td></tr>
<tr><th id="556">556</th><td>		<a class="macro" href="../lib/libkern/libkern.h.html#279" title="(__builtin_expect(((error == 0 || error == 12)) != 0, 1) ? (void)0 : kern_assert(&quot;kernel %sassertion \&quot;%s\&quot; failed: file \&quot;%s\&quot;, line %d &quot;, &quot;diagnostic &quot;, &quot;error == 0 || error == ENOMEM&quot;, &quot;/___NETBSD_SRC___/objdir.amd64/sys/arch/amd64/compile/GENERIC/../../../../../../sys/uvm/uvm_pdaemon.c&quot;, 556))" data-ref="_M/KASSERT">KASSERT</a>(<a class="local col3 ref" href="#33error" title='error' data-ref="33error" data-ref-filename="33error">error</a> == <var>0</var> || <a class="local col3 ref" href="#33error" title='error' data-ref="33error" data-ref-filename="33error">error</a> == <a class="macro" href="../sys/errno.h.html#54" title="12" data-ref="_M/ENOMEM">ENOMEM</a>);</td></tr>
<tr><th id="557">557</th><td>	}</td></tr>
<tr><th id="558">558</th><td></td></tr>
<tr><th id="559">559</th><td>	<i>/*</i></td></tr>
<tr><th id="560">560</th><td><i>	 * zero swslot to indicate that we are</i></td></tr>
<tr><th id="561">561</th><td><i>	 * no longer building a swap-backed cluster.</i></td></tr>
<tr><th id="562">562</th><td><i>	 */</i></td></tr>
<tr><th id="563">563</th><td></td></tr>
<tr><th id="564">564</th><td>	<a class="local col8 ref" href="#28swc" title='swc' data-ref="28swc" data-ref-filename="28swc">swc</a>-&gt;<a class="tu ref field" href="#swapcluster::swc_slot" title='swapcluster::swc_slot' data-use='w' data-ref="swapcluster::swc_slot" data-ref-filename="swapcluster..swc_slot">swc_slot</a> = <var>0</var>;</td></tr>
<tr><th id="565">565</th><td>	<a class="local col8 ref" href="#28swc" title='swc' data-ref="28swc" data-ref-filename="28swc">swc</a>-&gt;<a class="tu ref field" href="#swapcluster::swc_nused" title='swapcluster::swc_nused' data-use='w' data-ref="swapcluster::swc_nused" data-ref-filename="swapcluster..swc_nused">swc_nused</a> = <var>0</var>;</td></tr>
<tr><th id="566">566</th><td>}</td></tr>
<tr><th id="567">567</th><td></td></tr>
<tr><th id="568">568</th><td><em>static</em> <em>int</em></td></tr>
<tr><th id="569">569</th><td><dfn class="tu decl def fn" id="swapcluster_nused" title='swapcluster_nused' data-type='int swapcluster_nused(struct swapcluster * swc)' data-ref="swapcluster_nused" data-ref-filename="swapcluster_nused">swapcluster_nused</dfn>(<b>struct</b> <a class="type" href="#swapcluster" title='swapcluster' data-ref="swapcluster" data-ref-filename="swapcluster">swapcluster</a> *<dfn class="local col4 decl" id="34swc" title='swc' data-type='struct swapcluster *' data-ref="34swc" data-ref-filename="34swc">swc</dfn>)</td></tr>
<tr><th id="570">570</th><td>{</td></tr>
<tr><th id="571">571</th><td></td></tr>
<tr><th id="572">572</th><td>	<b>return</b> <a class="local col4 ref" href="#34swc" title='swc' data-ref="34swc" data-ref-filename="34swc">swc</a>-&gt;<a class="tu ref field" href="#swapcluster::swc_nused" title='swapcluster::swc_nused' data-use='r' data-ref="swapcluster::swc_nused" data-ref-filename="swapcluster..swc_nused">swc_nused</a>;</td></tr>
<tr><th id="573">573</th><td>}</td></tr>
<tr><th id="574">574</th><td></td></tr>
<tr><th id="575">575</th><td><i  data-doc="uvmpd_dropswap">/*</i></td></tr>
<tr><th id="576">576</th><td><i  data-doc="uvmpd_dropswap"> * uvmpd_dropswap: free any swap allocated to this page.</i></td></tr>
<tr><th id="577">577</th><td><i  data-doc="uvmpd_dropswap"> *</i></td></tr>
<tr><th id="578">578</th><td><i  data-doc="uvmpd_dropswap"> * =&gt; called with owner locked.</i></td></tr>
<tr><th id="579">579</th><td><i  data-doc="uvmpd_dropswap"> * =&gt; return true if a page had an associated slot.</i></td></tr>
<tr><th id="580">580</th><td><i  data-doc="uvmpd_dropswap"> */</i></td></tr>
<tr><th id="581">581</th><td></td></tr>
<tr><th id="582">582</th><td><em>static</em> <a class="macro" href="../sys/stdbool.h.html#37" title="_Bool" data-ref="_M/bool">bool</a></td></tr>
<tr><th id="583">583</th><td><dfn class="tu decl def fn" id="uvmpd_dropswap" title='uvmpd_dropswap' data-type='_Bool uvmpd_dropswap(struct vm_page * pg)' data-ref="uvmpd_dropswap" data-ref-filename="uvmpd_dropswap">uvmpd_dropswap</dfn>(<b>struct</b> <a class="type" href="uvm_page.h.html#vm_page" title='vm_page' data-ref="vm_page" data-ref-filename="vm_page">vm_page</a> *<dfn class="local col5 decl" id="35pg" title='pg' data-type='struct vm_page *' data-ref="35pg" data-ref-filename="35pg">pg</dfn>)</td></tr>
<tr><th id="584">584</th><td>{</td></tr>
<tr><th id="585">585</th><td>	<a class="macro" href="../sys/stdbool.h.html#37" title="_Bool" data-ref="_M/bool">bool</a> <dfn class="local col6 decl" id="36result" title='result' data-type='_Bool' data-ref="36result" data-ref-filename="36result">result</dfn> = <a class="macro" href="../sys/stdbool.h.html#40" title="0" data-ref="_M/false">false</a>;</td></tr>
<tr><th id="586">586</th><td>	<b>struct</b> <a class="type" href="uvm_anon.h.html#vm_anon" title='vm_anon' data-ref="vm_anon" data-ref-filename="vm_anon">vm_anon</a> *<dfn class="local col7 decl" id="37anon" title='anon' data-type='struct vm_anon *' data-ref="37anon" data-ref-filename="37anon">anon</dfn> = <a class="local col5 ref" href="#35pg" title='pg' data-ref="35pg" data-ref-filename="35pg">pg</a>-&gt;<a class="ref field" href="uvm_page.h.html#vm_page::uanon" title='vm_page::uanon' data-ref="vm_page::uanon" data-ref-filename="vm_page..uanon">uanon</a>;</td></tr>
<tr><th id="587">587</th><td></td></tr>
<tr><th id="588">588</th><td>	<b>if</b> ((<a class="local col5 ref" href="#35pg" title='pg' data-ref="35pg" data-ref-filename="35pg">pg</a>-&gt;<a class="ref field" href="uvm_page.h.html#vm_page::pqflags" title='vm_page::pqflags' data-ref="vm_page::pqflags" data-ref-filename="vm_page..pqflags">pqflags</a> &amp; <a class="macro" href="uvm_page.h.html#259" title="0x0002" data-ref="_M/PQ_ANON">PQ_ANON</a>) &amp;&amp; <a class="local col7 ref" href="#37anon" title='anon' data-ref="37anon" data-ref-filename="37anon">anon</a>-&gt;<a class="ref field" href="uvm_anon.h.html#vm_anon::an_swslot" title='vm_anon::an_swslot' data-ref="vm_anon::an_swslot" data-ref-filename="vm_anon..an_swslot">an_swslot</a>) {</td></tr>
<tr><th id="589">589</th><td>		<a class="ref fn" href="uvm_swap.h.html#uvm_swap_free" title='uvm_swap_free' data-ref="uvm_swap_free" data-ref-filename="uvm_swap_free">uvm_swap_free</a>(<a class="local col7 ref" href="#37anon" title='anon' data-ref="37anon" data-ref-filename="37anon">anon</a>-&gt;<a class="ref field" href="uvm_anon.h.html#vm_anon::an_swslot" title='vm_anon::an_swslot' data-ref="vm_anon::an_swslot" data-ref-filename="vm_anon..an_swslot">an_swslot</a>, <var>1</var>);</td></tr>
<tr><th id="590">590</th><td>		<a class="local col7 ref" href="#37anon" title='anon' data-ref="37anon" data-ref-filename="37anon">anon</a>-&gt;<a class="ref field" href="uvm_anon.h.html#vm_anon::an_swslot" title='vm_anon::an_swslot' data-ref="vm_anon::an_swslot" data-ref-filename="vm_anon..an_swslot">an_swslot</a> = <var>0</var>;</td></tr>
<tr><th id="591">591</th><td>		<a class="local col5 ref" href="#35pg" title='pg' data-ref="35pg" data-ref-filename="35pg">pg</a>-&gt;<a class="ref field" href="uvm_page.h.html#vm_page::flags" title='vm_page::flags' data-ref="vm_page::flags" data-ref-filename="vm_page..flags">flags</a> &amp;= ~<a class="macro" href="uvm_page.h.html#244" title="0x0008" data-ref="_M/PG_CLEAN">PG_CLEAN</a>;</td></tr>
<tr><th id="592">592</th><td>		<a class="local col6 ref" href="#36result" title='result' data-ref="36result" data-ref-filename="36result">result</a> = <a class="macro" href="../sys/stdbool.h.html#39" title="1" data-ref="_M/true">true</a>;</td></tr>
<tr><th id="593">593</th><td>	} <b>else</b> <b>if</b> (<a class="local col5 ref" href="#35pg" title='pg' data-ref="35pg" data-ref-filename="35pg">pg</a>-&gt;<a class="ref field" href="uvm_page.h.html#vm_page::pqflags" title='vm_page::pqflags' data-ref="vm_page::pqflags" data-ref-filename="vm_page..pqflags">pqflags</a> &amp; <a class="macro" href="uvm_page.h.html#261" title="0x0004" data-ref="_M/PQ_AOBJ">PQ_AOBJ</a>) {</td></tr>
<tr><th id="594">594</th><td>		<em>int</em> <dfn class="local col8 decl" id="38slot" title='slot' data-type='int' data-ref="38slot" data-ref-filename="38slot">slot</dfn> = <a class="ref fn" href="uvm_aobj.h.html#uao_set_swslot" title='uao_set_swslot' data-ref="uao_set_swslot" data-ref-filename="uao_set_swslot">uao_set_swslot</a>(<a class="local col5 ref" href="#35pg" title='pg' data-ref="35pg" data-ref-filename="35pg">pg</a>-&gt;<a class="ref field" href="uvm_page.h.html#vm_page::uobject" title='vm_page::uobject' data-ref="vm_page::uobject" data-ref-filename="vm_page..uobject">uobject</a>,</td></tr>
<tr><th id="595">595</th><td>		    <a class="local col5 ref" href="#35pg" title='pg' data-ref="35pg" data-ref-filename="35pg">pg</a>-&gt;<a class="ref field" href="uvm_page.h.html#vm_page::offset" title='vm_page::offset' data-ref="vm_page::offset" data-ref-filename="vm_page..offset">offset</a> &gt;&gt; <a class="macro" href="../arch/amd64/include/vmparam.h.html#55" title="12" data-ref="_M/PAGE_SHIFT">PAGE_SHIFT</a>, <var>0</var>);</td></tr>
<tr><th id="596">596</th><td>		<b>if</b> (<a class="local col8 ref" href="#38slot" title='slot' data-ref="38slot" data-ref-filename="38slot">slot</a>) {</td></tr>
<tr><th id="597">597</th><td>			<a class="ref fn" href="uvm_swap.h.html#uvm_swap_free" title='uvm_swap_free' data-ref="uvm_swap_free" data-ref-filename="uvm_swap_free">uvm_swap_free</a>(<a class="local col8 ref" href="#38slot" title='slot' data-ref="38slot" data-ref-filename="38slot">slot</a>, <var>1</var>);</td></tr>
<tr><th id="598">598</th><td>			<a class="local col5 ref" href="#35pg" title='pg' data-ref="35pg" data-ref-filename="35pg">pg</a>-&gt;<a class="ref field" href="uvm_page.h.html#vm_page::flags" title='vm_page::flags' data-ref="vm_page::flags" data-ref-filename="vm_page..flags">flags</a> &amp;= ~<a class="macro" href="uvm_page.h.html#244" title="0x0008" data-ref="_M/PG_CLEAN">PG_CLEAN</a>;</td></tr>
<tr><th id="599">599</th><td>			<a class="local col6 ref" href="#36result" title='result' data-ref="36result" data-ref-filename="36result">result</a> = <a class="macro" href="../sys/stdbool.h.html#39" title="1" data-ref="_M/true">true</a>;</td></tr>
<tr><th id="600">600</th><td>		}</td></tr>
<tr><th id="601">601</th><td>	}</td></tr>
<tr><th id="602">602</th><td></td></tr>
<tr><th id="603">603</th><td>	<b>return</b> <a class="local col6 ref" href="#36result" title='result' data-ref="36result" data-ref-filename="36result">result</a>;</td></tr>
<tr><th id="604">604</th><td>}</td></tr>
<tr><th id="605">605</th><td></td></tr>
<tr><th id="606">606</th><td><i>/*</i></td></tr>
<tr><th id="607">607</th><td><i> * uvmpd_trydropswap: try to free any swap allocated to this page.</i></td></tr>
<tr><th id="608">608</th><td><i> *</i></td></tr>
<tr><th id="609">609</th><td><i> * =&gt; return true if a slot is successfully freed.</i></td></tr>
<tr><th id="610">610</th><td><i> */</i></td></tr>
<tr><th id="611">611</th><td></td></tr>
<tr><th id="612">612</th><td><a class="macro" href="../sys/stdbool.h.html#37" title="_Bool" data-ref="_M/bool">bool</a></td></tr>
<tr><th id="613">613</th><td><dfn class="decl def fn" id="uvmpd_trydropswap" title='uvmpd_trydropswap' data-ref="uvmpd_trydropswap" data-ref-filename="uvmpd_trydropswap">uvmpd_trydropswap</dfn>(<b>struct</b> <a class="type" href="uvm_page.h.html#vm_page" title='vm_page' data-ref="vm_page" data-ref-filename="vm_page">vm_page</a> *<dfn class="local col9 decl" id="39pg" title='pg' data-type='struct vm_page *' data-ref="39pg" data-ref-filename="39pg">pg</dfn>)</td></tr>
<tr><th id="614">614</th><td>{</td></tr>
<tr><th id="615">615</th><td>	<a class="typedef" href="../sys/mutex.h.html#kmutex_t" title='kmutex_t' data-type='struct kmutex' data-ref="kmutex_t" data-ref-filename="kmutex_t">kmutex_t</a> *<dfn class="local col0 decl" id="40slock" title='slock' data-type='kmutex_t *' data-ref="40slock" data-ref-filename="40slock">slock</dfn>;</td></tr>
<tr><th id="616">616</th><td>	<a class="macro" href="../sys/stdbool.h.html#37" title="_Bool" data-ref="_M/bool">bool</a> <dfn class="local col1 decl" id="41result" title='result' data-type='_Bool' data-ref="41result" data-ref-filename="41result">result</dfn>;</td></tr>
<tr><th id="617">617</th><td></td></tr>
<tr><th id="618">618</th><td>	<b>if</b> ((<a class="local col9 ref" href="#39pg" title='pg' data-ref="39pg" data-ref-filename="39pg">pg</a>-&gt;<a class="ref field" href="uvm_page.h.html#vm_page::flags" title='vm_page::flags' data-ref="vm_page::flags" data-ref-filename="vm_page..flags">flags</a> &amp; <a class="macro" href="uvm_page.h.html#241" title="0x0001" data-ref="_M/PG_BUSY">PG_BUSY</a>) != <var>0</var>) {</td></tr>
<tr><th id="619">619</th><td>		<b>return</b> <a class="macro" href="../sys/stdbool.h.html#40" title="0" data-ref="_M/false">false</a>;</td></tr>
<tr><th id="620">620</th><td>	}</td></tr>
<tr><th id="621">621</th><td></td></tr>
<tr><th id="622">622</th><td>	<i>/*</i></td></tr>
<tr><th id="623">623</th><td><i>	 * lock the page's owner.</i></td></tr>
<tr><th id="624">624</th><td><i>	 */</i></td></tr>
<tr><th id="625">625</th><td></td></tr>
<tr><th id="626">626</th><td>	<a class="local col0 ref" href="#40slock" title='slock' data-ref="40slock" data-ref-filename="40slock">slock</a> = <a class="ref fn" href="#uvmpd_trylockowner" title='uvmpd_trylockowner' data-ref="uvmpd_trylockowner" data-ref-filename="uvmpd_trylockowner">uvmpd_trylockowner</a>(<a class="local col9 ref" href="#39pg" title='pg' data-ref="39pg" data-ref-filename="39pg">pg</a>);</td></tr>
<tr><th id="627">627</th><td>	<b>if</b> (<a class="local col0 ref" href="#40slock" title='slock' data-ref="40slock" data-ref-filename="40slock">slock</a> == <a class="macro" href="../sys/null.h.html#13" title="((void *)0)" data-ref="_M/NULL">NULL</a>) {</td></tr>
<tr><th id="628">628</th><td>		<b>return</b> <a class="macro" href="../sys/stdbool.h.html#40" title="0" data-ref="_M/false">false</a>;</td></tr>
<tr><th id="629">629</th><td>	}</td></tr>
<tr><th id="630">630</th><td></td></tr>
<tr><th id="631">631</th><td>	<i>/*</i></td></tr>
<tr><th id="632">632</th><td><i>	 * skip this page if it's busy.</i></td></tr>
<tr><th id="633">633</th><td><i>	 */</i></td></tr>
<tr><th id="634">634</th><td></td></tr>
<tr><th id="635">635</th><td>	<b>if</b> ((<a class="local col9 ref" href="#39pg" title='pg' data-ref="39pg" data-ref-filename="39pg">pg</a>-&gt;<a class="ref field" href="uvm_page.h.html#vm_page::flags" title='vm_page::flags' data-ref="vm_page::flags" data-ref-filename="vm_page..flags">flags</a> &amp; <a class="macro" href="uvm_page.h.html#241" title="0x0001" data-ref="_M/PG_BUSY">PG_BUSY</a>) != <var>0</var>) {</td></tr>
<tr><th id="636">636</th><td>		<a class="ref fn" href="../sys/mutex.h.html#mutex_exit" title='mutex_exit' data-ref="mutex_exit" data-ref-filename="mutex_exit">mutex_exit</a>(<a class="local col0 ref" href="#40slock" title='slock' data-ref="40slock" data-ref-filename="40slock">slock</a>);</td></tr>
<tr><th id="637">637</th><td>		<b>return</b> <a class="macro" href="../sys/stdbool.h.html#40" title="0" data-ref="_M/false">false</a>;</td></tr>
<tr><th id="638">638</th><td>	}</td></tr>
<tr><th id="639">639</th><td></td></tr>
<tr><th id="640">640</th><td>	<a class="local col1 ref" href="#41result" title='result' data-ref="41result" data-ref-filename="41result">result</a> = <a class="tu ref fn" href="#uvmpd_dropswap" title='uvmpd_dropswap' data-use='c' data-ref="uvmpd_dropswap" data-ref-filename="uvmpd_dropswap">uvmpd_dropswap</a>(<a class="local col9 ref" href="#39pg" title='pg' data-ref="39pg" data-ref-filename="39pg">pg</a>);</td></tr>
<tr><th id="641">641</th><td></td></tr>
<tr><th id="642">642</th><td>	<a class="ref fn" href="../sys/mutex.h.html#mutex_exit" title='mutex_exit' data-ref="mutex_exit" data-ref-filename="mutex_exit">mutex_exit</a>(<a class="local col0 ref" href="#40slock" title='slock' data-ref="40slock" data-ref-filename="40slock">slock</a>);</td></tr>
<tr><th id="643">643</th><td></td></tr>
<tr><th id="644">644</th><td>	<b>return</b> <a class="local col1 ref" href="#41result" title='result' data-ref="41result" data-ref-filename="41result">result</a>;</td></tr>
<tr><th id="645">645</th><td>}</td></tr>
<tr><th id="646">646</th><td></td></tr>
<tr><th id="647">647</th><td><u>#<span data-ppcond="449">endif</span> /* defined(VMSWAP) */</u></td></tr>
<tr><th id="648">648</th><td></td></tr>
<tr><th id="649">649</th><td><i  data-doc="uvmpd_scan_queue">/*</i></td></tr>
<tr><th id="650">650</th><td><i  data-doc="uvmpd_scan_queue"> * uvmpd_scan_queue: scan an replace candidate list for pages</i></td></tr>
<tr><th id="651">651</th><td><i  data-doc="uvmpd_scan_queue"> * to clean or free.</i></td></tr>
<tr><th id="652">652</th><td><i  data-doc="uvmpd_scan_queue"> *</i></td></tr>
<tr><th id="653">653</th><td><i  data-doc="uvmpd_scan_queue"> * =&gt; called with page queues locked</i></td></tr>
<tr><th id="654">654</th><td><i  data-doc="uvmpd_scan_queue"> * =&gt; we work on meeting our free target by converting inactive pages</i></td></tr>
<tr><th id="655">655</th><td><i  data-doc="uvmpd_scan_queue"> *    into free pages.</i></td></tr>
<tr><th id="656">656</th><td><i  data-doc="uvmpd_scan_queue"> * =&gt; we handle the building of swap-backed clusters</i></td></tr>
<tr><th id="657">657</th><td><i  data-doc="uvmpd_scan_queue"> */</i></td></tr>
<tr><th id="658">658</th><td></td></tr>
<tr><th id="659">659</th><td><em>static</em> <em>void</em></td></tr>
<tr><th id="660">660</th><td><dfn class="tu decl def fn" id="uvmpd_scan_queue" title='uvmpd_scan_queue' data-type='void uvmpd_scan_queue()' data-ref="uvmpd_scan_queue" data-ref-filename="uvmpd_scan_queue">uvmpd_scan_queue</dfn>(<em>void</em>)</td></tr>
<tr><th id="661">661</th><td>{</td></tr>
<tr><th id="662">662</th><td>	<b>struct</b> <a class="type" href="uvm_page.h.html#vm_page" title='vm_page' data-ref="vm_page" data-ref-filename="vm_page">vm_page</a> *<dfn class="local col2 decl" id="42p" title='p' data-type='struct vm_page *' data-ref="42p" data-ref-filename="42p">p</dfn>;</td></tr>
<tr><th id="663">663</th><td>	<b>struct</b> <a class="type" href="uvm_object.h.html#uvm_object" title='uvm_object' data-ref="uvm_object" data-ref-filename="uvm_object">uvm_object</a> *<dfn class="local col3 decl" id="43uobj" title='uobj' data-type='struct uvm_object *' data-ref="43uobj" data-ref-filename="43uobj">uobj</dfn>;</td></tr>
<tr><th id="664">664</th><td>	<b>struct</b> <a class="type" href="uvm_anon.h.html#vm_anon" title='vm_anon' data-ref="vm_anon" data-ref-filename="vm_anon">vm_anon</a> *<dfn class="local col4 decl" id="44anon" title='anon' data-type='struct vm_anon *' data-ref="44anon" data-ref-filename="44anon">anon</dfn>;</td></tr>
<tr><th id="665">665</th><td><u>#<span data-ppcond="665">if</span> defined(<a class="macro" href="../../objdir.amd64/sys/arch/amd64/compile/GENERIC/opt_vmswap.h.html#1" data-ref="_M/VMSWAP">VMSWAP</a>)</u></td></tr>
<tr><th id="666">666</th><td>	<b>struct</b> <a class="type" href="#swapcluster" title='swapcluster' data-ref="swapcluster" data-ref-filename="swapcluster">swapcluster</a> <dfn class="local col5 decl" id="45swc" title='swc' data-type='struct swapcluster' data-ref="45swc" data-ref-filename="45swc">swc</dfn>;</td></tr>
<tr><th id="667">667</th><td><u>#<span data-ppcond="665">endif</span> /* defined(VMSWAP) */</u></td></tr>
<tr><th id="668">668</th><td>	<em>int</em> <dfn class="local col6 decl" id="46dirtyreacts" title='dirtyreacts' data-type='int' data-ref="46dirtyreacts" data-ref-filename="46dirtyreacts">dirtyreacts</dfn>;</td></tr>
<tr><th id="669">669</th><td>	<em>int</em> <dfn class="local col7 decl" id="47lockownerfail" title='lockownerfail' data-type='int' data-ref="47lockownerfail" data-ref-filename="47lockownerfail">lockownerfail</dfn>;</td></tr>
<tr><th id="670">670</th><td>	<a class="typedef" href="../sys/mutex.h.html#kmutex_t" title='kmutex_t' data-type='struct kmutex' data-ref="kmutex_t" data-ref-filename="kmutex_t">kmutex_t</a> *<dfn class="local col8 decl" id="48slock" title='slock' data-type='kmutex_t *' data-ref="48slock" data-ref-filename="48slock">slock</dfn>;</td></tr>
<tr><th id="671">671</th><td>	<a class="macro" href="uvm_stat.h.html#74" title="" data-ref="_M/UVMHIST_FUNC">UVMHIST_FUNC</a>(<q>"uvmpd_scan_queue"</q>); <a class="macro" href="uvm_stat.h.html#73" title="" data-ref="_M/UVMHIST_CALLED">UVMHIST_CALLED</a>(pdhist);</td></tr>
<tr><th id="672">672</th><td></td></tr>
<tr><th id="673">673</th><td>	<i>/*</i></td></tr>
<tr><th id="674">674</th><td><i>	 * swslot is non-zero if we are building a swap cluster.  we want</i></td></tr>
<tr><th id="675">675</th><td><i>	 * to stay in the loop while we have a page to scan or we have</i></td></tr>
<tr><th id="676">676</th><td><i>	 * a swap-cluster to build.</i></td></tr>
<tr><th id="677">677</th><td><i>	 */</i></td></tr>
<tr><th id="678">678</th><td></td></tr>
<tr><th id="679">679</th><td><u>#<span data-ppcond="679">if</span> defined(<a class="macro" href="../../objdir.amd64/sys/arch/amd64/compile/GENERIC/opt_vmswap.h.html#1" data-ref="_M/VMSWAP">VMSWAP</a>)</u></td></tr>
<tr><th id="680">680</th><td>	<a class="tu ref fn" href="#swapcluster_init" title='swapcluster_init' data-use='c' data-ref="swapcluster_init" data-ref-filename="swapcluster_init">swapcluster_init</a>(&amp;<a class="local col5 ref" href="#45swc" title='swc' data-ref="45swc" data-ref-filename="45swc">swc</a>);</td></tr>
<tr><th id="681">681</th><td><u>#<span data-ppcond="679">endif</span> /* defined(VMSWAP) */</u></td></tr>
<tr><th id="682">682</th><td></td></tr>
<tr><th id="683">683</th><td>	<a class="local col6 ref" href="#46dirtyreacts" title='dirtyreacts' data-ref="46dirtyreacts" data-ref-filename="46dirtyreacts">dirtyreacts</a> = <var>0</var>;</td></tr>
<tr><th id="684">684</th><td>	<a class="local col7 ref" href="#47lockownerfail" title='lockownerfail' data-ref="47lockownerfail" data-ref-filename="47lockownerfail">lockownerfail</a> = <var>0</var>;</td></tr>
<tr><th id="685">685</th><td>	<a class="ref fn" href="uvm_pdpolicy.h.html#uvmpdpol_scaninit" title='uvmpdpol_scaninit' data-ref="uvmpdpol_scaninit" data-ref-filename="uvmpdpol_scaninit">uvmpdpol_scaninit</a>();</td></tr>
<tr><th id="686">686</th><td></td></tr>
<tr><th id="687">687</th><td>	<b>while</b> (<i>/* CONSTCOND */</i> <var>1</var>) {</td></tr>
<tr><th id="688">688</th><td></td></tr>
<tr><th id="689">689</th><td>		<i>/*</i></td></tr>
<tr><th id="690">690</th><td><i>		 * see if we've met the free target.</i></td></tr>
<tr><th id="691">691</th><td><i>		 */</i></td></tr>
<tr><th id="692">692</th><td></td></tr>
<tr><th id="693">693</th><td>		<b>if</b> (<a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::free" title='uvmexp::free' data-ref="uvmexp::free" data-ref-filename="uvmexp..free">free</a> + <a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::paging" title='uvmexp::paging' data-ref="uvmexp::paging" data-ref-filename="uvmexp..paging">paging</a></td></tr>
<tr><th id="694">694</th><td><u>#<span data-ppcond="694">if</span> defined(<a class="macro" href="../../objdir.amd64/sys/arch/amd64/compile/GENERIC/opt_vmswap.h.html#1" data-ref="_M/VMSWAP">VMSWAP</a>)</u></td></tr>
<tr><th id="695">695</th><td>		    + <a class="tu ref fn" href="#swapcluster_nused" title='swapcluster_nused' data-use='c' data-ref="swapcluster_nused" data-ref-filename="swapcluster_nused">swapcluster_nused</a>(&amp;<a class="local col5 ref" href="#45swc" title='swc' data-ref="45swc" data-ref-filename="45swc">swc</a>)</td></tr>
<tr><th id="696">696</th><td><u>#<span data-ppcond="694">endif</span> /* defined(VMSWAP) */</u></td></tr>
<tr><th id="697">697</th><td>		    &gt;= <a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::freetarg" title='uvmexp::freetarg' data-ref="uvmexp::freetarg" data-ref-filename="uvmexp..freetarg">freetarg</a> &lt;&lt; <var>2</var> ||</td></tr>
<tr><th id="698">698</th><td>		    <a class="local col6 ref" href="#46dirtyreacts" title='dirtyreacts' data-ref="46dirtyreacts" data-ref-filename="46dirtyreacts">dirtyreacts</a> == <a class="macro" href="#98" title="16" data-ref="_M/UVMPD_NUMDIRTYREACTS">UVMPD_NUMDIRTYREACTS</a>) {</td></tr>
<tr><th id="699">699</th><td>			<a class="macro" href="uvm_stat.h.html#72" title="" data-ref="_M/UVMHIST_LOG">UVMHIST_LOG</a>(pdhist,<q>"  met free target: "</q></td></tr>
<tr><th id="700">700</th><td>				    <q>"exit loop"</q>, <var>0</var>, <var>0</var>, <var>0</var>, <var>0</var>);</td></tr>
<tr><th id="701">701</th><td>			<b>break</b>;</td></tr>
<tr><th id="702">702</th><td>		}</td></tr>
<tr><th id="703">703</th><td></td></tr>
<tr><th id="704">704</th><td>		<a class="local col2 ref" href="#42p" title='p' data-ref="42p" data-ref-filename="42p">p</a> = <a class="ref fn" href="uvm_pdpolicy.h.html#uvmpdpol_selectvictim" title='uvmpdpol_selectvictim' data-ref="uvmpdpol_selectvictim" data-ref-filename="uvmpdpol_selectvictim">uvmpdpol_selectvictim</a>();</td></tr>
<tr><th id="705">705</th><td>		<b>if</b> (<a class="local col2 ref" href="#42p" title='p' data-ref="42p" data-ref-filename="42p">p</a> == <a class="macro" href="../sys/null.h.html#13" title="((void *)0)" data-ref="_M/NULL">NULL</a>) {</td></tr>
<tr><th id="706">706</th><td>			<b>break</b>;</td></tr>
<tr><th id="707">707</th><td>		}</td></tr>
<tr><th id="708">708</th><td>		<a class="macro" href="../lib/libkern/libkern.h.html#279" title="(__builtin_expect(((uvmpdpol_pageisqueued_p(p))) != 0, 1) ? (void)0 : kern_assert(&quot;kernel %sassertion \&quot;%s\&quot; failed: file \&quot;%s\&quot;, line %d &quot;, &quot;diagnostic &quot;, &quot;uvmpdpol_pageisqueued_p(p)&quot;, &quot;/___NETBSD_SRC___/objdir.amd64/sys/arch/amd64/compile/GENERIC/../../../../../../sys/uvm/uvm_pdaemon.c&quot;, 708))" data-ref="_M/KASSERT">KASSERT</a>(<a class="ref fn" href="uvm_pdpolicy.h.html#uvmpdpol_pageisqueued_p" title='uvmpdpol_pageisqueued_p' data-ref="uvmpdpol_pageisqueued_p" data-ref-filename="uvmpdpol_pageisqueued_p">uvmpdpol_pageisqueued_p</a>(<a class="local col2 ref" href="#42p" title='p' data-ref="42p" data-ref-filename="42p">p</a>));</td></tr>
<tr><th id="709">709</th><td>		<a class="macro" href="../lib/libkern/libkern.h.html#279" title="(__builtin_expect(((p-&gt;wire_count == 0)) != 0, 1) ? (void)0 : kern_assert(&quot;kernel %sassertion \&quot;%s\&quot; failed: file \&quot;%s\&quot;, line %d &quot;, &quot;diagnostic &quot;, &quot;p-&gt;wire_count == 0&quot;, &quot;/___NETBSD_SRC___/objdir.amd64/sys/arch/amd64/compile/GENERIC/../../../../../../sys/uvm/uvm_pdaemon.c&quot;, 709))" data-ref="_M/KASSERT">KASSERT</a>(<a class="local col2 ref" href="#42p" title='p' data-ref="42p" data-ref-filename="42p">p</a>-&gt;<a class="ref field" href="uvm_page.h.html#vm_page::wire_count" title='vm_page::wire_count' data-ref="vm_page::wire_count" data-ref-filename="vm_page..wire_count">wire_count</a> == <var>0</var>);</td></tr>
<tr><th id="710">710</th><td></td></tr>
<tr><th id="711">711</th><td>		<i>/*</i></td></tr>
<tr><th id="712">712</th><td><i>		 * we are below target and have a new page to consider.</i></td></tr>
<tr><th id="713">713</th><td><i>		 */</i></td></tr>
<tr><th id="714">714</th><td></td></tr>
<tr><th id="715">715</th><td>		<a class="local col4 ref" href="#44anon" title='anon' data-ref="44anon" data-ref-filename="44anon">anon</a> = <a class="local col2 ref" href="#42p" title='p' data-ref="42p" data-ref-filename="42p">p</a>-&gt;<a class="ref field" href="uvm_page.h.html#vm_page::uanon" title='vm_page::uanon' data-ref="vm_page::uanon" data-ref-filename="vm_page..uanon">uanon</a>;</td></tr>
<tr><th id="716">716</th><td>		<a class="local col3 ref" href="#43uobj" title='uobj' data-ref="43uobj" data-ref-filename="43uobj">uobj</a> = <a class="local col2 ref" href="#42p" title='p' data-ref="42p" data-ref-filename="42p">p</a>-&gt;<a class="ref field" href="uvm_page.h.html#vm_page::uobject" title='vm_page::uobject' data-ref="vm_page::uobject" data-ref-filename="vm_page..uobject">uobject</a>;</td></tr>
<tr><th id="717">717</th><td></td></tr>
<tr><th id="718">718</th><td>		<i>/*</i></td></tr>
<tr><th id="719">719</th><td><i>		 * first we attempt to lock the object that this page</i></td></tr>
<tr><th id="720">720</th><td><i>		 * belongs to.  if our attempt fails we skip on to</i></td></tr>
<tr><th id="721">721</th><td><i>		 * the next page (no harm done).  it is important to</i></td></tr>
<tr><th id="722">722</th><td><i>		 * "try" locking the object as we are locking in the</i></td></tr>
<tr><th id="723">723</th><td><i>		 * wrong order (pageq -&gt; object) and we don't want to</i></td></tr>
<tr><th id="724">724</th><td><i>		 * deadlock.</i></td></tr>
<tr><th id="725">725</th><td><i>		 *</i></td></tr>
<tr><th id="726">726</th><td><i>		 * the only time we expect to see an ownerless page</i></td></tr>
<tr><th id="727">727</th><td><i>		 * (i.e. a page with no uobject and !PQ_ANON) is if an</i></td></tr>
<tr><th id="728">728</th><td><i>		 * anon has loaned a page from a uvm_object and the</i></td></tr>
<tr><th id="729">729</th><td><i>		 * uvm_object has dropped the ownership.  in that</i></td></tr>
<tr><th id="730">730</th><td><i>		 * case, the anon can "take over" the loaned page</i></td></tr>
<tr><th id="731">731</th><td><i>		 * and make it its own.</i></td></tr>
<tr><th id="732">732</th><td><i>		 */</i></td></tr>
<tr><th id="733">733</th><td></td></tr>
<tr><th id="734">734</th><td>		<a class="local col8 ref" href="#48slock" title='slock' data-ref="48slock" data-ref-filename="48slock">slock</a> = <a class="ref fn" href="#uvmpd_trylockowner" title='uvmpd_trylockowner' data-ref="uvmpd_trylockowner" data-ref-filename="uvmpd_trylockowner">uvmpd_trylockowner</a>(<a class="local col2 ref" href="#42p" title='p' data-ref="42p" data-ref-filename="42p">p</a>);</td></tr>
<tr><th id="735">735</th><td>		<b>if</b> (<a class="local col8 ref" href="#48slock" title='slock' data-ref="48slock" data-ref-filename="48slock">slock</a> == <a class="macro" href="../sys/null.h.html#13" title="((void *)0)" data-ref="_M/NULL">NULL</a>) {</td></tr>
<tr><th id="736">736</th><td>			<i>/*</i></td></tr>
<tr><th id="737">737</th><td><i>			 * yield cpu to make a chance for an LWP holding</i></td></tr>
<tr><th id="738">738</th><td><i>			 * the lock run.  otherwise we can busy-loop too long</i></td></tr>
<tr><th id="739">739</th><td><i>			 * if the page queue is filled with a lot of pages</i></td></tr>
<tr><th id="740">740</th><td><i>			 * from few objects.</i></td></tr>
<tr><th id="741">741</th><td><i>			 */</i></td></tr>
<tr><th id="742">742</th><td>			<a class="local col7 ref" href="#47lockownerfail" title='lockownerfail' data-ref="47lockownerfail" data-ref-filename="47lockownerfail">lockownerfail</a>++;</td></tr>
<tr><th id="743">743</th><td>			<b>if</b> (<a class="local col7 ref" href="#47lockownerfail" title='lockownerfail' data-ref="47lockownerfail" data-ref-filename="47lockownerfail">lockownerfail</a> &gt; <a class="macro" href="#100" title="16" data-ref="_M/UVMPD_NUMTRYLOCKOWNER">UVMPD_NUMTRYLOCKOWNER</a>) {</td></tr>
<tr><th id="744">744</th><td>				<a class="ref fn" href="../sys/mutex.h.html#mutex_exit" title='mutex_exit' data-ref="mutex_exit" data-ref-filename="mutex_exit">mutex_exit</a>(&amp;<a class="ref" href="uvm.h.html#uvm_pageqlock" title='uvm_pageqlock' data-ref="uvm_pageqlock" data-ref-filename="uvm_pageqlock">uvm_pageqlock</a>);</td></tr>
<tr><th id="745">745</th><td>				<i>/* XXX Better than yielding but inadequate. */</i></td></tr>
<tr><th id="746">746</th><td>				<a class="ref fn" href="../sys/proc.h.html#kpause" title='kpause' data-ref="kpause" data-ref-filename="kpause">kpause</a>(<q>"livelock"</q>, <a class="macro" href="../sys/stdbool.h.html#40" title="0" data-ref="_M/false">false</a>, <var>1</var>, <a class="macro" href="../sys/null.h.html#13" title="((void *)0)" data-ref="_M/NULL">NULL</a>);</td></tr>
<tr><th id="747">747</th><td>				<a class="ref fn" href="../sys/mutex.h.html#mutex_enter" title='mutex_enter' data-ref="mutex_enter" data-ref-filename="mutex_enter">mutex_enter</a>(&amp;<a class="ref" href="uvm.h.html#uvm_pageqlock" title='uvm_pageqlock' data-ref="uvm_pageqlock" data-ref-filename="uvm_pageqlock">uvm_pageqlock</a>);</td></tr>
<tr><th id="748">748</th><td>				<a class="local col7 ref" href="#47lockownerfail" title='lockownerfail' data-ref="47lockownerfail" data-ref-filename="47lockownerfail">lockownerfail</a> = <var>0</var>;</td></tr>
<tr><th id="749">749</th><td>			}</td></tr>
<tr><th id="750">750</th><td>			<b>continue</b>;</td></tr>
<tr><th id="751">751</th><td>		}</td></tr>
<tr><th id="752">752</th><td>		<b>if</b> (<a class="local col2 ref" href="#42p" title='p' data-ref="42p" data-ref-filename="42p">p</a>-&gt;<a class="ref field" href="uvm_page.h.html#vm_page::flags" title='vm_page::flags' data-ref="vm_page::flags" data-ref-filename="vm_page..flags">flags</a> &amp; <a class="macro" href="uvm_page.h.html#241" title="0x0001" data-ref="_M/PG_BUSY">PG_BUSY</a>) {</td></tr>
<tr><th id="753">753</th><td>			<a class="ref fn" href="../sys/mutex.h.html#mutex_exit" title='mutex_exit' data-ref="mutex_exit" data-ref-filename="mutex_exit">mutex_exit</a>(<a class="local col8 ref" href="#48slock" title='slock' data-ref="48slock" data-ref-filename="48slock">slock</a>);</td></tr>
<tr><th id="754">754</th><td>			<a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::pdbusy" title='uvmexp::pdbusy' data-ref="uvmexp::pdbusy" data-ref-filename="uvmexp..pdbusy">pdbusy</a>++;</td></tr>
<tr><th id="755">755</th><td>			<b>continue</b>;</td></tr>
<tr><th id="756">756</th><td>		}</td></tr>
<tr><th id="757">757</th><td></td></tr>
<tr><th id="758">758</th><td>		<i>/* does the page belong to an object? */</i></td></tr>
<tr><th id="759">759</th><td>		<b>if</b> (<a class="local col3 ref" href="#43uobj" title='uobj' data-ref="43uobj" data-ref-filename="43uobj">uobj</a> != <a class="macro" href="../sys/null.h.html#13" title="((void *)0)" data-ref="_M/NULL">NULL</a>) {</td></tr>
<tr><th id="760">760</th><td>			<a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::pdobscan" title='uvmexp::pdobscan' data-ref="uvmexp::pdobscan" data-ref-filename="uvmexp..pdobscan">pdobscan</a>++;</td></tr>
<tr><th id="761">761</th><td>		} <b>else</b> {</td></tr>
<tr><th id="762">762</th><td><u>#<span data-ppcond="762">if</span> defined(<a class="macro" href="../../objdir.amd64/sys/arch/amd64/compile/GENERIC/opt_vmswap.h.html#1" data-ref="_M/VMSWAP">VMSWAP</a>)</u></td></tr>
<tr><th id="763">763</th><td>			<a class="macro" href="../lib/libkern/libkern.h.html#279" title="(__builtin_expect(((anon != ((void *)0))) != 0, 1) ? (void)0 : kern_assert(&quot;kernel %sassertion \&quot;%s\&quot; failed: file \&quot;%s\&quot;, line %d &quot;, &quot;diagnostic &quot;, &quot;anon != NULL&quot;, &quot;/___NETBSD_SRC___/objdir.amd64/sys/arch/amd64/compile/GENERIC/../../../../../../sys/uvm/uvm_pdaemon.c&quot;, 763))" data-ref="_M/KASSERT">KASSERT</a>(<a class="local col4 ref" href="#44anon" title='anon' data-ref="44anon" data-ref-filename="44anon">anon</a> != <a class="macro" href="../sys/null.h.html#13" title="((void *)0)" data-ref="_M/NULL">NULL</a>);</td></tr>
<tr><th id="764">764</th><td>			<a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::pdanscan" title='uvmexp::pdanscan' data-ref="uvmexp::pdanscan" data-ref-filename="uvmexp..pdanscan">pdanscan</a>++;</td></tr>
<tr><th id="765">765</th><td><u>#<span data-ppcond="762">else</span> /* defined(VMSWAP) */</u></td></tr>
<tr><th id="766">766</th><td>			panic(<q>"%s: anon"</q>, <b>__func__</b>);</td></tr>
<tr><th id="767">767</th><td><u>#<span data-ppcond="762">endif</span> /* defined(VMSWAP) */</u></td></tr>
<tr><th id="768">768</th><td>		}</td></tr>
<tr><th id="769">769</th><td></td></tr>
<tr><th id="770">770</th><td></td></tr>
<tr><th id="771">771</th><td>		<i>/*</i></td></tr>
<tr><th id="772">772</th><td><i>		 * we now have the object and the page queues locked.</i></td></tr>
<tr><th id="773">773</th><td><i>		 * if the page is not swap-backed, call the object's</i></td></tr>
<tr><th id="774">774</th><td><i>		 * pager to flush and free the page.</i></td></tr>
<tr><th id="775">775</th><td><i>		 */</i></td></tr>
<tr><th id="776">776</th><td></td></tr>
<tr><th id="777">777</th><td><u>#<span data-ppcond="777">if</span> defined(<span class="macro" data-ref="_M/READAHEAD_STATS">READAHEAD_STATS</span>)</u></td></tr>
<tr><th id="778">778</th><td>		<b>if</b> ((p-&gt;pqflags &amp; PQ_READAHEAD) != <var>0</var>) {</td></tr>
<tr><th id="779">779</th><td>			p-&gt;pqflags &amp;= ~PQ_READAHEAD;</td></tr>
<tr><th id="780">780</th><td>			uvm_ra_miss.ev_count++;</td></tr>
<tr><th id="781">781</th><td>		}</td></tr>
<tr><th id="782">782</th><td><u>#<span data-ppcond="777">endif</span> /* defined(READAHEAD_STATS) */</u></td></tr>
<tr><th id="783">783</th><td></td></tr>
<tr><th id="784">784</th><td>		<b>if</b> ((<a class="local col2 ref" href="#42p" title='p' data-ref="42p" data-ref-filename="42p">p</a>-&gt;<a class="ref field" href="uvm_page.h.html#vm_page::pqflags" title='vm_page::pqflags' data-ref="vm_page::pqflags" data-ref-filename="vm_page..pqflags">pqflags</a> &amp; <a class="macro" href="uvm_page.h.html#263" title="(0x0002|0x0004)" data-ref="_M/PQ_SWAPBACKED">PQ_SWAPBACKED</a>) == <var>0</var>) {</td></tr>
<tr><th id="785">785</th><td>			<a class="macro" href="../lib/libkern/libkern.h.html#279" title="(__builtin_expect(((uobj != ((void *)0))) != 0, 1) ? (void)0 : kern_assert(&quot;kernel %sassertion \&quot;%s\&quot; failed: file \&quot;%s\&quot;, line %d &quot;, &quot;diagnostic &quot;, &quot;uobj != NULL&quot;, &quot;/___NETBSD_SRC___/objdir.amd64/sys/arch/amd64/compile/GENERIC/../../../../../../sys/uvm/uvm_pdaemon.c&quot;, 785))" data-ref="_M/KASSERT">KASSERT</a>(<a class="local col3 ref" href="#43uobj" title='uobj' data-ref="43uobj" data-ref-filename="43uobj">uobj</a> != <a class="macro" href="../sys/null.h.html#13" title="((void *)0)" data-ref="_M/NULL">NULL</a>);</td></tr>
<tr><th id="786">786</th><td>			<a class="ref fn" href="../sys/mutex.h.html#mutex_exit" title='mutex_exit' data-ref="mutex_exit" data-ref-filename="mutex_exit">mutex_exit</a>(&amp;<a class="ref" href="uvm.h.html#uvm_pageqlock" title='uvm_pageqlock' data-ref="uvm_pageqlock" data-ref-filename="uvm_pageqlock">uvm_pageqlock</a>);</td></tr>
<tr><th id="787">787</th><td>			(<em>void</em>) (<a class="local col3 ref" href="#43uobj" title='uobj' data-ref="43uobj" data-ref-filename="43uobj">uobj</a>-&gt;<a class="ref field" href="uvm_object.h.html#uvm_object::pgops" title='uvm_object::pgops' data-ref="uvm_object::pgops" data-ref-filename="uvm_object..pgops">pgops</a>-&gt;<a class="ref field" href="uvm_pager.h.html#uvm_pagerops::pgo_put" title='uvm_pagerops::pgo_put' data-ref="uvm_pagerops::pgo_put" data-ref-filename="uvm_pagerops..pgo_put">pgo_put</a>)(<a class="local col3 ref" href="#43uobj" title='uobj' data-ref="43uobj" data-ref-filename="43uobj">uobj</a>, <a class="local col2 ref" href="#42p" title='p' data-ref="42p" data-ref-filename="42p">p</a>-&gt;<a class="ref field" href="uvm_page.h.html#vm_page::offset" title='vm_page::offset' data-ref="vm_page::offset" data-ref-filename="vm_page..offset">offset</a>,</td></tr>
<tr><th id="788">788</th><td>			    <a class="local col2 ref" href="#42p" title='p' data-ref="42p" data-ref-filename="42p">p</a>-&gt;<a class="ref field" href="uvm_page.h.html#vm_page::offset" title='vm_page::offset' data-ref="vm_page::offset" data-ref-filename="vm_page..offset">offset</a> + <a class="macro" href="../arch/amd64/include/vmparam.h.html#56" title="(1 &lt;&lt; 12)" data-ref="_M/PAGE_SIZE">PAGE_SIZE</a>, <a class="macro" href="uvm_pager.h.html#142" title="0x001" data-ref="_M/PGO_CLEANIT">PGO_CLEANIT</a>|<a class="macro" href="uvm_pager.h.html#145" title="0x008" data-ref="_M/PGO_FREE">PGO_FREE</a>);</td></tr>
<tr><th id="789">789</th><td>			<a class="ref fn" href="../sys/mutex.h.html#mutex_enter" title='mutex_enter' data-ref="mutex_enter" data-ref-filename="mutex_enter">mutex_enter</a>(&amp;<a class="ref" href="uvm.h.html#uvm_pageqlock" title='uvm_pageqlock' data-ref="uvm_pageqlock" data-ref-filename="uvm_pageqlock">uvm_pageqlock</a>);</td></tr>
<tr><th id="790">790</th><td>			<b>continue</b>;</td></tr>
<tr><th id="791">791</th><td>		}</td></tr>
<tr><th id="792">792</th><td></td></tr>
<tr><th id="793">793</th><td>		<i>/*</i></td></tr>
<tr><th id="794">794</th><td><i>		 * the page is swap-backed.  remove all the permissions</i></td></tr>
<tr><th id="795">795</th><td><i>		 * from the page so we can sync the modified info</i></td></tr>
<tr><th id="796">796</th><td><i>		 * without any race conditions.  if the page is clean</i></td></tr>
<tr><th id="797">797</th><td><i>		 * we can free it now and continue.</i></td></tr>
<tr><th id="798">798</th><td><i>		 */</i></td></tr>
<tr><th id="799">799</th><td></td></tr>
<tr><th id="800">800</th><td>		<a class="ref fn" href="../arch/x86/include/pmap.h.html#pmap_page_protect" title='pmap_page_protect' data-ref="pmap_page_protect" data-ref-filename="pmap_page_protect">pmap_page_protect</a>(<a class="local col2 ref" href="#42p" title='p' data-ref="42p" data-ref-filename="42p">p</a>, <a class="macro" href="uvm_prot.h.html#82" title="((vm_prot_t) 0x00)" data-ref="_M/VM_PROT_NONE">VM_PROT_NONE</a>);</td></tr>
<tr><th id="801">801</th><td>		<b>if</b> ((<a class="local col2 ref" href="#42p" title='p' data-ref="42p" data-ref-filename="42p">p</a>-&gt;<a class="ref field" href="uvm_page.h.html#vm_page::flags" title='vm_page::flags' data-ref="vm_page::flags" data-ref-filename="vm_page..flags">flags</a> &amp; <a class="macro" href="uvm_page.h.html#244" title="0x0008" data-ref="_M/PG_CLEAN">PG_CLEAN</a>) &amp;&amp; <a class="macro" href="../arch/x86/include/pmap.h.html#329" title="pmap_clear_attrs(p, 0x01)" data-ref="_M/pmap_clear_modify">pmap_clear_modify</a>(<a class="local col2 ref" href="#42p" title='p' data-ref="42p" data-ref-filename="42p">p</a>)) {</td></tr>
<tr><th id="802">802</th><td>			<a class="local col2 ref" href="#42p" title='p' data-ref="42p" data-ref-filename="42p">p</a>-&gt;<a class="ref field" href="uvm_page.h.html#vm_page::flags" title='vm_page::flags' data-ref="vm_page::flags" data-ref-filename="vm_page..flags">flags</a> &amp;= ~(<a class="macro" href="uvm_page.h.html#244" title="0x0008" data-ref="_M/PG_CLEAN">PG_CLEAN</a>);</td></tr>
<tr><th id="803">803</th><td>		}</td></tr>
<tr><th id="804">804</th><td>		<b>if</b> (<a class="local col2 ref" href="#42p" title='p' data-ref="42p" data-ref-filename="42p">p</a>-&gt;<a class="ref field" href="uvm_page.h.html#vm_page::flags" title='vm_page::flags' data-ref="vm_page::flags" data-ref-filename="vm_page..flags">flags</a> &amp; <a class="macro" href="uvm_page.h.html#244" title="0x0008" data-ref="_M/PG_CLEAN">PG_CLEAN</a>) {</td></tr>
<tr><th id="805">805</th><td>			<em>int</em> <dfn class="local col9 decl" id="49slot" title='slot' data-type='int' data-ref="49slot" data-ref-filename="49slot">slot</dfn>;</td></tr>
<tr><th id="806">806</th><td>			<em>int</em> <dfn class="local col0 decl" id="50pageidx" title='pageidx' data-type='int' data-ref="50pageidx" data-ref-filename="50pageidx">pageidx</dfn>;</td></tr>
<tr><th id="807">807</th><td></td></tr>
<tr><th id="808">808</th><td>			<a class="local col0 ref" href="#50pageidx" title='pageidx' data-ref="50pageidx" data-ref-filename="50pageidx">pageidx</a> = <a class="local col2 ref" href="#42p" title='p' data-ref="42p" data-ref-filename="42p">p</a>-&gt;<a class="ref field" href="uvm_page.h.html#vm_page::offset" title='vm_page::offset' data-ref="vm_page::offset" data-ref-filename="vm_page..offset">offset</a> &gt;&gt; <a class="macro" href="../arch/amd64/include/vmparam.h.html#55" title="12" data-ref="_M/PAGE_SHIFT">PAGE_SHIFT</a>;</td></tr>
<tr><th id="809">809</th><td>			<a class="ref fn" href="uvm_page.h.html#uvm_pagefree" title='uvm_pagefree' data-ref="uvm_pagefree" data-ref-filename="uvm_pagefree">uvm_pagefree</a>(<a class="local col2 ref" href="#42p" title='p' data-ref="42p" data-ref-filename="42p">p</a>);</td></tr>
<tr><th id="810">810</th><td>			<a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::pdfreed" title='uvmexp::pdfreed' data-ref="uvmexp::pdfreed" data-ref-filename="uvmexp..pdfreed">pdfreed</a>++;</td></tr>
<tr><th id="811">811</th><td></td></tr>
<tr><th id="812">812</th><td>			<i>/*</i></td></tr>
<tr><th id="813">813</th><td><i>			 * for anons, we need to remove the page</i></td></tr>
<tr><th id="814">814</th><td><i>			 * from the anon ourselves.  for aobjs,</i></td></tr>
<tr><th id="815">815</th><td><i>			 * pagefree did that for us.</i></td></tr>
<tr><th id="816">816</th><td><i>			 */</i></td></tr>
<tr><th id="817">817</th><td></td></tr>
<tr><th id="818">818</th><td>			<b>if</b> (<a class="local col4 ref" href="#44anon" title='anon' data-ref="44anon" data-ref-filename="44anon">anon</a>) {</td></tr>
<tr><th id="819">819</th><td>				<a class="macro" href="../lib/libkern/libkern.h.html#279" title="(__builtin_expect(((anon-&gt;an_swslot != 0)) != 0, 1) ? (void)0 : kern_assert(&quot;kernel %sassertion \&quot;%s\&quot; failed: file \&quot;%s\&quot;, line %d &quot;, &quot;diagnostic &quot;, &quot;anon-&gt;an_swslot != 0&quot;, &quot;/___NETBSD_SRC___/objdir.amd64/sys/arch/amd64/compile/GENERIC/../../../../../../sys/uvm/uvm_pdaemon.c&quot;, 819))" data-ref="_M/KASSERT">KASSERT</a>(<a class="local col4 ref" href="#44anon" title='anon' data-ref="44anon" data-ref-filename="44anon">anon</a>-&gt;<a class="ref field" href="uvm_anon.h.html#vm_anon::an_swslot" title='vm_anon::an_swslot' data-ref="vm_anon::an_swslot" data-ref-filename="vm_anon..an_swslot">an_swslot</a> != <var>0</var>);</td></tr>
<tr><th id="820">820</th><td>				<a class="local col4 ref" href="#44anon" title='anon' data-ref="44anon" data-ref-filename="44anon">anon</a>-&gt;<a class="ref field" href="uvm_anon.h.html#vm_anon::an_page" title='vm_anon::an_page' data-ref="vm_anon::an_page" data-ref-filename="vm_anon..an_page">an_page</a> = <a class="macro" href="../sys/null.h.html#13" title="((void *)0)" data-ref="_M/NULL">NULL</a>;</td></tr>
<tr><th id="821">821</th><td>				<a class="local col9 ref" href="#49slot" title='slot' data-ref="49slot" data-ref-filename="49slot">slot</a> = <a class="local col4 ref" href="#44anon" title='anon' data-ref="44anon" data-ref-filename="44anon">anon</a>-&gt;<a class="ref field" href="uvm_anon.h.html#vm_anon::an_swslot" title='vm_anon::an_swslot' data-ref="vm_anon::an_swslot" data-ref-filename="vm_anon..an_swslot">an_swslot</a>;</td></tr>
<tr><th id="822">822</th><td>			} <b>else</b> {</td></tr>
<tr><th id="823">823</th><td>				<a class="local col9 ref" href="#49slot" title='slot' data-ref="49slot" data-ref-filename="49slot">slot</a> = <a class="ref fn" href="uvm_aobj.h.html#uao_find_swslot" title='uao_find_swslot' data-ref="uao_find_swslot" data-ref-filename="uao_find_swslot">uao_find_swslot</a>(<a class="local col3 ref" href="#43uobj" title='uobj' data-ref="43uobj" data-ref-filename="43uobj">uobj</a>, <a class="local col0 ref" href="#50pageidx" title='pageidx' data-ref="50pageidx" data-ref-filename="50pageidx">pageidx</a>);</td></tr>
<tr><th id="824">824</th><td>			}</td></tr>
<tr><th id="825">825</th><td>			<a class="ref fn" href="../sys/mutex.h.html#mutex_exit" title='mutex_exit' data-ref="mutex_exit" data-ref-filename="mutex_exit">mutex_exit</a>(<a class="local col8 ref" href="#48slock" title='slock' data-ref="48slock" data-ref-filename="48slock">slock</a>);</td></tr>
<tr><th id="826">826</th><td></td></tr>
<tr><th id="827">827</th><td>			<b>if</b> (<a class="local col9 ref" href="#49slot" title='slot' data-ref="49slot" data-ref-filename="49slot">slot</a> &gt; <var>0</var>) {</td></tr>
<tr><th id="828">828</th><td>				<i>/* this page is now only in swap. */</i></td></tr>
<tr><th id="829">829</th><td>				<a class="ref fn" href="../sys/mutex.h.html#mutex_enter" title='mutex_enter' data-ref="mutex_enter" data-ref-filename="mutex_enter">mutex_enter</a>(&amp;<a class="ref" href="uvm.h.html#uvm_swap_data_lock" title='uvm_swap_data_lock' data-ref="uvm_swap_data_lock" data-ref-filename="uvm_swap_data_lock">uvm_swap_data_lock</a>);</td></tr>
<tr><th id="830">830</th><td>				<a class="macro" href="../lib/libkern/libkern.h.html#279" title="(__builtin_expect(((uvmexp.swpgonly &lt; uvmexp.swpginuse)) != 0, 1) ? (void)0 : kern_assert(&quot;kernel %sassertion \&quot;%s\&quot; failed: file \&quot;%s\&quot;, line %d &quot;, &quot;diagnostic &quot;, &quot;uvmexp.swpgonly &lt; uvmexp.swpginuse&quot;, &quot;/___NETBSD_SRC___/objdir.amd64/sys/arch/amd64/compile/GENERIC/../../../../../../sys/uvm/uvm_pdaemon.c&quot;, 830))" data-ref="_M/KASSERT">KASSERT</a>(<a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::swpgonly" title='uvmexp::swpgonly' data-ref="uvmexp::swpgonly" data-ref-filename="uvmexp..swpgonly">swpgonly</a> &lt; <a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::swpginuse" title='uvmexp::swpginuse' data-ref="uvmexp::swpginuse" data-ref-filename="uvmexp..swpginuse">swpginuse</a>);</td></tr>
<tr><th id="831">831</th><td>				<a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::swpgonly" title='uvmexp::swpgonly' data-ref="uvmexp::swpgonly" data-ref-filename="uvmexp..swpgonly">swpgonly</a>++;</td></tr>
<tr><th id="832">832</th><td>				<a class="ref fn" href="../sys/mutex.h.html#mutex_exit" title='mutex_exit' data-ref="mutex_exit" data-ref-filename="mutex_exit">mutex_exit</a>(&amp;<a class="ref" href="uvm.h.html#uvm_swap_data_lock" title='uvm_swap_data_lock' data-ref="uvm_swap_data_lock" data-ref-filename="uvm_swap_data_lock">uvm_swap_data_lock</a>);</td></tr>
<tr><th id="833">833</th><td>			}</td></tr>
<tr><th id="834">834</th><td>			<b>continue</b>;</td></tr>
<tr><th id="835">835</th><td>		}</td></tr>
<tr><th id="836">836</th><td></td></tr>
<tr><th id="837">837</th><td><u>#<span data-ppcond="837">if</span> defined(<a class="macro" href="../../objdir.amd64/sys/arch/amd64/compile/GENERIC/opt_vmswap.h.html#1" data-ref="_M/VMSWAP">VMSWAP</a>)</u></td></tr>
<tr><th id="838">838</th><td>		<i>/*</i></td></tr>
<tr><th id="839">839</th><td><i>		 * this page is dirty, skip it if we'll have met our</i></td></tr>
<tr><th id="840">840</th><td><i>		 * free target when all the current pageouts complete.</i></td></tr>
<tr><th id="841">841</th><td><i>		 */</i></td></tr>
<tr><th id="842">842</th><td></td></tr>
<tr><th id="843">843</th><td>		<b>if</b> (<a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::free" title='uvmexp::free' data-ref="uvmexp::free" data-ref-filename="uvmexp..free">free</a> + <a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::paging" title='uvmexp::paging' data-ref="uvmexp::paging" data-ref-filename="uvmexp..paging">paging</a> &gt; <a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::freetarg" title='uvmexp::freetarg' data-ref="uvmexp::freetarg" data-ref-filename="uvmexp..freetarg">freetarg</a> &lt;&lt; <var>2</var>) {</td></tr>
<tr><th id="844">844</th><td>			<a class="ref fn" href="../sys/mutex.h.html#mutex_exit" title='mutex_exit' data-ref="mutex_exit" data-ref-filename="mutex_exit">mutex_exit</a>(<a class="local col8 ref" href="#48slock" title='slock' data-ref="48slock" data-ref-filename="48slock">slock</a>);</td></tr>
<tr><th id="845">845</th><td>			<b>continue</b>;</td></tr>
<tr><th id="846">846</th><td>		}</td></tr>
<tr><th id="847">847</th><td></td></tr>
<tr><th id="848">848</th><td>		<i>/*</i></td></tr>
<tr><th id="849">849</th><td><i>		 * free any swap space allocated to the page since</i></td></tr>
<tr><th id="850">850</th><td><i>		 * we'll have to write it again with its new data.</i></td></tr>
<tr><th id="851">851</th><td><i>		 */</i></td></tr>
<tr><th id="852">852</th><td></td></tr>
<tr><th id="853">853</th><td>		<a class="tu ref fn" href="#uvmpd_dropswap" title='uvmpd_dropswap' data-use='c' data-ref="uvmpd_dropswap" data-ref-filename="uvmpd_dropswap">uvmpd_dropswap</a>(<a class="local col2 ref" href="#42p" title='p' data-ref="42p" data-ref-filename="42p">p</a>);</td></tr>
<tr><th id="854">854</th><td></td></tr>
<tr><th id="855">855</th><td>		<i>/*</i></td></tr>
<tr><th id="856">856</th><td><i>		 * start new swap pageout cluster (if necessary).</i></td></tr>
<tr><th id="857">857</th><td><i>		 *</i></td></tr>
<tr><th id="858">858</th><td><i>		 * if swap is full reactivate this page so that</i></td></tr>
<tr><th id="859">859</th><td><i>		 * we eventually cycle all pages through the</i></td></tr>
<tr><th id="860">860</th><td><i>		 * inactive queue.</i></td></tr>
<tr><th id="861">861</th><td><i>		 */</i></td></tr>
<tr><th id="862">862</th><td></td></tr>
<tr><th id="863">863</th><td>		<b>if</b> (<a class="tu ref fn" href="#swapcluster_allocslots" title='swapcluster_allocslots' data-use='c' data-ref="swapcluster_allocslots" data-ref-filename="swapcluster_allocslots">swapcluster_allocslots</a>(&amp;<a class="local col5 ref" href="#45swc" title='swc' data-ref="45swc" data-ref-filename="45swc">swc</a>)) {</td></tr>
<tr><th id="864">864</th><td>			<a class="local col6 ref" href="#46dirtyreacts" title='dirtyreacts' data-ref="46dirtyreacts" data-ref-filename="46dirtyreacts">dirtyreacts</a>++;</td></tr>
<tr><th id="865">865</th><td>			<a class="ref fn" href="uvm_page.h.html#uvm_pageactivate" title='uvm_pageactivate' data-ref="uvm_pageactivate" data-ref-filename="uvm_pageactivate">uvm_pageactivate</a>(<a class="local col2 ref" href="#42p" title='p' data-ref="42p" data-ref-filename="42p">p</a>);</td></tr>
<tr><th id="866">866</th><td>			<a class="ref fn" href="../sys/mutex.h.html#mutex_exit" title='mutex_exit' data-ref="mutex_exit" data-ref-filename="mutex_exit">mutex_exit</a>(<a class="local col8 ref" href="#48slock" title='slock' data-ref="48slock" data-ref-filename="48slock">slock</a>);</td></tr>
<tr><th id="867">867</th><td>			<b>continue</b>;</td></tr>
<tr><th id="868">868</th><td>		}</td></tr>
<tr><th id="869">869</th><td></td></tr>
<tr><th id="870">870</th><td>		<i>/*</i></td></tr>
<tr><th id="871">871</th><td><i>		 * at this point, we're definitely going reuse this</i></td></tr>
<tr><th id="872">872</th><td><i>		 * page.  mark the page busy and delayed-free.</i></td></tr>
<tr><th id="873">873</th><td><i>		 * we should remove the page from the page queues</i></td></tr>
<tr><th id="874">874</th><td><i>		 * so we don't ever look at it again.</i></td></tr>
<tr><th id="875">875</th><td><i>		 * adjust counters and such.</i></td></tr>
<tr><th id="876">876</th><td><i>		 */</i></td></tr>
<tr><th id="877">877</th><td></td></tr>
<tr><th id="878">878</th><td>		<a class="local col2 ref" href="#42p" title='p' data-ref="42p" data-ref-filename="42p">p</a>-&gt;<a class="ref field" href="uvm_page.h.html#vm_page::flags" title='vm_page::flags' data-ref="vm_page::flags" data-ref-filename="vm_page..flags">flags</a> |= <a class="macro" href="uvm_page.h.html#241" title="0x0001" data-ref="_M/PG_BUSY">PG_BUSY</a>;</td></tr>
<tr><th id="879">879</th><td>		<a class="macro" href="uvm.h.html#189" title="" data-ref="_M/UVM_PAGE_OWN">UVM_PAGE_OWN</a>(p, <q>"scan_queue"</q>);</td></tr>
<tr><th id="880">880</th><td></td></tr>
<tr><th id="881">881</th><td>		<a class="local col2 ref" href="#42p" title='p' data-ref="42p" data-ref-filename="42p">p</a>-&gt;<a class="ref field" href="uvm_page.h.html#vm_page::flags" title='vm_page::flags' data-ref="vm_page::flags" data-ref-filename="vm_page..flags">flags</a> |= <a class="macro" href="uvm_page.h.html#245" title="0x0010" data-ref="_M/PG_PAGEOUT">PG_PAGEOUT</a>;</td></tr>
<tr><th id="882">882</th><td>		<a class="ref fn" href="uvm_page.h.html#uvm_pagedequeue" title='uvm_pagedequeue' data-ref="uvm_pagedequeue" data-ref-filename="uvm_pagedequeue">uvm_pagedequeue</a>(<a class="local col2 ref" href="#42p" title='p' data-ref="42p" data-ref-filename="42p">p</a>);</td></tr>
<tr><th id="883">883</th><td></td></tr>
<tr><th id="884">884</th><td>		<a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::pgswapout" title='uvmexp::pgswapout' data-ref="uvmexp::pgswapout" data-ref-filename="uvmexp..pgswapout">pgswapout</a>++;</td></tr>
<tr><th id="885">885</th><td>		<a class="ref fn" href="../sys/mutex.h.html#mutex_exit" title='mutex_exit' data-ref="mutex_exit" data-ref-filename="mutex_exit">mutex_exit</a>(&amp;<a class="ref" href="uvm.h.html#uvm_pageqlock" title='uvm_pageqlock' data-ref="uvm_pageqlock" data-ref-filename="uvm_pageqlock">uvm_pageqlock</a>);</td></tr>
<tr><th id="886">886</th><td></td></tr>
<tr><th id="887">887</th><td>		<i>/*</i></td></tr>
<tr><th id="888">888</th><td><i>		 * add the new page to the cluster.</i></td></tr>
<tr><th id="889">889</th><td><i>		 */</i></td></tr>
<tr><th id="890">890</th><td></td></tr>
<tr><th id="891">891</th><td>		<b>if</b> (<a class="tu ref fn" href="#swapcluster_add" title='swapcluster_add' data-use='c' data-ref="swapcluster_add" data-ref-filename="swapcluster_add">swapcluster_add</a>(&amp;<a class="local col5 ref" href="#45swc" title='swc' data-ref="45swc" data-ref-filename="45swc">swc</a>, <a class="local col2 ref" href="#42p" title='p' data-ref="42p" data-ref-filename="42p">p</a>)) {</td></tr>
<tr><th id="892">892</th><td>			<a class="local col2 ref" href="#42p" title='p' data-ref="42p" data-ref-filename="42p">p</a>-&gt;<a class="ref field" href="uvm_page.h.html#vm_page::flags" title='vm_page::flags' data-ref="vm_page::flags" data-ref-filename="vm_page..flags">flags</a> &amp;= ~(<a class="macro" href="uvm_page.h.html#241" title="0x0001" data-ref="_M/PG_BUSY">PG_BUSY</a>|<a class="macro" href="uvm_page.h.html#245" title="0x0010" data-ref="_M/PG_PAGEOUT">PG_PAGEOUT</a>);</td></tr>
<tr><th id="893">893</th><td>			<a class="macro" href="uvm.h.html#189" title="" data-ref="_M/UVM_PAGE_OWN">UVM_PAGE_OWN</a>(p, NULL);</td></tr>
<tr><th id="894">894</th><td>			<a class="ref fn" href="../sys/mutex.h.html#mutex_enter" title='mutex_enter' data-ref="mutex_enter" data-ref-filename="mutex_enter">mutex_enter</a>(&amp;<a class="ref" href="uvm.h.html#uvm_pageqlock" title='uvm_pageqlock' data-ref="uvm_pageqlock" data-ref-filename="uvm_pageqlock">uvm_pageqlock</a>);</td></tr>
<tr><th id="895">895</th><td>			<a class="local col6 ref" href="#46dirtyreacts" title='dirtyreacts' data-ref="46dirtyreacts" data-ref-filename="46dirtyreacts">dirtyreacts</a>++;</td></tr>
<tr><th id="896">896</th><td>			<a class="ref fn" href="uvm_page.h.html#uvm_pageactivate" title='uvm_pageactivate' data-ref="uvm_pageactivate" data-ref-filename="uvm_pageactivate">uvm_pageactivate</a>(<a class="local col2 ref" href="#42p" title='p' data-ref="42p" data-ref-filename="42p">p</a>);</td></tr>
<tr><th id="897">897</th><td>			<a class="ref fn" href="../sys/mutex.h.html#mutex_exit" title='mutex_exit' data-ref="mutex_exit" data-ref-filename="mutex_exit">mutex_exit</a>(<a class="local col8 ref" href="#48slock" title='slock' data-ref="48slock" data-ref-filename="48slock">slock</a>);</td></tr>
<tr><th id="898">898</th><td>			<b>continue</b>;</td></tr>
<tr><th id="899">899</th><td>		}</td></tr>
<tr><th id="900">900</th><td>		<a class="ref fn" href="../sys/mutex.h.html#mutex_exit" title='mutex_exit' data-ref="mutex_exit" data-ref-filename="mutex_exit">mutex_exit</a>(<a class="local col8 ref" href="#48slock" title='slock' data-ref="48slock" data-ref-filename="48slock">slock</a>);</td></tr>
<tr><th id="901">901</th><td></td></tr>
<tr><th id="902">902</th><td>		<a class="tu ref fn" href="#swapcluster_flush" title='swapcluster_flush' data-use='c' data-ref="swapcluster_flush" data-ref-filename="swapcluster_flush">swapcluster_flush</a>(&amp;<a class="local col5 ref" href="#45swc" title='swc' data-ref="45swc" data-ref-filename="45swc">swc</a>, <a class="macro" href="../sys/stdbool.h.html#40" title="0" data-ref="_M/false">false</a>);</td></tr>
<tr><th id="903">903</th><td>		<a class="ref fn" href="../sys/mutex.h.html#mutex_enter" title='mutex_enter' data-ref="mutex_enter" data-ref-filename="mutex_enter">mutex_enter</a>(&amp;<a class="ref" href="uvm.h.html#uvm_pageqlock" title='uvm_pageqlock' data-ref="uvm_pageqlock" data-ref-filename="uvm_pageqlock">uvm_pageqlock</a>);</td></tr>
<tr><th id="904">904</th><td></td></tr>
<tr><th id="905">905</th><td>		<i>/*</i></td></tr>
<tr><th id="906">906</th><td><i>		 * the pageout is in progress.  bump counters and set up</i></td></tr>
<tr><th id="907">907</th><td><i>		 * for the next loop.</i></td></tr>
<tr><th id="908">908</th><td><i>		 */</i></td></tr>
<tr><th id="909">909</th><td></td></tr>
<tr><th id="910">910</th><td>		<a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::pdpending" title='uvmexp::pdpending' data-ref="uvmexp::pdpending" data-ref-filename="uvmexp..pdpending">pdpending</a>++;</td></tr>
<tr><th id="911">911</th><td></td></tr>
<tr><th id="912">912</th><td><u>#<span data-ppcond="837">else</span> /* defined(VMSWAP) */</u></td></tr>
<tr><th id="913">913</th><td>		uvm_pageactivate(p);</td></tr>
<tr><th id="914">914</th><td>		mutex_exit(slock);</td></tr>
<tr><th id="915">915</th><td><u>#<span data-ppcond="837">endif</span> /* defined(VMSWAP) */</u></td></tr>
<tr><th id="916">916</th><td>	}</td></tr>
<tr><th id="917">917</th><td></td></tr>
<tr><th id="918">918</th><td><u>#<span data-ppcond="918">if</span> defined(<a class="macro" href="../../objdir.amd64/sys/arch/amd64/compile/GENERIC/opt_vmswap.h.html#1" data-ref="_M/VMSWAP">VMSWAP</a>)</u></td></tr>
<tr><th id="919">919</th><td>	<a class="ref fn" href="../sys/mutex.h.html#mutex_exit" title='mutex_exit' data-ref="mutex_exit" data-ref-filename="mutex_exit">mutex_exit</a>(&amp;<a class="ref" href="uvm.h.html#uvm_pageqlock" title='uvm_pageqlock' data-ref="uvm_pageqlock" data-ref-filename="uvm_pageqlock">uvm_pageqlock</a>);</td></tr>
<tr><th id="920">920</th><td>	<a class="tu ref fn" href="#swapcluster_flush" title='swapcluster_flush' data-use='c' data-ref="swapcluster_flush" data-ref-filename="swapcluster_flush">swapcluster_flush</a>(&amp;<a class="local col5 ref" href="#45swc" title='swc' data-ref="45swc" data-ref-filename="45swc">swc</a>, <a class="macro" href="../sys/stdbool.h.html#39" title="1" data-ref="_M/true">true</a>);</td></tr>
<tr><th id="921">921</th><td>	<a class="ref fn" href="../sys/mutex.h.html#mutex_enter" title='mutex_enter' data-ref="mutex_enter" data-ref-filename="mutex_enter">mutex_enter</a>(&amp;<a class="ref" href="uvm.h.html#uvm_pageqlock" title='uvm_pageqlock' data-ref="uvm_pageqlock" data-ref-filename="uvm_pageqlock">uvm_pageqlock</a>);</td></tr>
<tr><th id="922">922</th><td><u>#<span data-ppcond="918">endif</span> /* defined(VMSWAP) */</u></td></tr>
<tr><th id="923">923</th><td>}</td></tr>
<tr><th id="924">924</th><td></td></tr>
<tr><th id="925">925</th><td><i  data-doc="uvmpd_scan">/*</i></td></tr>
<tr><th id="926">926</th><td><i  data-doc="uvmpd_scan"> * uvmpd_scan: scan the page queues and attempt to meet our targets.</i></td></tr>
<tr><th id="927">927</th><td><i  data-doc="uvmpd_scan"> *</i></td></tr>
<tr><th id="928">928</th><td><i  data-doc="uvmpd_scan"> * =&gt; called with pageq's locked</i></td></tr>
<tr><th id="929">929</th><td><i  data-doc="uvmpd_scan"> */</i></td></tr>
<tr><th id="930">930</th><td></td></tr>
<tr><th id="931">931</th><td><em>static</em> <em>void</em></td></tr>
<tr><th id="932">932</th><td><dfn class="tu decl def fn" id="uvmpd_scan" title='uvmpd_scan' data-type='void uvmpd_scan()' data-ref="uvmpd_scan" data-ref-filename="uvmpd_scan">uvmpd_scan</dfn>(<em>void</em>)</td></tr>
<tr><th id="933">933</th><td>{</td></tr>
<tr><th id="934">934</th><td>	<em>int</em> <dfn class="local col1 decl" id="51swap_shortage" title='swap_shortage' data-type='int' data-ref="51swap_shortage" data-ref-filename="51swap_shortage">swap_shortage</dfn>, <dfn class="local col2 decl" id="52pages_freed" title='pages_freed' data-type='int' data-ref="52pages_freed" data-ref-filename="52pages_freed">pages_freed</dfn>;</td></tr>
<tr><th id="935">935</th><td>	<a class="macro" href="uvm_stat.h.html#74" title="" data-ref="_M/UVMHIST_FUNC">UVMHIST_FUNC</a>(<q>"uvmpd_scan"</q>); <a class="macro" href="uvm_stat.h.html#73" title="" data-ref="_M/UVMHIST_CALLED">UVMHIST_CALLED</a>(pdhist);</td></tr>
<tr><th id="936">936</th><td></td></tr>
<tr><th id="937">937</th><td>	<a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::pdrevs" title='uvmexp::pdrevs' data-ref="uvmexp::pdrevs" data-ref-filename="uvmexp..pdrevs">pdrevs</a>++;</td></tr>
<tr><th id="938">938</th><td></td></tr>
<tr><th id="939">939</th><td>	<i>/*</i></td></tr>
<tr><th id="940">940</th><td><i>	 * work on meeting our targets.   first we work on our free target</i></td></tr>
<tr><th id="941">941</th><td><i>	 * by converting inactive pages into free pages.  then we work on</i></td></tr>
<tr><th id="942">942</th><td><i>	 * meeting our inactive target by converting active pages to</i></td></tr>
<tr><th id="943">943</th><td><i>	 * inactive ones.</i></td></tr>
<tr><th id="944">944</th><td><i>	 */</i></td></tr>
<tr><th id="945">945</th><td></td></tr>
<tr><th id="946">946</th><td>	<a class="macro" href="uvm_stat.h.html#72" title="" data-ref="_M/UVMHIST_LOG">UVMHIST_LOG</a>(pdhist, <q>"  starting 'free' loop"</q>,<var>0</var>,<var>0</var>,<var>0</var>,<var>0</var>);</td></tr>
<tr><th id="947">947</th><td></td></tr>
<tr><th id="948">948</th><td>	<a class="local col2 ref" href="#52pages_freed" title='pages_freed' data-ref="52pages_freed" data-ref-filename="52pages_freed">pages_freed</a> = <a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::pdfreed" title='uvmexp::pdfreed' data-ref="uvmexp::pdfreed" data-ref-filename="uvmexp..pdfreed">pdfreed</a>;</td></tr>
<tr><th id="949">949</th><td>	<a class="tu ref fn" href="#uvmpd_scan_queue" title='uvmpd_scan_queue' data-use='c' data-ref="uvmpd_scan_queue" data-ref-filename="uvmpd_scan_queue">uvmpd_scan_queue</a>();</td></tr>
<tr><th id="950">950</th><td>	<a class="local col2 ref" href="#52pages_freed" title='pages_freed' data-ref="52pages_freed" data-ref-filename="52pages_freed">pages_freed</a> = <a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::pdfreed" title='uvmexp::pdfreed' data-ref="uvmexp::pdfreed" data-ref-filename="uvmexp..pdfreed">pdfreed</a> - <a class="local col2 ref" href="#52pages_freed" title='pages_freed' data-ref="52pages_freed" data-ref-filename="52pages_freed">pages_freed</a>;</td></tr>
<tr><th id="951">951</th><td></td></tr>
<tr><th id="952">952</th><td>	<i>/*</i></td></tr>
<tr><th id="953">953</th><td><i>	 * detect if we're not going to be able to page anything out</i></td></tr>
<tr><th id="954">954</th><td><i>	 * until we free some swap resources from active pages.</i></td></tr>
<tr><th id="955">955</th><td><i>	 */</i></td></tr>
<tr><th id="956">956</th><td></td></tr>
<tr><th id="957">957</th><td>	<a class="local col1 ref" href="#51swap_shortage" title='swap_shortage' data-ref="51swap_shortage" data-ref-filename="51swap_shortage">swap_shortage</a> = <var>0</var>;</td></tr>
<tr><th id="958">958</th><td>	<b>if</b> (<a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::free" title='uvmexp::free' data-ref="uvmexp::free" data-ref-filename="uvmexp..free">free</a> &lt; <a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::freetarg" title='uvmexp::freetarg' data-ref="uvmexp::freetarg" data-ref-filename="uvmexp..freetarg">freetarg</a> &amp;&amp;</td></tr>
<tr><th id="959">959</th><td>	    <a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::swpginuse" title='uvmexp::swpginuse' data-ref="uvmexp::swpginuse" data-ref-filename="uvmexp..swpginuse">swpginuse</a> &gt;= <a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::swpgavail" title='uvmexp::swpgavail' data-ref="uvmexp::swpgavail" data-ref-filename="uvmexp..swpgavail">swpgavail</a> &amp;&amp;</td></tr>
<tr><th id="960">960</th><td>	    !<a class="ref fn" href="uvm_swap.h.html#uvm_swapisfull" title='uvm_swapisfull' data-ref="uvm_swapisfull" data-ref-filename="uvm_swapisfull">uvm_swapisfull</a>() &amp;&amp;</td></tr>
<tr><th id="961">961</th><td>	    <a class="local col2 ref" href="#52pages_freed" title='pages_freed' data-ref="52pages_freed" data-ref-filename="52pages_freed">pages_freed</a> == <var>0</var>) {</td></tr>
<tr><th id="962">962</th><td>		<a class="local col1 ref" href="#51swap_shortage" title='swap_shortage' data-ref="51swap_shortage" data-ref-filename="51swap_shortage">swap_shortage</a> = <a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::freetarg" title='uvmexp::freetarg' data-ref="uvmexp::freetarg" data-ref-filename="uvmexp..freetarg">freetarg</a> - <a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::free" title='uvmexp::free' data-ref="uvmexp::free" data-ref-filename="uvmexp..free">free</a>;</td></tr>
<tr><th id="963">963</th><td>	}</td></tr>
<tr><th id="964">964</th><td></td></tr>
<tr><th id="965">965</th><td>	<a class="ref fn" href="uvm_pdpolicy.h.html#uvmpdpol_balancequeue" title='uvmpdpol_balancequeue' data-ref="uvmpdpol_balancequeue" data-ref-filename="uvmpdpol_balancequeue">uvmpdpol_balancequeue</a>(<a class="local col1 ref" href="#51swap_shortage" title='swap_shortage' data-ref="51swap_shortage" data-ref-filename="51swap_shortage">swap_shortage</a>);</td></tr>
<tr><th id="966">966</th><td></td></tr>
<tr><th id="967">967</th><td>	<i>/*</i></td></tr>
<tr><th id="968">968</th><td><i>	 * if still below the minimum target, try unloading kernel</i></td></tr>
<tr><th id="969">969</th><td><i>	 * modules.</i></td></tr>
<tr><th id="970">970</th><td><i>	 */</i></td></tr>
<tr><th id="971">971</th><td></td></tr>
<tr><th id="972">972</th><td>	<b>if</b> (<a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::free" title='uvmexp::free' data-ref="uvmexp::free" data-ref-filename="uvmexp..free">free</a> &lt; <a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::freemin" title='uvmexp::freemin' data-ref="uvmexp::freemin" data-ref-filename="uvmexp..freemin">freemin</a>) {</td></tr>
<tr><th id="973">973</th><td>		<a class="ref fn" href="../sys/module.h.html#module_thread_kick" title='module_thread_kick' data-ref="module_thread_kick" data-ref-filename="module_thread_kick">module_thread_kick</a>();</td></tr>
<tr><th id="974">974</th><td>	}</td></tr>
<tr><th id="975">975</th><td>}</td></tr>
<tr><th id="976">976</th><td></td></tr>
<tr><th id="977">977</th><td><i>/*</i></td></tr>
<tr><th id="978">978</th><td><i> * uvm_reclaimable: decide whether to wait for pagedaemon.</i></td></tr>
<tr><th id="979">979</th><td><i> *</i></td></tr>
<tr><th id="980">980</th><td><i> * =&gt; return true if it seems to be worth to do uvm_wait.</i></td></tr>
<tr><th id="981">981</th><td><i> *</i></td></tr>
<tr><th id="982">982</th><td><i> * XXX should be tunable.</i></td></tr>
<tr><th id="983">983</th><td><i> * XXX should consider pools, etc?</i></td></tr>
<tr><th id="984">984</th><td><i> */</i></td></tr>
<tr><th id="985">985</th><td></td></tr>
<tr><th id="986">986</th><td><a class="macro" href="../sys/stdbool.h.html#37" title="_Bool" data-ref="_M/bool">bool</a></td></tr>
<tr><th id="987">987</th><td><dfn class="decl def fn" id="uvm_reclaimable" title='uvm_reclaimable' data-ref="uvm_reclaimable" data-ref-filename="uvm_reclaimable">uvm_reclaimable</dfn>(<em>void</em>)</td></tr>
<tr><th id="988">988</th><td>{</td></tr>
<tr><th id="989">989</th><td>	<em>int</em> <dfn class="local col3 decl" id="53filepages" title='filepages' data-type='int' data-ref="53filepages" data-ref-filename="53filepages">filepages</dfn>;</td></tr>
<tr><th id="990">990</th><td>	<em>int</em> <dfn class="local col4 decl" id="54active" title='active' data-type='int' data-ref="54active" data-ref-filename="54active">active</dfn>, <dfn class="local col5 decl" id="55inactive" title='inactive' data-type='int' data-ref="55inactive" data-ref-filename="55inactive">inactive</dfn>;</td></tr>
<tr><th id="991">991</th><td></td></tr>
<tr><th id="992">992</th><td>	<i>/*</i></td></tr>
<tr><th id="993">993</th><td><i>	 * if swap is not full, no problem.</i></td></tr>
<tr><th id="994">994</th><td><i>	 */</i></td></tr>
<tr><th id="995">995</th><td></td></tr>
<tr><th id="996">996</th><td>	<b>if</b> (!<a class="ref fn" href="uvm_swap.h.html#uvm_swapisfull" title='uvm_swapisfull' data-ref="uvm_swapisfull" data-ref-filename="uvm_swapisfull">uvm_swapisfull</a>()) {</td></tr>
<tr><th id="997">997</th><td>		<b>return</b> <a class="macro" href="../sys/stdbool.h.html#39" title="1" data-ref="_M/true">true</a>;</td></tr>
<tr><th id="998">998</th><td>	}</td></tr>
<tr><th id="999">999</th><td></td></tr>
<tr><th id="1000">1000</th><td>	<i>/*</i></td></tr>
<tr><th id="1001">1001</th><td><i>	 * file-backed pages can be reclaimed even when swap is full.</i></td></tr>
<tr><th id="1002">1002</th><td><i>	 * if we have more than 1/16 of pageable memory or 5MB, try to reclaim.</i></td></tr>
<tr><th id="1003">1003</th><td><i>	 *</i></td></tr>
<tr><th id="1004">1004</th><td><i>	 * XXX assume the worst case, ie. all wired pages are file-backed.</i></td></tr>
<tr><th id="1005">1005</th><td><i>	 *</i></td></tr>
<tr><th id="1006">1006</th><td><i>	 * XXX should consider about other reclaimable memory.</i></td></tr>
<tr><th id="1007">1007</th><td><i>	 * XXX ie. pools, traditional buffer cache.</i></td></tr>
<tr><th id="1008">1008</th><td><i>	 */</i></td></tr>
<tr><th id="1009">1009</th><td></td></tr>
<tr><th id="1010">1010</th><td>	<a class="local col3 ref" href="#53filepages" title='filepages' data-ref="53filepages" data-ref-filename="53filepages">filepages</a> = <a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::filepages" title='uvmexp::filepages' data-ref="uvmexp::filepages" data-ref-filename="uvmexp..filepages">filepages</a> + <a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::execpages" title='uvmexp::execpages' data-ref="uvmexp::execpages" data-ref-filename="uvmexp..execpages">execpages</a> - <a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::wired" title='uvmexp::wired' data-ref="uvmexp::wired" data-ref-filename="uvmexp..wired">wired</a>;</td></tr>
<tr><th id="1011">1011</th><td>	<a class="ref fn" href="#uvm_estimatepageable" title='uvm_estimatepageable' data-ref="uvm_estimatepageable" data-ref-filename="uvm_estimatepageable">uvm_estimatepageable</a>(&amp;<a class="local col4 ref" href="#54active" title='active' data-ref="54active" data-ref-filename="54active">active</a>, &amp;<a class="local col5 ref" href="#55inactive" title='inactive' data-ref="55inactive" data-ref-filename="55inactive">inactive</a>);</td></tr>
<tr><th id="1012">1012</th><td>	<b>if</b> (<a class="local col3 ref" href="#53filepages" title='filepages' data-ref="53filepages" data-ref-filename="53filepages">filepages</a> &gt;= <a class="macro" href="../sys/param.h.html#138" title="(( ((active + inactive) &gt;&gt; 4)&lt;(5 * 1024 * 1024 &gt;&gt; 12))?((active + inactive) &gt;&gt; 4):(5 * 1024 * 1024 &gt;&gt; 12))" data-ref="_M/MIN">MIN</a>((<a class="local col4 ref" href="#54active" title='active' data-ref="54active" data-ref-filename="54active">active</a> + <a class="local col5 ref" href="#55inactive" title='inactive' data-ref="55inactive" data-ref-filename="55inactive">inactive</a>) &gt;&gt; <var>4</var>,</td></tr>
<tr><th id="1013">1013</th><td>	    <var>5</var> * <var>1024</var> * <var>1024</var> &gt;&gt; <a class="macro" href="../arch/amd64/include/vmparam.h.html#55" title="12" data-ref="_M/PAGE_SHIFT">PAGE_SHIFT</a>)) {</td></tr>
<tr><th id="1014">1014</th><td>		<b>return</b> <a class="macro" href="../sys/stdbool.h.html#39" title="1" data-ref="_M/true">true</a>;</td></tr>
<tr><th id="1015">1015</th><td>	}</td></tr>
<tr><th id="1016">1016</th><td></td></tr>
<tr><th id="1017">1017</th><td>	<i>/*</i></td></tr>
<tr><th id="1018">1018</th><td><i>	 * kill the process, fail allocation, etc..</i></td></tr>
<tr><th id="1019">1019</th><td><i>	 */</i></td></tr>
<tr><th id="1020">1020</th><td></td></tr>
<tr><th id="1021">1021</th><td>	<b>return</b> <a class="macro" href="../sys/stdbool.h.html#40" title="0" data-ref="_M/false">false</a>;</td></tr>
<tr><th id="1022">1022</th><td>}</td></tr>
<tr><th id="1023">1023</th><td></td></tr>
<tr><th id="1024">1024</th><td><em>void</em></td></tr>
<tr><th id="1025">1025</th><td><dfn class="decl def fn" id="uvm_estimatepageable" title='uvm_estimatepageable' data-ref="uvm_estimatepageable" data-ref-filename="uvm_estimatepageable">uvm_estimatepageable</dfn>(<em>int</em> *<dfn class="local col6 decl" id="56active" title='active' data-type='int *' data-ref="56active" data-ref-filename="56active">active</dfn>, <em>int</em> *<dfn class="local col7 decl" id="57inactive" title='inactive' data-type='int *' data-ref="57inactive" data-ref-filename="57inactive">inactive</dfn>)</td></tr>
<tr><th id="1026">1026</th><td>{</td></tr>
<tr><th id="1027">1027</th><td></td></tr>
<tr><th id="1028">1028</th><td>	<a class="ref fn" href="uvm_pdpolicy.h.html#uvmpdpol_estimatepageable" title='uvmpdpol_estimatepageable' data-ref="uvmpdpol_estimatepageable" data-ref-filename="uvmpdpol_estimatepageable">uvmpdpol_estimatepageable</a>(<a class="local col6 ref" href="#56active" title='active' data-ref="56active" data-ref-filename="56active">active</a>, <a class="local col7 ref" href="#57inactive" title='inactive' data-ref="57inactive" data-ref-filename="57inactive">inactive</a>);</td></tr>
<tr><th id="1029">1029</th><td>}</td></tr>
<tr><th id="1030">1030</th><td></td></tr>
<tr><th id="1031">1031</th><td></td></tr>
<tr><th id="1032">1032</th><td><i  data-doc="uvmpd_pool_drain_thread">/*</i></td></tr>
<tr><th id="1033">1033</th><td><i  data-doc="uvmpd_pool_drain_thread"> * Use a separate thread for draining pools.</i></td></tr>
<tr><th id="1034">1034</th><td><i  data-doc="uvmpd_pool_drain_thread"> * This work can't done from the main pagedaemon thread because</i></td></tr>
<tr><th id="1035">1035</th><td><i  data-doc="uvmpd_pool_drain_thread"> * some pool allocators need to take vm_map locks.</i></td></tr>
<tr><th id="1036">1036</th><td><i  data-doc="uvmpd_pool_drain_thread"> */</i></td></tr>
<tr><th id="1037">1037</th><td></td></tr>
<tr><th id="1038">1038</th><td><em>static</em> <em>void</em></td></tr>
<tr><th id="1039">1039</th><td><dfn class="tu decl def fn" id="uvmpd_pool_drain_thread" title='uvmpd_pool_drain_thread' data-type='void uvmpd_pool_drain_thread(void * arg)' data-ref="uvmpd_pool_drain_thread" data-ref-filename="uvmpd_pool_drain_thread">uvmpd_pool_drain_thread</dfn>(<em>void</em> *<dfn class="local col8 decl" id="58arg" title='arg' data-type='void *' data-ref="58arg" data-ref-filename="58arg">arg</dfn>)</td></tr>
<tr><th id="1040">1040</th><td>{</td></tr>
<tr><th id="1041">1041</th><td>	<em>int</em> <dfn class="local col9 decl" id="59bufcnt" title='bufcnt' data-type='int' data-ref="59bufcnt" data-ref-filename="59bufcnt">bufcnt</dfn>;</td></tr>
<tr><th id="1042">1042</th><td></td></tr>
<tr><th id="1043">1043</th><td>	<b>for</b> (;;) {</td></tr>
<tr><th id="1044">1044</th><td>		<a class="ref fn" href="../sys/mutex.h.html#mutex_enter" title='mutex_enter' data-ref="mutex_enter" data-ref-filename="mutex_enter">mutex_enter</a>(&amp;<a class="tu ref" href="#uvmpd_pool_drain_lock" title='uvmpd_pool_drain_lock' data-use='a' data-ref="uvmpd_pool_drain_lock" data-ref-filename="uvmpd_pool_drain_lock">uvmpd_pool_drain_lock</a>);</td></tr>
<tr><th id="1045">1045</th><td>		<b>if</b> (!<a class="tu ref" href="#uvmpd_pool_drain_run" title='uvmpd_pool_drain_run' data-use='r' data-ref="uvmpd_pool_drain_run" data-ref-filename="uvmpd_pool_drain_run">uvmpd_pool_drain_run</a>) {</td></tr>
<tr><th id="1046">1046</th><td>			<a class="ref fn" href="../sys/condvar.h.html#cv_wait" title='cv_wait' data-ref="cv_wait" data-ref-filename="cv_wait">cv_wait</a>(&amp;<a class="tu ref" href="#uvmpd_pool_drain_cv" title='uvmpd_pool_drain_cv' data-use='a' data-ref="uvmpd_pool_drain_cv" data-ref-filename="uvmpd_pool_drain_cv">uvmpd_pool_drain_cv</a>, &amp;<a class="tu ref" href="#uvmpd_pool_drain_lock" title='uvmpd_pool_drain_lock' data-use='a' data-ref="uvmpd_pool_drain_lock" data-ref-filename="uvmpd_pool_drain_lock">uvmpd_pool_drain_lock</a>);</td></tr>
<tr><th id="1047">1047</th><td>		}</td></tr>
<tr><th id="1048">1048</th><td>		<a class="tu ref" href="#uvmpd_pool_drain_run" title='uvmpd_pool_drain_run' data-use='w' data-ref="uvmpd_pool_drain_run" data-ref-filename="uvmpd_pool_drain_run">uvmpd_pool_drain_run</a> = <a class="macro" href="../sys/stdbool.h.html#40" title="0" data-ref="_M/false">false</a>;</td></tr>
<tr><th id="1049">1049</th><td>		<a class="ref fn" href="../sys/mutex.h.html#mutex_exit" title='mutex_exit' data-ref="mutex_exit" data-ref-filename="mutex_exit">mutex_exit</a>(&amp;<a class="tu ref" href="#uvmpd_pool_drain_lock" title='uvmpd_pool_drain_lock' data-use='a' data-ref="uvmpd_pool_drain_lock" data-ref-filename="uvmpd_pool_drain_lock">uvmpd_pool_drain_lock</a>);</td></tr>
<tr><th id="1050">1050</th><td></td></tr>
<tr><th id="1051">1051</th><td>		<i>/*</i></td></tr>
<tr><th id="1052">1052</th><td><i>		 * kill unused metadata buffers.</i></td></tr>
<tr><th id="1053">1053</th><td><i>		 */</i></td></tr>
<tr><th id="1054">1054</th><td>		<a class="ref fn" href="../sys/mutex.h.html#mutex_spin_enter" title='mutex_spin_enter' data-ref="mutex_spin_enter" data-ref-filename="mutex_spin_enter">mutex_spin_enter</a>(&amp;<a class="ref" href="uvm.h.html#uvm_fpageqlock" title='uvm_fpageqlock' data-ref="uvm_fpageqlock" data-ref-filename="uvm_fpageqlock">uvm_fpageqlock</a>);</td></tr>
<tr><th id="1055">1055</th><td>		<a class="local col9 ref" href="#59bufcnt" title='bufcnt' data-ref="59bufcnt" data-ref-filename="59bufcnt">bufcnt</a> = <a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::freetarg" title='uvmexp::freetarg' data-ref="uvmexp::freetarg" data-ref-filename="uvmexp..freetarg">freetarg</a> - <a class="ref" href="uvm_extern.h.html#uvmexp" title='uvmexp' data-ref="uvmexp" data-ref-filename="uvmexp">uvmexp</a>.<a class="ref field" href="uvm_extern.h.html#uvmexp::free" title='uvmexp::free' data-ref="uvmexp::free" data-ref-filename="uvmexp..free">free</a>;</td></tr>
<tr><th id="1056">1056</th><td>		<a class="ref fn" href="../sys/mutex.h.html#mutex_spin_exit" title='mutex_spin_exit' data-ref="mutex_spin_exit" data-ref-filename="mutex_spin_exit">mutex_spin_exit</a>(&amp;<a class="ref" href="uvm.h.html#uvm_fpageqlock" title='uvm_fpageqlock' data-ref="uvm_fpageqlock" data-ref-filename="uvm_fpageqlock">uvm_fpageqlock</a>);</td></tr>
<tr><th id="1057">1057</th><td>		<b>if</b> (<a class="local col9 ref" href="#59bufcnt" title='bufcnt' data-ref="59bufcnt" data-ref-filename="59bufcnt">bufcnt</a> &lt; <var>0</var>)</td></tr>
<tr><th id="1058">1058</th><td>			<a class="local col9 ref" href="#59bufcnt" title='bufcnt' data-ref="59bufcnt" data-ref-filename="59bufcnt">bufcnt</a> = <var>0</var>;</td></tr>
<tr><th id="1059">1059</th><td></td></tr>
<tr><th id="1060">1060</th><td>		<a class="ref fn" href="../sys/mutex.h.html#mutex_enter" title='mutex_enter' data-ref="mutex_enter" data-ref-filename="mutex_enter">mutex_enter</a>(&amp;<a class="ref" href="../sys/buf.h.html#bufcache_lock" title='bufcache_lock' data-ref="bufcache_lock" data-ref-filename="bufcache_lock">bufcache_lock</a>);</td></tr>
<tr><th id="1061">1061</th><td>		<a class="ref fn" href="../sys/buf.h.html#buf_drain" title='buf_drain' data-ref="buf_drain" data-ref-filename="buf_drain">buf_drain</a>(<a class="local col9 ref" href="#59bufcnt" title='bufcnt' data-ref="59bufcnt" data-ref-filename="59bufcnt">bufcnt</a> &lt;&lt; <a class="macro" href="../arch/amd64/include/vmparam.h.html#55" title="12" data-ref="_M/PAGE_SHIFT">PAGE_SHIFT</a>);</td></tr>
<tr><th id="1062">1062</th><td>		<a class="ref fn" href="../sys/mutex.h.html#mutex_exit" title='mutex_exit' data-ref="mutex_exit" data-ref-filename="mutex_exit">mutex_exit</a>(&amp;<a class="ref" href="../sys/buf.h.html#bufcache_lock" title='bufcache_lock' data-ref="bufcache_lock" data-ref-filename="bufcache_lock">bufcache_lock</a>);</td></tr>
<tr><th id="1063">1063</th><td></td></tr>
<tr><th id="1064">1064</th><td>		<i>/*</i></td></tr>
<tr><th id="1065">1065</th><td><i>		 * drain a pool.</i></td></tr>
<tr><th id="1066">1066</th><td><i>		 */</i></td></tr>
<tr><th id="1067">1067</th><td>		<a class="ref fn" href="../sys/pool.h.html#pool_drain" title='pool_drain' data-ref="pool_drain" data-ref-filename="pool_drain">pool_drain</a>(<a class="macro" href="../sys/null.h.html#13" title="((void *)0)" data-ref="_M/NULL">NULL</a>);</td></tr>
<tr><th id="1068">1068</th><td>	}</td></tr>
<tr><th id="1069">1069</th><td>	<i>/*NOTREACHED*/</i></td></tr>
<tr><th id="1070">1070</th><td>}</td></tr>
<tr><th id="1071">1071</th><td></td></tr>
<tr><th id="1072">1072</th><td><em>static</em> <em>void</em></td></tr>
<tr><th id="1073">1073</th><td><dfn class="tu decl def fn" id="uvmpd_pool_drain_wakeup" title='uvmpd_pool_drain_wakeup' data-type='void uvmpd_pool_drain_wakeup()' data-ref="uvmpd_pool_drain_wakeup" data-ref-filename="uvmpd_pool_drain_wakeup">uvmpd_pool_drain_wakeup</dfn>(<em>void</em>)</td></tr>
<tr><th id="1074">1074</th><td>{</td></tr>
<tr><th id="1075">1075</th><td></td></tr>
<tr><th id="1076">1076</th><td>	<a class="ref fn" href="../sys/mutex.h.html#mutex_enter" title='mutex_enter' data-ref="mutex_enter" data-ref-filename="mutex_enter">mutex_enter</a>(&amp;<a class="tu ref" href="#uvmpd_pool_drain_lock" title='uvmpd_pool_drain_lock' data-use='a' data-ref="uvmpd_pool_drain_lock" data-ref-filename="uvmpd_pool_drain_lock">uvmpd_pool_drain_lock</a>);</td></tr>
<tr><th id="1077">1077</th><td>	<a class="tu ref" href="#uvmpd_pool_drain_run" title='uvmpd_pool_drain_run' data-use='w' data-ref="uvmpd_pool_drain_run" data-ref-filename="uvmpd_pool_drain_run">uvmpd_pool_drain_run</a> = <a class="macro" href="../sys/stdbool.h.html#39" title="1" data-ref="_M/true">true</a>;</td></tr>
<tr><th id="1078">1078</th><td>	<a class="ref fn" href="../sys/condvar.h.html#cv_signal" title='cv_signal' data-ref="cv_signal" data-ref-filename="cv_signal">cv_signal</a>(&amp;<a class="tu ref" href="#uvmpd_pool_drain_cv" title='uvmpd_pool_drain_cv' data-use='a' data-ref="uvmpd_pool_drain_cv" data-ref-filename="uvmpd_pool_drain_cv">uvmpd_pool_drain_cv</a>);</td></tr>
<tr><th id="1079">1079</th><td>	<a class="ref fn" href="../sys/mutex.h.html#mutex_exit" title='mutex_exit' data-ref="mutex_exit" data-ref-filename="mutex_exit">mutex_exit</a>(&amp;<a class="tu ref" href="#uvmpd_pool_drain_lock" title='uvmpd_pool_drain_lock' data-use='a' data-ref="uvmpd_pool_drain_lock" data-ref-filename="uvmpd_pool_drain_lock">uvmpd_pool_drain_lock</a>);</td></tr>
<tr><th id="1080">1080</th><td>}</td></tr>
<tr><th id="1081">1081</th><td></td></tr>
</table><hr/><p id='footer'>
Generated on <em>2019-Jul-19</em> from project netbsd revision <em>f9da89e0d</em><br />Powered by <a href='https://woboq.com'><img alt='Woboq' src='https://code.woboq.org/woboq-16.png' width='41' height='16' /></a> <a href='https://code.woboq.org'>Code Browser</a> 2.1
<br/>Generator usage only permitted with license.</p>
</div></body></html>
